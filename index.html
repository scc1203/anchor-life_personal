<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anchor</title>
    
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=âš“&background=FFC8D1&color=FFFFFF&size=512&length=1&font-size=0.5&rounded=true&bold=true">
    <link rel="icon" href="https://ui-avatars.com/api/?name=âš“&background=FFC8D1&color=FFFFFF&size=512&length=1&font-size=0.5&rounded=true&bold=true">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- Anchor v4.7 (v4.6 ä¿®å¤ç‰ˆ) --- */
        :root {
            --bg-blue: #D4F1F4; --bg-wood: #FDF6E3; --bg-pink: #FFE2E2; --bg-sos: #E8DFF5;
            --bg-setting: #F0F4F8; --text-main: #5D5C61; --gold: #D4AF37;
            --sport-green: #B5EAD7; --cycle-purple: #C7CEEA; --frog-green: #9CCC65;
            --flash-yellow: #FFD54F; --danger-red: #ff6b6b; --footprint-grey: #90A4AE;
        }

        body { font-family: "PingFang SC", sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: var(--text-main); display: flex; justify-content: center; min-height: 100vh; overscroll-behavior-y: none; }
        .container { width: 100%; max-width: 450px; background-color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; min-height: 100vh; }
        
        /* Header */
        .header { padding: 15px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-top: max(15px, env(safe-area-inset-top)); }
        .app-title { font-weight: bold; font-size: 1.1rem; color: #444; }
        .version-badge { background: #81C784; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .btn-icon { cursor: pointer; font-size: 1.2rem; opacity: 0.6; }

        /* Stats */
        .stats-bar { display: flex; justify-content: space-around; padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .stat-btn { flex: 1; margin: 0 5px; padding: 8px; border-radius: 12px; cursor: pointer; background: #fafafa; border: 1px solid #eee; text-align: center; transition: all 0.1s; }
        .stat-btn:active { transform: scale(0.96); background: #f0f0f0; }
        .stat-label { font-size: 0.8rem; color: #666; margin-right: 5px; }
        .stat-count { font-weight: bold; font-size: 1rem; color: #333; font-family: monospace; }
        .stat-btn.willpower { color: #5C6BC0; } .stat-btn.joy { color: #FFA726; }

        /* Filter */
        .section-filter { background-color: var(--bg-blue); padding: 20px; text-align: center; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; z-index: 10; }
        .mode-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .mode-tab { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; background: rgba(255,255,255,0.5); transition: all 0.2s; }
        .mode-tab.active { background: #fff; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .control-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        select { padding: 8px 12px; border: none; border-radius: 10px; background: rgba(255,255,255,0.9); font-size: 16px; }
        .btn-main { background-color: #FF9AA2; color: white; font-weight: bold; font-size: 1.1rem; padding: 12px 40px; border: none; border-radius: 30px; box-shadow: 0 4px 12px rgba(255, 154, 162, 0.4); cursor: pointer; }
        .btn-main:active { transform: scale(0.95); }

        /* Display */
        .section-display { flex-grow: 1; background-color: var(--bg-pink); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; min-height: 220px; }
        .card { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; box-shadow: 0 10px 30px rgba(0,0,0,0.06); display: none; animation: popUp 0.3s ease-out forwards; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .card-icon { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .card-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; color: #333; }
        .card-desc { font-size: 0.9rem; color: #777; line-height: 1.6; margin-bottom: 15px; }
        .card-time { display: inline-block; background: #f0f0f0; color: #888; padding: 2px 8px; border-radius: 8px; font-size: 0.75rem; margin-top: 5px; }
        .card-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px; color: #fff; }
        .bg-cycle { background: var(--cycle-purple); } .bg-frog { background: var(--frog-green); } .bg-flash { background: var(--flash-yellow); color: #555; }
        .btn-card-action { background: #f0f0f0; padding: 8px 18px; border-radius: 15px; font-size: 0.85rem; border: none; cursor: pointer; color: #555; margin: 0 5px; }

        /* Input */
        .section-input { background-color: var(--bg-wood); padding: 20px; }
        .input-box { background: #fff; padding: 5px; border-radius: 15px; display: flex; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        textarea#inpTitle { border: none; padding: 10px; flex: 1; border-radius: 10px; outline: none; font-size: 16px; font-family: inherit; resize: none; height: 24px; line-height: 24px; }
        .btn-add { background: #B5EAD7; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; color: #555; cursor: pointer; }
        .input-options { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .tags-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; background: rgba(0,0,0,0.05); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .tag.active { background: #C7CEEA; border-color: #989ec2; color: #333; } .tag[data-v="sport"].active { background: var(--sport-green); border-color: #99cbb9; }
        
        /* ğŸŸ¢ æ–°å¢ï¼šå¼€å…³æŒ‰é’®æ ·å¼ */
        .switch-container { display: flex; gap: 8px; }
        .switch-btn { font-size: 0.75rem; color: #666; display: flex; align-items: center; gap: 5px; cursor: pointer; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 10px; border: 1px solid transparent; transition: all 0.2s; }
        .switch-btn.active-cycle { background: var(--cycle-purple); color: #fff; font-weight: bold; }
        .switch-btn.active-flash { background: var(--flash-yellow); color: #555; font-weight: bold; }
        
        .time-select-small { font-size: 16px; padding: 4px; border-radius: 8px; border: 1px solid #ddd; color: #666; }

        /* Lists: ğŸ”´ ä¿®å¤ç‚¹ï¼šæ”¹ä¸º block/none åˆ‡æ¢ */
        .section-list { background-color: #fff; padding: 20px; }
        .list-section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; cursor: pointer; margin-top: 10px; }
        .list-title { font-size: 0.95rem; font-weight: bold; color: #555; }
        
        /* é»˜è®¤éšè— */
        .task-list { list-style: none; padding: 0; margin: 0; display: none; }
        /* æ¿€æ´»æ˜¾ç¤º */
        .task-list.open { display: block; }
        
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #f9f9f9; }
        .task-status-done { opacity: 0.4; text-decoration: line-through; }
        .list-badge { font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; margin-left: 5px; border: 1px solid #eee; color: #888;}
        .lb-frog { color: var(--frog-green); border-color: var(--frog-green); font-weight:bold; } .lb-flash { color: #FBC02D; border-color: #FBC02D; }
        .footprint-time { font-size: 0.7rem; color: #aaa; margin-right: 10px; font-family: monospace;} .footprint-item { color: #666; font-size: 0.85rem; }
        .archive-section { margin-top: 20px; border-top: 4px solid #f0f2f5; padding-top: 15px; }

        /* Settings */
        .section-settings { background-color: var(--bg-setting); padding: 20px; border-top: 1px solid #eee; padding-bottom: 80px;}
        .settings-title { font-size: 0.9rem; font-weight: bold; color: #666; margin-bottom: 10px; }
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:10px;}
        .btn-outline { background: #fff; border: 1px solid #bbb; color: #555; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .btn-file { background: #e1eefd; border: 1px solid #bbd4f0; color: #1565C0; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        textarea { width: 100%; height: 80px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color:#555; padding: 8px; font-family: monospace; }
        .btn-danger { width: 100%; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; color: #c62828; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 0.8rem; }

        /* Manual (ä¿æŒå®Œæ•´) */
        .section-manual { background-color: #fff; padding: 20px; border-top: 1px solid #eee; color: #666; font-size: 0.9rem; line-height: 1.6; }
        details { background: #f9f9f9; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        summary { padding: 15px; font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; color: #444; }
        .manual-content { padding: 0 15px 20px 15px; border-top: 1px solid #eee; font-size: 0.85rem; }
        .manual-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 0 2px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><span class="app-title">Anchor âš“ï¸</span><span class="version-badge">v4.7</span></div>
        <span class="btn-icon" onclick="scrollToSettings()">âš™ï¸</span>
    </div>

    <div class="stats-bar">
        <div class="stat-btn willpower" onclick="incrementStat('willpower')">
            <span class="stat-label">ğŸ›¡ï¸ æ„å¿—åŠ›</span><span class="stat-count" id="stat-willpower">0</span>
        </div>
        <div class="stat-btn joy" onclick="incrementStat('joy')">
            <span class="stat-label">âœ¨ å°ç¡®å¹¸</span><span class="stat-count" id="stat-joy">0</span>
        </div>
    </div>

    <div class="section-filter" id="filterSec">
        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('normal')">ğŸ”® æ··åˆ/å…¨åŸŸ</div>
            <div class="mode-tab" onclick="setMode('culture')">ğŸ“š åªçœ‹ä¹¦å½±</div>
            <div class="mode-tab" onclick="setMode('vinyl')">ğŸµ åªå¬å”±ç‰‡</div>
            <div class="mode-tab" onclick="setMode('sos')" style="color:#d9534f">ğŸ†˜ SOS</div>
        </div>
        <div id="controls-normal" class="control-group">
            <select id="selContext"><option value="desktop">ğŸ’» ä¹¦æ¡Œå‰</option><option value="indoor">ğŸ  å®¤å†…/å®¶</option><option value="outdoor">ğŸŒ³ æˆ·å¤–</option></select>
            <select id="selTime"><option value="30">â³ æœ‰30åˆ†é’Ÿ</option><option value="60">â³ æœ‰1å°æ—¶</option><option value="120">â³ æœ‰2å°æ—¶+</option></select>
        </div>
        <div id="controls-sos" class="control-group" style="display:none; color: #555; font-size:0.9rem;"><span>ğŸƒ å…è®¸è‡ªå·±æš‚æ—¶åœä¸‹æ¥...</span></div>
        <button class="btn-main" onclick="draw()" id="mainBtn">æŠ½å–ä»»åŠ¡</button>
    </div>

    <div class="section-display" id="displaySec">
        <div id="placeholder" style="color:#aaa; font-weight:bold; opacity:0.5;">...</div>
        <div id="resultCard" class="card">
            <span class="card-icon" id="rIcon">ğŸ</span>
            <div class="card-title"><span id="rTitle"></span><span id="rBadge"></span></div>
            <div class="card-desc" id="rDesc"></div>
            <div class="card-time" id="rTime"></div> 
            <div style="margin-top:15px;">
                <button class="btn-card-action" onclick="draw()">æ¢ä¸€ä¸ª</button>
                <button class="btn-card-action" onclick="finishTask()" id="btnFinish">å»å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div class="section-input">
        <div class="input-box">
            <textarea id="inpTitle" rows="1" placeholder="è¾“å…¥äº‹é¡¹... (*å¼€å¤´æ ‡è®°é‡è¦/é’è›™)" oninput="autoTag()" onkeypress="handleEnter(event)"></textarea>
            <button class="btn-add" onclick="addNew()">ï¼‹</button>
        </div>
        <div class="input-options">
            <div class="tags-row">
                <div class="tag active" data-v="indoor" onclick="pickTag(this)">ğŸ  å®¤å†…</div>
                <div class="tag" data-v="desktop" onclick="pickTag(this)">ğŸ’» æ¡Œå‰</div>
                <div class="tag" data-v="outdoor" onclick="pickTag(this)">ğŸŒ³ æˆ·å¤–</div>
                <div class="tag" data-v="sport" onclick="pickTag(this)">ğŸƒ è¿åŠ¨</div>
                <div class="tag" data-v="culture" onclick="pickTag(this)">ğŸ“š ä¹¦/å½±</div>
                <div class="tag" data-v="vinyl" onclick="pickTag(this)">ğŸµ å¬ç¢Ÿ</div>
            </div>
        </div>
        <div class="input-options" style="margin-top:8px;">
            <div class="switch-container">
                <div class="switch-btn" id="cycleSwitch" onclick="toggleSwitch('cycle')"><span>ğŸ”„ æ¯æ—¥å¾ªç¯</span></div>
                <div class="switch-btn" id="flashSwitch" onclick="toggleSwitch('flash')"><span>âš¡ï¸ é€ŸåŠæ¨¡å¼</span></div>
            </div>
            <select id="inpTime" class="time-select-small">
                <option value="5">5m (é€ŸåŠ)</option>
                <option value="15">15m</option>
                <option value="30" selected>30m</option>
                <option value="60">1h</option>
                <option value="120">2h+</option>
            </select>
        </div>
        <div id="timeFeedback" style="font-size:0.7rem; color:#75B79E; margin-top:5px; margin-left:5px; height:1rem;"></div>
    </div>

    <div class="section-list">
        <div class="list-section-header" onclick="toggleList('dailyList')"><span class="list-title">ğŸ“‹ æ—¥å¸¸ & è¿åŠ¨ (<span id="dailyCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="dailyList" class="task-list open"></ul>
        
        <div class="list-section-header" onclick="toggleList('mediaList')"><span class="list-title">ğŸ¬ åª’ä½“åº“æˆ¿ (<span id="mediaCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="mediaList" class="task-list"></ul>

        <div class="list-section-header" onclick="toggleList('logList')"><span class="list-title" style="color:var(--footprint-grey)">ğŸ‘£ ä»Šæ—¥è¶³è¿¹ (<span id="logCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="logList" class="task-list"></ul>

        <div class="archive-section">
            <div class="list-section-header" onclick="toggleList('archiveList')"><span class="list-title" style="color:var(--gold)">ğŸ† è£èª‰æ®¿å ‚ (<span id="arcCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
            <div id="archiveList" class="task-list"></div>
        </div>
    </div>

    <div class="section-manual">
        <details>
            <summary>ğŸ“– ç”¨æˆ·æ‰‹å†Œ & é€»è¾‘è¯å…¸</summary>
            <div class="manual-content">
                <p><b>æ™ºèƒ½è¾“å…¥ï¼š</b>è¾“å…¥ <b>æ¯å¤©/æ¯æ—¥</b> å¼€å¯å¾ªç¯ï¼›è¾“å…¥ <b>æ´—/åˆ·/ç†/æ‹†</b> å¼€å¯é€ŸåŠï¼›è¾“å…¥ <b>*</b> æ ‡è®°é’è›™ã€‚</p>
                <p><b>æ•°æ®å®‰å…¨ï¼š</b> è¯·å®šæœŸä½¿ç”¨ä¸‹æ–¹â€œå¯¼å‡ºæ–‡ä»¶â€å¤‡ä»½ã€‚</p>
            </div>
        </details>
    </div>

    <div class="section-settings" id="settingSec">
        <div class="settings-title">ğŸ“¡ æ•°æ®æ–¹èˆŸ (v4.7)</div>
        <div class="backup-grid">
            <button class="btn-file" onclick="exportToFile()">ğŸ“¥ å¯¼å‡ºæ–‡ä»¶</button>
            <button class="btn-file" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ–‡ä»¶</button>
        </div>
        <div class="backup-grid">
            <button class="btn-outline" onclick="copyToClip()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬ç </button>
            <button class="btn-outline" onclick="document.getElementById('dataArea').value=''">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <textarea id="dataArea" placeholder="è¯·åœ¨æ­¤ç²˜è´´æ•°æ®..."></textarea>
        <button class="btn-file" style="width:100%; background:#E8F5E9; color:#2E7D32;" onclick="executeImport()">âœ… ç¡®è®¤å¯¼å…¥</button>
        <button class="btn-danger" onclick="tryResetAll()">ğŸ—‘ï¸ æ ¼å¼åŒ–é‡ç½®</button>
        <input type="file" id="fileInput" style="display:none" onchange="importFromFile(this)">
    </div>
</div>

<script>
    // --- ğŸ” æ ¸å¿ƒå‡½æ•° (å‰ç½®å®šä¹‰ï¼Œé˜²æ­¢æŠ¥é”™) ---
    const KEY_DB = 'anchor_live_db';
    const KEY_ARCHIVE = 'anchor_live_archive';
    const KEY_LOG = 'anchor_live_log';
    const KEY_STATS = 'anchor_live_stats';
    const KEY_VISITED = 'anchor_has_visited';

    // é»˜è®¤æ•°æ®
    let db = JSON.parse(localStorage.getItem(KEY_DB)) || [];
    let archive = JSON.parse(localStorage.getItem(KEY_ARCHIVE)) || [];
    let dailyLog = JSON.parse(localStorage.getItem(KEY_LOG)) || [];
    let userStats = JSON.parse(localStorage.getItem(KEY_STATS)) || { willpower: 0, joy: 0 };
    let recentHistory = []; 
    let mode = 'normal';
    let currentTask = null;
    let switchState = { cycle: false, flash: false };

    const sosLibrary = [{ title: "å¤§å£å–æ°´", icon: "ğŸ’§" }, { title: "çœ‹çª—å¤–è¿œæ–¹", icon: "ğŸ‘€" }, { title: "4-7-8 å‘¼å¸", icon: "ğŸŒ¬ï¸" }, { title: "å‹è…¿æ‹‰ä¼¸", icon: "ğŸ¦µ" }, { title: "äº”æ„Ÿç€é™†", icon: "ğŸ–ï¸" }, { title: "æ´—æŠŠè„¸", icon: "ğŸš¿" }, { title: "åƒä¸€é¢—æ°´æœ", icon: "ğŸŠ" }];

    function save() {
        localStorage.setItem(KEY_DB, JSON.stringify(db));
        localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
        localStorage.setItem(KEY_LOG, JSON.stringify(dailyLog));
        localStorage.setItem(KEY_STATS, JSON.stringify(userStats));
    }

    // ğŸ”´ ä¿®å¤ï¼šUIæ¸²æŸ“å‡½æ•° (å‰ç½®)
    function renderList() {
        const dailyList = document.getElementById('dailyList');
        const mediaList = document.getElementById('mediaList');
        if(!dailyList || !mediaList) return; 
        dailyList.innerHTML = ""; mediaList.innerHTML = "";
        let dCount = 0, mCount = 0;
        const todayStr = new Date().toDateString();
        const sortedDB = [...db].sort((a,b) => b.id - a.id);

        sortedDB.forEach(item => {
            const li = document.createElement('li');
            li.className = 'task-item';
            const isDoneToday = (item.recurrence === 'daily' && item.lastDone === todayStr);
            if (isDoneToday) li.classList.add('task-status-done');

            const seriesBadge = item.isSeries ? `<span class="list-badge">âˆç³»åˆ—</span>` : '';
            const cycleBadge = item.recurrence === 'daily' ? `<span class="list-badge">ğŸ”„</span>` : '';
            
            let extraBadges = "";
            if(item.isFrog) extraBadges += `<span class="list-badge lb-frog">ğŸ¸</span>`;
            if(item.isQuick) extraBadges += `<span class="list-badge lb-flash">âš¡ï¸</span>`;

            let tDisplay = item.time === 0 ? `<span style="font-size:0.7rem;color:#ccc;">ä»»æ„</span>` : `<span style="font-size:0.7rem;color:#ccc;">${item.time}m</span>`;

            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:5px;">
                    <span style="width:20px;text-align:center;">${getSmartIcon(item)}</span>
                    <span style="font-size:0.9rem;color:#555;">${item.title}</span>
                    ${seriesBadge}${cycleBadge}${extraBadges}${tDisplay}
                </div>
                <div class="task-del" onclick="tryDeleteItem(${item.id})">ğŸ—‘ï¸</div>
            `;

            if (item.type === 'culture' || item.type === 'vinyl') { mediaList.appendChild(li); mCount++; } 
            else { dailyList.appendChild(li); dCount++; }
        });
        document.getElementById('dailyCount').innerText = dCount;
        document.getElementById('mediaCount').innerText = mCount;
    }

    function renderArchive() {
        const list = document.getElementById('archiveList');
        if(!list) return;
        list.innerHTML = "";
        document.getElementById('arcCount').innerText = archive.length;
        archive.forEach(item => {
            const div = document.createElement('div');
            div.className = 'archive-item';
            div.innerHTML = `<span class="archive-date">[${item.finishDate}]</span><span>${item.title}</span>`;
            list.appendChild(div);
        });
    }

    function renderLog() {
        const list = document.getElementById('logList');
        if(!list) return;
        list.innerHTML = "";
        document.getElementById('logCount').innerText = dailyLog.length;
        dailyLog.forEach(log => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `<div style="display:flex;align-items:center;"><span class="footprint-time">${log.timeStr}</span><span class="footprint-item">${log.icon} ${log.title}</span></div>`;
            list.appendChild(li);
        });
    }
    
    function updateStatsUI() {
        document.getElementById('stat-willpower').innerText = userStats.willpower;
        document.getElementById('stat-joy').innerText = userStats.joy;
    }

    // --- ğŸ”´ ä¿®å¤ï¼šåˆ—è¡¨åˆ‡æ¢ (Display Block/None) ---
    function toggleList(id) { 
        const el = document.getElementById(id); 
        if (el.style.display === 'block') {
            el.style.display = 'none';
            el.classList.remove('open');
        } else {
            el.style.display = 'block';
            el.classList.add('open');
        }
    }

    // --- å…¶ä»–è¾…åŠ© ---
    function fixLegacyData() {
        db.forEach(item => {
            if (item.time === undefined) item.time = 30;
            if (item.recurrence === undefined) item.recurrence = 'none';
            if (item.desc === "è‡ªå®šä¹‰") item.desc = "";
            if (item.isFrog === undefined) item.isFrog = false;
            if (item.isQuick === undefined) item.isQuick = false;
        });
        save();
    }

    function checkLogExpiry() {
        const today = new Date().toDateString();
        const validLogs = dailyLog.filter(log => log.date === today);
        if (validLogs.length !== dailyLog.length) { dailyLog = validLogs; save(); }
    }

    function getSmartIcon(item) {
        if (item.subtype === 'book') return 'ğŸ“š';
        if (item.subtype === 'movie') return 'ğŸ¬';
        return getIcon(item.type);
    }
    function getIcon(t) { const map = { 'indoor':'ğŸ ', 'desktop':'ğŸ’»', 'outdoor':'ğŸŒ³', 'sport':'ğŸƒ', 'culture':'ğŸ¬', 'vinyl':'ğŸµ', 'sos':'ğŸš‘' }; return map[t] || 'âœ¨'; }
    function getDescByType(t) { if(t==='vinyl') return "äº«å—æ—¶å…‰"; if(t==='culture') return "æ²‰æµ¸æ•…äº‹"; if(t==='sport') return "åŠ¨èµ·æ¥ï¼"; return "è¡ŒåŠ¨å§"; }
    
    // --- äº¤äº’ ---
    function toggleSwitch(type, forceState) {
        const newState = (forceState !== undefined) ? forceState : !switchState[type];
        switchState[type] = newState;
        const sw = document.getElementById(type + 'Switch');
        const activeClass = (type === 'cycle') ? 'active-cycle' : 'active-flash';
        if (newState) sw.classList.add(activeClass); else sw.classList.remove(activeClass);
    }
    function toggleCycle() { toggleSwitch('cycle'); }

    function autoTag() {
        const raw = document.getElementById('inpTitle').value;
        const lines = raw.split('\n'); let targetLine = lines[0] || ""; 
        const parsed = parseTimeFromInput(targetLine);
        const feedback = document.getElementById('timeFeedback');
        if (parsed.time) feedback.innerText = `ğŸ’¡ è¯†åˆ«: ${parsed.time} min`; else feedback.innerText = "";

        // Cycle
        if ((targetLine.includes("æ¯å¤©") || targetLine.includes("æ¯æ—¥")) && !switchState.cycle) {
            toggleSwitch('cycle', true);
        }

        const v = targetLine; const tags = document.querySelectorAll('.tag');
        let t = null; let detectQuick = false;
        if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) { t = 'indoor'; detectQuick = true; } 
        else if(v.includes('å”±') || v.includes('å¬')) t = 'vinyl'; 
        else if(v.includes('ä¹¦') || v.includes('å½±') || v.includes('è¯»') || v.includes('çœ‹') || v.includes('æ‚å¿—')) t = 'culture'; 
        else if(v.includes('åŠ¨') || v.includes('è·‘') || v.includes('ç»ƒ') || v.includes('è·³') || v.includes('çƒ') || v.includes('èˆ') || v.includes('æ“')) t = 'sport'; 
        else if(v.includes('ä¹°') || v.includes('å¤–') || v.includes('å–') || v.includes('æ‹¿')) t = 'outdoor'; 
        else if(v.includes('è„‘') || v.includes('å†™') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) t = 'desktop';
        if (t) { tags.forEach(tag => tag.classList.remove('active')); document.querySelector(`.tag[data-v="${t}"]`).classList.add('active'); toggleTimeInput(t); }
        
        // Flash Switch Auto
        if (detectQuick && !switchState.flash) { toggleSwitch('flash', true); document.getElementById('inpTime').value = "5"; }
    }
    
    function pickTag(el) { document.querySelectorAll('.tag').forEach(t => t.classList.remove('active')); el.classList.add('active'); toggleTimeInput(el.dataset.v); }
    function toggleTimeInput(type) { const sel = document.getElementById('inpTime'); if (type === 'vinyl' || type === 'culture') sel.classList.add('disabled'); else sel.classList.remove('disabled'); }

    function parseTimeFromInput(str) {
        let detectedTime = null; let cleanStr = str;
        const regexH = /(\d+(?:\.\d+)?)\s*(h|hr|hour|hours|å°æ—¶)/i; let matchH = str.match(regexH);
        if (matchH) { detectedTime = parseFloat(matchH[1]) * 60; cleanStr = cleanStr.replace(matchH[0], '').trim(); }
        if (!detectedTime) { const regexM = /(\d+)\s*(m|min|mins|åˆ†|åˆ†é’Ÿ)/i; let matchM = str.match(regexM); if (matchM) { detectedTime = parseInt(matchM[1]); cleanStr = cleanStr.replace(matchM[0], '').trim(); } }
        return { time: detectedTime, title: cleanStr };
    }

    function addNew() {
        const rawInput = document.getElementById('inpTitle').value; if(!rawInput || rawInput.trim() === "") return;
        let lines = rawInput.split('\n').filter(line => line.trim() !== ""); const type = document.querySelector('.tag.active').dataset.v; 
        let batchSubtype = ''; 

        // Header check
        if (lines.length > 0) {
            const first = lines[0].toLowerCase();
            const isCleaning = /(ç†|æ•´ç†|æ”¶æ‹¾|æ“¦|æ‰«|æ‹–|æ´—|æ¢|å |é“º|æŒ‚|æ‰”|æ‹†|è£…|å–)/.test(first);
            if (!isCleaning) {
                if (['çœ‹', 'å½±', 'è§†', 'å‰§', 'ç‰‡', 'movie'].some(k => first.includes(k))) batchSubtype = 'movie';
                else if (['è¯»', 'ä¹¦', 'é˜…', 'book', 'read', 'æ‚å¿—'].some(k => first.includes(k))) batchSubtype = 'book';
                if (batchSubtype && first.length <= 4) lines.shift();
            }
        }

        lines.forEach(line => {
            const parsed = parseTimeFromInput(line); let title = parsed.title; let timeVal = parsed.time; let subtype = batchSubtype;
            let isFrog = false; if (title.startsWith('*')) { isFrog = true; title = title.substring(1).trim(); }
            
            // Manual + Auto Quick
            let isQuick = switchState.flash; 
            if (!isQuick) {
                if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(title)) isQuick = true;
                if (timeVal && timeVal <= 5) isQuick = true;
            }

            if (!timeVal) {
                timeVal = parseInt(document.getElementById('inpTime').value);
                if (type === 'vinyl' && !isQuick) timeVal = 0;
                else if (type === 'culture' && !isQuick) { if (subtype === 'movie') timeVal = 120; else timeVal = 0; }
            }
            if (isQuick && (!timeVal || timeVal > 15)) timeVal = 5;
            if (!isQuick && !subtype && type === 'culture') {
                if (title.includes('å½±')||title.includes('è§†')) subtype = 'movie'; else subtype = 'book';
            }
            title = title.replace(/^(å»|çœ‹|è¯»|å¬|å†™|åš)\s*/, '').trim();
            if (!isQuick && (type === 'culture' || type === 'vinyl')) { if (!title.startsWith('ã€Š')) title = `ã€Š${title}ã€‹`; }
            
            let isSeries = false; if (type === 'culture' && (title.includes('æ‚å¿—') || title.includes('å‘¨åˆŠ'))) isSeries = true;
            
            let recurrence = switchState.cycle ? 'daily' : 'none';
            if (recurrence === 'none' && (title.includes('æ¯å¤©') || title.includes('æ¯æ—¥'))) recurrence = 'daily';
            if (recurrence === 'daily') title = title.replace(/æ¯å¤©|æ¯æ—¥/g, '').trim();

            db.push({ id: Date.now() + Math.floor(Math.random()*10000), title, type, subtype, desc: isSeries?"ç³»åˆ—":(recurrence==='daily'?"æ¯æ—¥":""), isSeries, time: timeVal, recurrence, isFrog, isQuick, lastDone: '' });
        });
        save(); renderList(); 
        const input = document.getElementById('inpTitle'); input.value = ''; input.placeholder = "âœ… å­˜å…¥æˆåŠŸï¼";
        if(switchState.cycle) toggleSwitch('cycle', false); if(switchState.flash) toggleSwitch('flash', false);
        setTimeout(() => input.placeholder = "è¾“å…¥äº‹é¡¹...", 1500);
    }

    function draw() {
        const card = document.getElementById('resultCard'); card.style.display = 'none';
        setTimeout(() => {
            let result = null;
            if (mode === 'sos') { const r = Math.floor(Math.random() * sosLibrary.length); result = { ...sosLibrary[r], type: 'sos', time: 0 }; }
            else {
                const ctx = document.getElementById('selContext').value; const limitTime = parseInt(document.getElementById('selTime').value); const todayStr = new Date().toDateString();
                let validPool = db.filter(item => {
                    if (item.recurrence === 'daily' && item.lastDone === todayStr) return false;
                    const tTime = (item.time === undefined || item.time === null) ? 30 : item.time;
                    const isFlexible = (tTime === 0);
                    if (!isFlexible && !item.isQuick && tTime > limitTime) return false;
                    if (mode === 'vinyl') return item.type === 'vinyl'; if (mode === 'culture') return item.type === 'culture';
                    if (item.type === 'culture' || item.type === 'vinyl') { if (ctx === 'outdoor') return false; } 
                    else if (item.type === 'sport') { return true; } 
                    else { if (ctx === 'desktop') return item.type !== 'outdoor'; if (ctx === 'indoor') return item.type === 'indoor'; if (ctx === 'outdoor') return item.type === 'outdoor'; }
                    return true;
                });
                if (validPool.length > 0) {
                    let nonRecent = validPool.filter(i => !recentHistory.includes(i.id));
                    let pool = nonRecent.length > 0 ? nonRecent : validPool;
                    result = pool[Math.floor(Math.random() * pool.length)];
                }
            }
            if(result && result.type !== 'sos') { recentHistory.push(result.id); if(recentHistory.length > 2) recentHistory.shift(); }
            currentTask = result;
            if (result) {
                document.getElementById('rTitle').innerText = result.title;
                let badgesHtml = "";
                if (result.isFrog) badgesHtml += `<span class='card-badge bg-frog'>ğŸ¸ é’è›™</span>`;
                if (result.isQuick) badgesHtml += `<span class='card-badge bg-flash'>âš¡ï¸ é€ŸåŠ</span>`;
                if (result.recurrence === 'daily') badgesHtml += `<span class='card-badge bg-cycle'>ğŸ”„ æ¯æ—¥</span>`;
                document.getElementById('rBadge').innerHTML = badgesHtml;
                let displayDesc = result.desc; if (!displayDesc) displayDesc = getDescByType(result.type);
                document.getElementById('rDesc').innerText = displayDesc;
                document.getElementById('rIcon').innerText = result.icon || getSmartIcon(result);
                let timeStr = (result.type === 'sos') ? "âš¡ï¸ å³æ—¶" : (result.time === 0 ? "â³ ä¸°ä¿­ç”±äºº" : `â±ï¸ ${result.time} min`);
                document.getElementById('rTime').innerText = timeStr;
            } else {
                currentTask = null; document.getElementById('rTitle').innerText = "æš‚æ— ä»»åŠ¡"; document.getElementById('rBadge').innerHTML = ""; document.getElementById('rDesc').innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ"; document.getElementById('rIcon').innerText = "ğŸŒ™"; document.getElementById('rTime').innerText = "";
            }
            card.style.display = 'block';
        }, 300);
    }

    function finishTask() {
        if (!currentTask) return;
        if (currentTask.type === 'sos') { alert("çŠ¶æ€é‡å¯ï¼ğŸŒ±"); document.getElementById('resultCard').style.display = 'none'; return; }
        
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        dailyLog.unshift({ title: currentTask.title, icon: currentTask.icon || getSmartIcon(currentTask), timeStr: timeStr, date: now.toDateString() });
        
        if (currentTask.recurrence === 'daily') {
            const taskIndex = db.findIndex(t => t.id === currentTask.id);
            if (taskIndex > -1) db[taskIndex].lastDone = new Date().toDateString();
            recordLog(); save(); renderList(); alert("âœ… æ‰“å¡æˆåŠŸï¼");
        } else if (currentTask.type === 'culture' && !currentTask.isSeries) {
            if(confirm(`ã€Š${currentTask.title}ã€‹çœ‹å®Œå½’æ¡£ï¼Ÿ`)) {
                db = db.filter(i => i.id !== currentTask.id);
                archive.unshift({ ...currentTask, finishDate: new Date().toLocaleDateString() });
                save(); renderList(); renderArchive(); alert("ğŸ† å·²å½’æ¡£");
            }
        } else {
            db = db.filter(i => i.id !== currentTask.id); recordLog(); save(); renderList(); alert("âœ¨ å®Œæˆï¼");
        }
        document.getElementById('resultCard').style.display = 'none';
    }

    // --- å¯¼å…¥å¯¼å‡º (ä¿®å¤ç‰ˆ) ---
    function executeImport() {
        const str = document.getElementById('dataArea').value;
        if (!str || str.trim().length === 0) return alert("âš ï¸ è¯·å…ˆç²˜è´´ä»£ç ï¼");
        try {
            const json = JSON.parse(str);
            let incomingDB = json.db || (Array.isArray(json) ? json : []);
            let incomingArchive = json.archive || [];
            let incomingStats = json.userStats || {};
            if (!Array.isArray(incomingDB)) throw new Error("æ ¼å¼é”™è¯¯");
            if(confirm(`ğŸ“¡ æ‰¾åˆ° ${incomingDB.length} ä¸ªä»»åŠ¡ã€‚\nç¡®å®šåˆå¹¶å—ï¼Ÿ`)) {
                 let addCount = 0;
                 incomingDB.forEach(newItem => {
                    const exists = db.some(e => e.title === newItem.title && e.type === newItem.type);
                    if (!exists) { newItem.id = Date.now() + Math.floor(Math.random()*10000); if (newItem.time === undefined) newItem.time = 30; db.push(newItem); addCount++; }
                 });
                 incomingArchive.forEach(newArc => { const arcExists = archive.some(a => a.title === newArc.title); if(!arcExists) archive.unshift(newArc); });
                 if (incomingStats.willpower) userStats.willpower = Math.max(userStats.willpower, incomingStats.willpower);
                 if (incomingStats.joy) userStats.joy = Math.max(userStats.joy, incomingStats.joy);
                 save(); renderList(); renderArchive(); updateStatsUI();
                 alert(`âœ… æˆåŠŸåˆå¹¶ ${addCount} ä¸ªæ–°ä»»åŠ¡ï¼`);
            }
        } catch(e) { alert(`âŒ å¯¼å…¥å¤±è´¥ï¼š${e.message}`); }
    }
    function triggerImport() { document.getElementById('fileInput').click(); }
    function importFromFile(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { document.getElementById('dataArea').value = e.target.result; executeImport(); }; reader.readAsText(file); }
    function exportToFile() { const allData = { db, archive, dailyLog, userStats }; const blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "anchor_backup_" + new Date().toISOString().slice(0,10) + ".json"; a.click(); }
    function copyToClip() { const str = JSON.stringify({ db, archive, dailyLog, userStats }); if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(str).then(()=> alert("âœ… å·²å¤åˆ¶")).catch(()=>{ document.getElementById('dataArea').value=str; alert("âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); }); } else { document.getElementById('dataArea').value=str; alert("âš ï¸ è¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); } }
    function tryDeleteItem(id) { if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) { db = db.filter(item => item.id !== id); save(); renderList(); alert("ğŸ—‘ï¸ å·²åˆ é™¤"); } }
    function tryResetAll() { if(confirm("âš ï¸ ç¡®å®šæ¸…ç©ºï¼Ÿ")) { db=[]; archive=[]; dailyLog=[]; userStats={willpower:0,joy:0}; save(); init(); alert("å·²æ ¼å¼åŒ–"); } }
    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNew(); } }

    // åˆå§‹åŒ–
    window.onload = function() {
        if(db.length === 0 && archive.length === 0) db = defaultDB;
        checkLogExpiry();
        renderList(); renderArchive(); renderLog(); updateStatsUI(); 
        setMode('normal');
    };
</script>
</body>
</html>
