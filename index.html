<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anchor</title>
    
    <!-- å›¾æ ‡ï¼šç»§ç»­ä½¿ç”¨ä½  GitHub æ ¹ç›®å½•é‡Œçš„ png æ–‡ä»¶ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- ğŸ¨ Anchor v5.1 --- */
        :root {
            --bg-blue: #D4F1F4; /* æ›´åé©¬å¡é¾™çš„æµ…å¤©è“ï¼Œä¸ç²‰è‰²æ­é…æ›´æŸ”å’Œ */
            --bg-wood: #FDF6E3;
            --bg-pink: #FFE2E2; /* æ›´æŸ”å’Œçš„ç²‰è‰²ï¼Œé€‚åˆä½œä¸ºå¤§é¢ç§¯èƒŒæ™¯ */
            --bg-sos:  #E8DFF5;
            --bg-setting: #F0F4F8;
            --bg-footer: #F8F3FF; /* 04åŒºï¼šæ›´æ·¡çš„è–°è¡£è‰é©¬å¡é¾™èƒŒæ™¯ï¼Œå‡å¼±å­˜åœ¨æ„Ÿ */
            --text-main: #5D5C61;
            --gold: #D4AF37;
            --sport-green: #B5EAD7;
            --cycle-purple: #C7CEEA;
            --frog-green: #9CCC65;
            --flash-yellow: #FFD54F;
            --danger-red: #ff6b6b;
            --footprint-grey: #90A4AE;
            --panel-soft: #F7FAFF; /* æ›´æµ…ä¸€ç‚¹çš„ç°è“åº•è‰² */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0; background-color: #f0f2f5;
            color: var(--text-main); display: flex; justify-content: center;
            min-height: 100vh;
            overscroll-behavior-y: none; 
        }

        .container {
            width: 100%; max-width: 450px; background-color: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            position: relative;
            min-height: 100vh;
        }

        .header {
            padding: 15px 20px; background: #fff; display: flex;
            justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .app-title { font-weight: bold; font-size: 1.1rem; color: #444; }
        .version-badge { background: #81C784; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .btn-icon { cursor: pointer; font-size: 1.2rem; opacity: 0.6; }

        /* å¿µå¤´è®¡æ•°å™¨ */
        .stats-bar {
            display: flex; justify-content: space-around; padding: 10px 15px; background: #fff;
            border-bottom: 1px solid #eee;
        }
        .stat-btn {
    flex: 1;
    margin: 0 5px;
    padding: 8px;
    border-radius: 14px;
    cursor: pointer;
    text-align: center;
    transition: all 0.1s;
    user-select: none;
    border: 1px solid rgba(0,0,0,0.03);
}

.stat-btn.willpower {
    background: #F3FBF7;  /* è–„è·ç»¿ */
    color: #2E7D32;
}

.stat-btn.joy {
    background: #FFF5EB;  /* å¥¶æ¡ƒè‰² */
    color: #BF6A2F;       /* æŸ”å’Œä¸€ç‚¹çš„æ©™æ£•è‰²æ–‡å­— */
}



        .stat-btn:active {
            transform: scale(0.96);
            background: #E5F4ED;
        }
        .stat-btn:active { transform: scale(0.96); background: #f0f0f0; }
        .stat-label { font-size: 0.8rem; color: #666; margin-right: 5px; }
        .stat-count { font-weight: bold; font-size: 1rem; color: #333; font-family: monospace; }
        .stat-btn.willpower { color: #2E7D32; }
        .stat-btn.joy { color: #558B2F; }

        /* æŠ½å–åŒºåŸŸ */
        .section-filter {
            background: var(--bg-blue);
            padding: 8px 14px 6px; /* å†ç•¥ç¼©é«˜åº¦ï¼Œé¡¶éƒ¨ä¸åº•éƒ¨ç•™ç™½æ›´åŠ æ¥è¿‘ */
            text-align: left;
            border-radius: 18px;
            /* ä¿æŒç°åœ¨çš„å¤©è“è‰²ï¼Œä½†æ”¹ä¸ºçº¯è‰²åº•ï¼Œå»æ‰æ¸å˜ */
            box-shadow: 0 6px 18px rgba(144, 202, 249, 0.25);
            margin: 4px 6px 8px;
            transition: background 0.4s, box-shadow 0.2s, transform 0.2s;
            position: relative;
            z-index: 10;
        }
        .filter-label {
            font-size: 0.8rem;
            color: #6b7a99;
            margin-bottom: 6px;
            padding-left: 4px;
        }
        .mode-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .mode-tab {
            padding: 6px 14px;
            border-radius: 999px; /* æ›´æ¥è¿‘æ¤­åœ†ï¼Œå’Œç­›é€‰æŒ‰é’®å½¢çŠ¶åŒºåˆ† */
            font-size: 0.85rem;
            cursor: pointer;
            background: rgba(255,255,255,0.55);
            transition: all 0.2s;
        }
        .mode-tab.active { background: #fff; font-weight: bold; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .select-wrapper {
            position: relative;
            flex: 1;
        }
        .section-filter select {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border-radius: 12px; /* ä¸ã€Œæ„å¿—åŠ›ã€æŒ‰é’®ç±»ä¼¼çš„è½»åœ†è§’é•¿æ–¹å½¢ */
            border: 1px solid #d6dde8;
            background: #ffffff !important; /* çº¯ç™½åº•è‰² */
            font-size: 0.95rem;
            box-shadow: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            color: #455A64;
        }
        .select-wrapper::after {
            content: "âŒƒ\AâŒ„";
            white-space: pre;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: #90A4AE;
            pointer-events: none;
            line-height: 0.4; /* ä¸Šä¸‹ç®­å¤´æ›´ç´§å‡‘ï¼Œè·ç¦»æ›´è¿‘ */
        }
        
        .btn-main {
            background-image: linear-gradient(135deg, #FF9AA2, #FFB6B9);
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 0.03em;
            font-size: 1.05rem;
            padding: 12px 44px;
            border: none;
            border-radius: 999px;
            box-shadow: 0 10px 24px rgba(255, 154, 162, 0.55);
            cursor: pointer;
            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
            display: block;
            margin: 16px auto 6px; /* ç¨å¾®é è¿‘ç»“æœå¡ç‰‡ */
        }
        .btn-main:active {
            transform: translateY(1px) scale(0.97);
            box-shadow: 0 5px 14px rgba(255, 154, 162, 0.45);
        }

        /* æŠ½å–ç»“æœæ˜¾ç¤ºåŒº + æ‰­è›‹æœº */
        .section-display {
            flex-grow: 1;
            /* èƒŒæ™¯äº¤ç»™ hero-wrapper çš„å¤§æ¸å˜ï¼Œè¿™é‡Œä¿æŒé€æ˜ä»¥çªå‡ºå¡ç‰‡ */
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;  /* ç»“æœå¡ç‰‡é è¿‘ä¸Šæ–¹ï¼Œç¦»â€œå¸®æˆ‘é€‰â€æ›´è¿‘ */
            padding: 12px 22px 22px; /* è®©ç»“æœå¡ç‰‡æ›´è´´è¿‘æŒ‰é’®ï¼Œæ•´ä½“æ›´ç´§å‡‘ */
            min-height: 260px;
            transition: background 0.4s;
            position: relative;
            border-radius: 0 0 16px 16px;
        }
        .card {
            background: white;
            padding: 34px 26px;
            border-radius: 26px;
            text-align: center;
            width: 100%;          /* å†æ”¾å¤§ä¸€äº›ï¼Œå æ»¡å®¹å™¨å¯ç”¨å®½åº¦ */
            max-width: 560px;     /* æ¡Œé¢ç«¯ä¹Ÿæ›´å¤§ä¸€å· */
            box-shadow: 0 16px 40px rgba(0,0,0,0.10);
            display: none;
        }
        .card-icon { font-size: 4.4rem; display: block; margin-bottom: 16px; }
        .card-title { font-size: 1.6rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .card-desc { font-size: 0.9rem; color: #777; line-height: 1.6; margin-bottom: 15px; }
        .card-time { 
            display: inline-block; background: #f0f0f0; color: #888; padding: 2px 8px; 
            border-radius: 8px; font-size: 0.75rem; margin-top: 5px; 
        }
        #rStatus {
            font-size: 1rem;
            color: #FF8A65;  /* æŸ”å’ŒçŠç‘šæ©™ï¼Œå’Œç²‰è“æ›´å’Œè° */
            font-weight: 700;
            margin-bottom: 6px;
            text-align: left;
            display: none;
        }
        #rIngPulse {
            font-size: 0.9rem;
            color: #FF8A65;
            font-weight: 600;
            margin-top: 8px;   /* å’Œæ—¶é—´æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
            margin-bottom: 6px;
            text-align: center;
            display: none;
            animation: anchorPulse 1.6s ease-in-out infinite;
        }
        @keyframes anchorPulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        
        .card-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px; color: #fff; }
        .bg-cycle { background: var(--cycle-purple); }
        .bg-frog { background: var(--frog-green); }
        .bg-flash { background: var(--flash-yellow); color: #555; }

        .btn-card-action {
            background: #f0f0f0; padding: 8px 18px; border-radius: 15px; font-size: 0.85rem; 
            border: none; cursor: pointer; color: #555; margin: 0 5px;
        }

        /* è¾“å…¥åŒº */
        .section-input { background-color: var(--bg-wood); padding: 20px; }
        .input-box {
            background: #fff; padding: 5px; border-radius: 15px; display: flex; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px;
        }
        textarea#inpTitle { 
            border: none; padding: 10px; flex: 1; border-radius: 10px; outline: none; 
            font-size: 16px; font-family: inherit; resize: none;
            min-height: 36px;
            line-height: 1.4;
        }
        .btn-add { background: #B5EAD7; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; color: #555; cursor: pointer; }
        
        .input-options { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .input-options-row2 { display: flex; justify-content: flex-start; align-items: center; gap: 10px; margin-top: 8px; }
        .input-options-row2 .time-select-small {
    margin-left: auto;   /* æŠŠæ—¶é—´é€‰æ‹©æ¨åˆ°è¿™ä¸€è¡Œæœ€å³è¾¹ */
}

        .tags-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag {
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; background: rgba(0,0,0,0.05); 
            cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
        }
        .tag.active { background: #C7CEEA; border-color: #989ec2; color: #333; }
        .tag[data-v="sport"].active { background: var(--sport-green); border-color: #99cbb9; }

        .switch-container { display: flex; gap: 8px; margin-left: 0; }
        .switch-btn {
            font-size: 0.85rem; color: #555; display: flex; align-items: center; gap: 6px; cursor: pointer;
            background: rgba(255,255,255,0.7); padding: 6px 20px; border-radius: 12px; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .switch-btn.active-cycle { background: var(--cycle-purple); color: #fff; font-weight: bold; border-color: var(--cycle-purple); }
        .switch-btn.active-flash { background: var(--flash-yellow); color: #555; font-weight: bold; border-color: #FBC02D; }

       .time-select-small {
    font-size: 16px;
    padding: 6px 14px;
    border-radius: 12px;                 /* å’Œé‚£ä¸¤ä¸ªå¼€å…³æŒ‰é’®åœ†è§’æ¥è¿‘ */
    border: 1px solid rgba(0,0,0,0.06);  /* å¾ˆæ·¡çš„æè¾¹ï¼Œä¸æŠ¢æˆ */
    background: #ffffff;                 /* é‡ç‚¹ï¼šç™½åº• */
    color: #666;
    transition: opacity 0.3s;
}
        .time-select-small.disabled { opacity: 0.3; pointer-events: none; }

        /* å››å¤§å—åˆ—è¡¨åŒºåŸŸï¼šä¸¤åˆ—æ’ç‰ˆ */
        .section-list {
            background-color: var(--panel-soft);
            padding: 16px;
        }

        .list-panels {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .list-panel {
            background: #fff; /* å››å—å¡ç‰‡æœ¬èº«ä¿æŒç™½è‰² */
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 10px 10px 6px;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .panel-header {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .panel-header-top {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 6px;
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #555;
        }

        .panel-count {
            font-size: 0.75rem;
            color: #999;
        }

        .panel-subtitle {
            font-size: 0.75rem;
            color: #aaa;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0 0;
        }

        .task-list.panel-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
            border-bottom: 1px solid #f0f1f5;
            font-size: 0.85rem;
        }

        .task-status-done { opacity: 0.4; text-decoration: line-through; }

        .list-badge {
            font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; margin-left: 5px;
            border: 1px solid #eee; color: #888;
        }
        .lb-frog { color: var(--frog-green); border-color: var(--frog-green); font-weight:bold; }
        .lb-flash { color: #FBC02D; border-color: #FBC02D; }

        .footprint-time { font-size: 0.7rem; color: #aaa; margin-right: 10px; font-family: monospace;}
        .footprint-item { color: #666; font-size: 0.85rem; }

        .archive-item {
            padding: 5px 0;
            display: flex;
            gap: 10px;
            border-bottom: 1px dashed #f3f3f3;
            font-size: 0.8rem;
            align-items: center;
            justify-content: space-between;
        }
        .archive-date { font-family: monospace; color: #ccc; }
        .archive-del { cursor: pointer; color: #ccc; font-size: 0.75rem; }
        .archive-del:hover { color: #e57373; }

        /* è¯´æ˜ä¹¦ & è®¾ç½®åŒº */
        
        /* 04 åŒºï¼šç”¨æˆ·æ‰‹å†Œ & æ•°æ®æ–¹èˆŸ ç»Ÿä¸€èƒŒæ™¯ */
        .section-footer-area {
            background-color: var(--bg-footer);
            padding: 10px 16px 20px;
            margin-top: 0;
        }
        
        /* 04åŒºå¡ç‰‡ç»Ÿä¸€é£æ ¼ï¼šç”¨æˆ·æ‰‹å†Œ / æœ€è¿‘æ›´æ–° / æ•°æ®æ–¹èˆŸ */
        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            background-color: #F9FAFB;
            padding: 10px 12px;
            border-radius: 16px;
        }
        .section-footer-area .section-manual details,
        .section-footer-area .section-updates details,
        .section-footer-area .section-settings details {
            background: transparent;
            border-radius: 0;
            margin-bottom: 0;
        }
        .section-footer-area summary,
        .section-footer-area .settings-title {
            font-size: 0.95rem;
        }
        .section-footer-area summary {
            padding: 10px 4px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #444;
        }
        .section-footer-area .manual-content {
            padding: 0 4px 10px 4px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }
.footer-note {
            margin-top: 10px;
            font-size: 0.75rem;
            color: #777;
            text-align: center;
        }

        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            background-color: #F9FAFB;
        }
        .section-footer-area summary,
        .section-footer-area .settings-title {
            font-size: 0.95rem;
        }

        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            margin-bottom: 14px;
            border-radius: 16px;
        }
        .section-footer-area .section-settings {
            /* 04åŒºä¸­ä¸å…¶ä»–å¡ç‰‡ä¿æŒä¸€è‡´çš„å†…è¾¹è· */
        }
        .section-footer-area .section-manual details,
        .section-footer-area .section-updates details {
            margin-bottom: 0;
        }
.section-manual { background-color: #F9FAFB; padding: 16px; border-top: 1px solid #eee; color: #666; font-size: 0.9rem; line-height: 1.6; }
        details { background: #f9f9f9; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        summary { padding: 15px; font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; color: #444; }
        summary::after { content: '+'; font-size: 1.2rem; font-weight: normal; color: #999; }
        details[open] summary::after { content: '-'; }
        .manual-content { padding: 0 15px 20px 15px; border-top: 1px solid #eee; font-size: 0.85rem; }
        .manual-h3 { font-weight: bold; color: #333; margin: 15px 0 5px 0; }
        .manual-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 0 2px; }
/* è®© 03 åŒºé‡Œçš„å†å²è®°å½•å¡ç‰‡ï¼Œå’Œå‰é¢å››å—å¡ç‰‡é£æ ¼ä¸€è‡´ */
.section-history {
    margin-top: 8px;           /* è·Ÿ HTML é‡Œçš„ 8px å¯¹é½ */
}

.section-history details {
    background: #fff;          /* å’Œ list-panel ä¸€æ ·çš„ç™½å¡ç‰‡ */
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
    margin-bottom: 0;
}

.section-history summary {
    padding: 10px 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #444;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-history .manual-content {
    border-top: 1px solid #eee;
    padding: 6px 8px 10px;
    font-size: 0.8rem;
}

/* å†·åº“å¡ç‰‡ï¼šå’Œå†å²è®°å½•é£æ ¼ä¸€è‡´ï¼Œä½†æ•´ä½“æ›´ä½è°ƒä¸€ç‚¹ */
.section-cold {
    margin-top: 8px;
}

.section-cold details {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
    margin-bottom: 0;
}

.section-cold summary {
    padding: 10px 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #444;
    display: flex;
   justify-content: flex-start;
    align-items: center;
}

.section-cold summary span:last-child {
    margin-left: auto;
}

.section-cold .manual-content {
    border-top: 1px solid #eee;
    padding: 6px 8px 10px;
    font-size: 0.8rem;
}
/* å†·åº“æ“ä½œå¼¹çª—æ•´ä½“èƒŒæ™¯ï¼šå°½é‡è½»ï¼Œä¸è¦æŠ¢æˆ */
.cold-dialog-backdrop {
    position: fixed;
    inset: 0;
    display: none;                 /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.08);  /* è½»å¾®ç°å¹• */
    z-index: 999;
}

/* ä¸­é—´çš„å°å¡ç‰‡æœ¬ä½“ */
.cold-dialog {
    background: #fff;
    border-radius: 18px;
    padding: 14px 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.12);
    width: 86%;
    max-width: 320px;
    box-sizing: border-box;
    font-size: 0.85rem;
}

.cold-dialog-title {
    margin-bottom: 10px;
    font-weight: 600;
}

/* ä¸‰ä¸ªæŒ‰é’®æ¨ªæ’ */
.cold-dialog-buttons {
    display: flex;
    gap: 8px;
}

.cold-dialog-buttons button {
    flex: 1;
    padding: 6px 8px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    white-space: nowrap;
}

/* ä¸‰ä¸ªæŒ‰é’®ç¨å¾®åŒºåˆ†ä¸€ä¸‹è‰²è°ƒï¼Œä½†éƒ½ä¿æŒæŸ”å’Œ */
.cold-btn-delete {
    background: #ffecec;
}

.cold-btn-cold {
    background: #e7f4ff;
}

.cold-btn-cancel {
    background: #f5f5f5;
}

/* è®©æ•´ä¸ª 03 åŒºä¸‹é¢ä¸è¦ç•™å¤ªå¤šç©ºç™½ */
.section-list {
    padding-bottom: 20px;
}

        .section-settings { background-color: var(--bg-setting); padding: 20px; border-top: 1px solid #eee; padding-bottom: 80px;}
        .settings-title { font-size: 0.9rem; font-weight: bold; color: #666; margin-bottom: 10px; }
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:10px;}
        .btn-outline { background: #fff; border: 1px solid #bbb; color: #555; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .btn-file { background: #e1eefd; border: 1px solid #bbd4f0; color: #1565C0; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        textarea { width: 100%; height: 80px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color:#555; padding: 8px; font-family: monospace; }
        .btn-danger { width: 100%; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; color: #c62828; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 0.8rem; }

        /* Modal & Toast */
        .custom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .custom-modal { background: white; width: 80%; max-width: 320px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: left; max-height: 80vh; overflow-y: auto; }
        .modal-text { margin-bottom: 20px; font-size: 0.95rem; color: #333; line-height: 1.6; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; text-align: center;}
        .modal-btn.cancel { background: #f0f0f0; color: #666; }
        .modal-btn.confirm { background: var(--bg-blue); color: #006064; }
        .modal-btn.danger { background: var(--danger-red); color: white; }
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(33,33,33,0.92);
            color: #fff;
            padding: 10px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease-out;
        }
        .toast-notification.show {
            opacity: 1;
        }
        /* --- æ‰­è›‹æœºåŠ¨ç”»ï¼šå¯¹é½ demo è·¯å¾„ --- */
        #gachaLayer {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: radial-gradient(
                circle at top,
                rgba(255,255,255,0.95),
                rgba(255,255,255,0.78)
            );
            z-index: 20;
            opacity: 1;
        }
        .gacha-stage {
            position: relative;
            width: 260px;
            max-width: 90%;
        }
        #gachaImg {
            width: 100%;
            display: block;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transform-origin: 50% 80%;
            transition: opacity 0.6s ease-out;  /* æœºå°æ·¡å‡º */
        }
        @keyframes machineShake {
            0%   { transform: translateY(0) rotate(0deg); }
            20%  { transform: translateY(-4px) rotate(-1deg); }
            40%  { transform: translateY(2px) rotate(1deg); }
            60%  { transform: translateY(-2px) rotate(-0.5deg); }
            80%  { transform: translateY(1px) rotate(0.5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .machine-shake { animation: machineShake 0.7s ease-out; }

        #eggOut {
            position: absolute;
            left: 77%;          /* å‡ºå£æ¨ªå‘ä½ç½® */
            bottom: 88px;       /* å‡ºå£çºµå‘ä½ç½® */
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            opacity: 0;
        }
        @keyframes eggFly {
            0% {
                left: 77%;
                bottom: 72px;   /* ç¨å¾®åœ¨å‡ºå£é‡Œé¢ä¸€ç‚¹ */
                transform: translateX(-50%) scale(0.7);
                opacity: 0;
            }
            15% {
                left: 77%;
                bottom: 88px;   /* åˆ°å‡ºå£å£æ²¿ */
                transform: translateX(-50%) scale(0.9);
                opacity: 1;
            }
            55% {
                left: 62%;
                bottom: 60%;    /* é£å‡ºæœºå°ã€å‘ä¸­é—´ç§»åŠ¨ */
                transform: translateX(-50%) scale(1.15);
                opacity: 1;
            }
            85% {
                left: 50%;
                bottom: 44%;    /* æ›´é ä¸‹ï¼Œæ¥è¿‘å¡ç‰‡ä¸­å¿ƒ */
                transform: translateX(-50%) scale(1.3);
                opacity: 1;
            }
            100% {
                left: 50%;
                bottom: 44%;
                transform: translateX(-50%) scale(1.25);
                opacity: 1;     /* ä¿æŒå¯è§ï¼Œç­‰å¾…çˆ†å¼€åŠ¨ç”» */
            }
        }
        @keyframes eggBurst {
            0% {
                transform: translateX(-50%) scale(1.25);
                opacity: 1;
            }
            30% {
                transform: translateX(-50%) scale(1.6);
                opacity: 0.9;
            }
            100% {
                transform: translateX(-50%) scale(2.0);
                opacity: 0;
            }
        }
        .gm-caption {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #888;
        }

        @keyframes stripOpen {
            0%   { transform: scaleX(0.6); opacity: 0; }
            40%  { transform: scaleX(0.9); opacity: 1; }
            100% { transform: scaleX(1);   opacity: 1; }
        }
    
        .hero-wrapper {
            margin: 4px 0 0;
            padding: 8px 12px 8px;
            /* ä» 01 æ ‡é¢˜å¼€å§‹ï¼Œæ•´ä½“ä»ç™½è‰²è¿‡æ¸¡åˆ°æµ…ç²‰è‰² */
            background: linear-gradient(to bottom, #FFFFFF 0%, var(--bg-pink) 82%);
            border-radius: 0;
            border: none;
            box-shadow: none;
        }
        #selContext, #selTime {
            font-size: 0.95rem;
            min-width: 0;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }
.section-title.section-title-ritual {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.ritual-icons {
    display: flex;
    gap: 4px;
}

.ritual-icon-btn {
    min-width: 40px;
    height: 22px;
    padding: 0 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.10);
    background: #fffaf5;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.75;          /* é»˜è®¤æ·¡ä¸€ç‚¹ */
}

.ritual-icon-btn.dimmed {
    opacity: 0.3;           /* å®Œæˆåå˜æ›´æ·¡ */
}

/* === æ ¹æ® APP_VARIANT åˆ‡æ¢ æ„å¿—åŠ› / å°ç¡®å¹¸ é…è‰² === */

/* personalï¼šä¸€ç»¿ä¸€æ¡ƒï¼ˆä½ ç°åœ¨è¿™ç‰ˆçš„æ„Ÿè§‰ï¼‰ */
body.variant-personal .stat-btn.willpower {
    background: #F3FBF7;
    color: #2E7D32;
}

body.variant-personal .stat-btn.joy {
    background: #FFF5EB;
    color: #BF6A2F;
}

/* commonï¼šä¸¤å—éƒ½ç”¨åŒä¸€æ¬¾æµ…ç»¿ */
body.variant-common .stat-btn.willpower,
body.variant-common .stat-btn.joy {
    background: #F3FBF7;
    color: #2E7D32;
}

        .section-subtitle {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 10px;
        }
        .section-footer-header {
            padding: 8px -8px 4px;
            margin-top: 4px; /* ä¸å‰é¢åˆ†åŒºçš„æ ‡é¢˜ç›¸å¯¹ä½ç½®ä¿æŒä¸€è‡´ */
        }

        .input-label {
            font-size: 0.75rem;
            color: #777;
            margin: 4px 0 4px 2px;
        }
        .section-list-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }
        .section-list-subtitle {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 8px;
        }
/* ğŸŒ…ğŸŒ™ ä»ªå¼åŒºå°æŒ‰é’® */
        .ritual-shortcuts {
            display: flex;
            gap: 6px;
            margin: 6px 0 4px;
            font-size: 0.8rem;
        }
        .ritual-btn {
            flex: 1;
            padding: 4px 6px;
            border-radius: 999px;
            border: 1px dashed rgba(0,0,0,0.08);
            background: #fffaf5;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

/* ğŸŒ…ğŸŒ™ ä»ªå¼å¡ç‰‡ï¼šä½œä¸ºæŠ½å–åŒºé‡Œçš„æ™®é€šä¸€å¼ å¡ */
#ritualOverlay {
    display: none;          /* é»˜è®¤ä¸æ˜¾ç¤º */
    width: 100%;            /* âœ… å…³é”®ï¼šè®©å¤–å±‚å®¹å™¨å æ»¡ç»“æœåŒºå®½åº¦ */
    margin-top: 16px;
    margin-bottom: 16px;
}


.ritual-card {
    width: 100%;
    max-width: 560px;       /* å’Œ resultCard ä¸€è‡´ */
    margin: 0 auto;
    background: #fff;
    border-radius: 26px;    /* å’Œ resultCard ä¸€æ · */
    box-shadow: 0 16px 40px rgba(0,0,0,0.10);
    padding: 34px 26px;     /* å’Œ resultCard ä¸€æ · */
    box-sizing: border-box;
    text-align: center;     /* å’Œç»“æœå¡ä¸€æ ·ï¼Œä¸»æ ‡é¢˜å±…ä¸­ */
}

/* é¡¶éƒ¨å¤§å›¾æ ‡ï¼Œå¤ç”¨ card-icon çš„æ„Ÿè§‰ */
.ritual-card .card-icon {
    font-size: 4.4rem;      /* å’Œ .card-icon ç›¸åŒ */
    display: block;
    margin-bottom: 12px;
}

/* æ ‡é¢˜ï¼Œç®€æ´ä¸€ç‚¹ */
.ritual-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
}

/* ä¸­é—´ checklist æ–‡æœ¬æ”¹ä¸ºå·¦å¯¹é½ï¼Œå¹¶ç¨å¾®æ”¶çª„ä¸€ä¸‹å®½åº¦ */
.ritual-steps {
    margin: 6px 0 16px;
    padding-left: 1.2rem;
    max-height: 220px;      /* âœ… ä¸º 6â€“7 æ¡é¢„ç•™æ›´é«˜çš„å¯è§†åŒºåŸŸ */
    overflow-y: auto;
    font-size: 0.9rem;      /* å’Œ card-desc æ¥è¿‘ï¼Œè¯»èµ·æ¥æ›´èˆ’æœ */
    line-height: 1.6;
    text-align: left;
}

.ritual-steps li {
    margin-bottom: 4px;     /* ç¨å¾®ç´§å‡‘ä¸€ç‚¹ï¼Œ7 æ¡ä¹Ÿä¸ä¼šå¤ªé•¿ */
}


/* åº•éƒ¨ä¸¤ä¸ªæŒ‰é’®ï¼Œå’Œå…¶ä»–å¡ç‰‡æŒ‰é’®é£æ ¼ç»Ÿä¸€ */
.ritual-actions {
    display: flex;
    gap: 10px;
    margin-top: 6px;
}

.ritual-actions button {
    flex: 1;
    padding: 8px 10px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    white-space: nowrap;     /* é˜²æ­¢â€œâœ… ä»ªå¼å®Œæˆâ€æ¢è¡Œ */
}

.ritual-btn-primary {
    background: var(--bg-pink);
}

.ritual-btn-secondary {
    background: #f5f5f5;
}


.ritual-step-checkbox {
    width: 14px;
    height: 14px;
}

.ritual-steps li label span.completed {
    text-decoration: line-through;
    color: #999;
}

</style>
</head>
<body>

<div id="toast" class="toast-notification">âœ… æ“ä½œæˆåŠŸ</div>

<div id="modalOverlay" class="custom-overlay">
    <div class="custom-modal">
        <div id="modalMsg" class="modal-text"></div>
        <div class="modal-btns" id="modalBtnContainer"></div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div><span class="app-title">Anchor âš“ï¸</span><span class="version-badge">v5.5</span></div>
        <span class="btn-icon" onclick="scrollToSettings()">âš™ï¸</span>
    </div>

    <!-- å¿µå¤´è®¡æ•°å™¨ -->
    <div class="stats-bar">
        <div class="stat-btn willpower" onclick="incrementStat('willpower')">
            <span class="stat-label">ğŸ›¡ï¸ æ„å¿—åŠ›</span>
            <span class="stat-count" id="stat-willpower">0</span>
        </div>
        <div class="stat-btn joy" onclick="incrementStat('joy')">
            <span class="stat-label">âœ¨ å°ç¡®å¹¸</span>
            <span class="stat-count" id="stat-joy">0</span>
        </div>
    </div>

    <!-- æŠ½å–åŒº -->
    <div class="hero-wrapper">
        <div class="section-title section-title-ritual">
    <span>01 Â· æŠ½ç­¾è£…ç½®ï¼ˆç­›é€‰ + æŠ½å¡ï¼‰</span>
    <div class="ritual-icons">
        <button class="ritual-icon-btn" data-ritual="morning"
                onclick="openRitual('morning')" aria-label="èµ·åºŠèµ·é£">
            ğŸŒ…
        </button>
        <button class="ritual-icon-btn" data-ritual="night"
                onclick="openRitual('night')" aria-label="ç¡å‰ç€é™†">
            ğŸŒ™
        </button>
    </div>
</div>
        <div class="section-filter" id="filterSec">
        <div id="controls-normal" class="control-group">
            <div class="select-wrapper">
                <select id="selContext">
                    <option value="desktop">ğŸ’» ä¹¦æ¡Œå‰</option>
                    <option value="indoor">ğŸ  å®¤å†…/å®¶</option>
                    <option value="outdoor">ğŸŒ³ æˆ·å¤–</option>
                </select>
            </div>
            <div class="select-wrapper">
                <select id="selTime">
                    <option value="15">â±ï¸ 15minä»¥å†…</option>
                    <option value="30" selected>â±ï¸ 30minå·¦å³</option>
                    <option value="60">â±ï¸ 1å°æ—¶+</option>
                    <option value="120">â±ï¸ 2å°æ—¶+</option>
                </select>
            </div>
        </div>
        <div id="controls-sos" class="control-group" style="display:none; color: #555; font-size:0.9rem;">
            <span>ğŸƒ å…è®¸è‡ªå·±æš‚æ—¶åœä¸‹æ¥...</span>
        </div>
        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('normal')">ğŸ”® æ··åˆ/å…¨åŸŸ</div>
            <div class="mode-tab" onclick="setMode('culture')">ğŸ“– åªçœ‹ä¹¦å½±</div>
            <div class="mode-tab" id="mode-tab-vinyl" onclick="setMode('vinyl')">ğŸ’¿ åªå¬å”±ç‰‡</div>
            <div class="mode-tab" onclick="setMode('sos')" style="color:#d9534f">ğŸ†˜ SOS</div>
        </div>
    </div>
    <button class="btn-main" onclick="draw()" id="mainBtn">æŠ½å–ä»»åŠ¡</button>

    <!-- æŠ½å–ç»“æœ + æ‰­è›‹æœº -->
    <div class="section-display" id="displaySec">
        <div id="placeholder" style="color:#aaa; font-weight:bold; opacity:0.5;">...</div>

        <!-- æ‰­è›‹æœºå±‚ -->
        <div id="gachaLayer">
            <div class="gacha-stage">
                <img id="gachaImg" src="gacha-machine.png" alt="Gacha Machine">
                <img id="eggOut" src="" alt="Capsule Ball">
            </div>
            <div class="gm-caption">å‘½è¿è½¬ä¸€è½¬ï¼Œçœ‹çœ‹ä»Šå¤©çš„é”šç‚¹â€¦</div>
        </div>

    <!-- ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†ä»ªå¼å¡ç‰‡ -->
        <div id="ritualOverlay">
        <div class="ritual-card">
            <!-- é¡¶éƒ¨å¤§å›¾æ ‡ï¼Œå’ŒæŠ½å¡ç»“æœçš„ card-icon ä¸€è‡´ -->
            <span class="card-icon" id="ritualIcon">ğŸŒ…</span>

            <!-- æ ‡é¢˜ï¼Œåªå†™â€œèµ·åºŠèµ·é£ / ç¡å‰ç€é™†â€ -->
            <div class="ritual-title" id="ritualTitle">èµ·åºŠèµ·é£</div>

            <!-- ä¸­é—´ checklist -->
            <ul class="ritual-steps" id="ritualSteps">
                <!-- è¿™é‡Œçš„æ­¥éª¤ä¼šç”¨ JS å¡«å…… -->
            </ul>

            <!-- åº•éƒ¨æŒ‰é’®åŒº -->
            <div class="ritual-actions">
                <button class="ritual-btn-secondary" type="button" onclick="closeRitual()">
                    å…ˆå…³æ‰
                </button>
                <button class="ritual-btn-primary" type="button" onclick="completeRitual()">
                    âœ… ä»ªå¼å®Œæˆ
                </button>
            </div>
        </div>
    </div>


        <!-- ç»“æœå¡ç‰‡ -->
        <div id="resultCard" class="card">
            <div id="rStatus">ğŸ“Œ é”šç‚¹ Â· ING...</div>
            <span class="card-icon" id="rIcon">ğŸ</span>
            <div class="card-title">
                <span id="rTitle"></span>
                <span id="rBadge"></span>
            </div>
            <div class="card-desc" id="rDesc"></div>
            <div class="card-time" id="rTime"></div>
            <div id="rIngPulse">æ­£åœ¨è¿›è¡Œä¸­ Â· Â· Â·</div>
            <div style="margin-top:15px;">
                <button class="btn-card-action" onclick="changeTask()" id="btnChange">æ¢ä¸€ä¸ª</button>
                <button class="btn-card-action" onclick="handlePrimaryAction()" id="btnPrimary">å°±å®ƒå•¦</button>
            </div>
        </div>
    </div>
    </div>

    <!-- è¾“å…¥åŒº -->
    <div class="section-input">
        <div class="section-title">02 Â· æ–°ä»»åŠ¡å…¥åº“</div>
        <div class="input-box">
    <textarea id="inpTitle"
      placeholder="è¾“å…¥äº‹é¡¹â€¦ï¼ˆæ”¯æŒæ‰¹é‡è¾“å…¥ï¼‰&#10;ä¾‹ï¼šï¼å†™å¯¼è¨€30m / æ•´ç†ä¹¦æ¡Œ / çœ‹å¥½ä¸œè¥¿â€¦"
      oninput="autoTag()"
      onkeypress="handleEnter(event)"></textarea>
    <button class="btn-add" onclick="addNew()">ï¼‹</button>
</div>
        <div class="input-options">
            <div class="input-label">ç»™è¿™æ¡ä»»åŠ¡è´´æ ‡ç­¾ï¼š</div>
<div class="tags-row">
    <div class="tag active" data-v="indoor" onclick="pickTag(this)">ğŸ  å®¤å†…</div>
    <div class="tag" data-v="desktop" onclick="pickTag(this)">ğŸ’» æ¡Œå‰</div>
    <div class="tag" data-v="outdoor" onclick="pickTag(this)">ğŸŒ³ æˆ·å¤–</div>
    <div class="tag" data-v="sport" onclick="pickTag(this)">ğŸƒ è¿åŠ¨</div>

    <!-- ä¹¦ / å½± / å‰§é›†ï¼šé€»è¾‘ä¸Šä»ç„¶æ˜¯ cultureï¼Œåªæ˜¯è§†è§‰ä¸Šæ‹†æˆä¸‰ä¸ªæŒ‰é’® -->
<div class="tag" data-v="culture" data-sub="book" onclick="pickTag(this)">ğŸ“– ä¹¦ç±</div>
<div class="tag" data-v="culture" data-sub="movie" onclick="pickTag(this)">ğŸ¬ ç”µå½±</div>
<div class="tag" data-v="culture" data-sub="series" onclick="pickTag(this)">ğŸ“º å‰§é›†</div>


    <!-- å”±ç‰‡æŒ‰é’®ä¿ç•™ï¼Œç”± APP_VARIANT å†³å®šæ˜¯å¦æ˜¾ç¤º -->
    <div class="tag" id="tag-vinyl" data-v="vinyl" onclick="pickTag(this)">ğŸ’¿ å¬ç¢Ÿ</div>
</div>

        </div>
        <div class="input-options-row2">
            <div class="switch-container">
                <div class="switch-btn" id="cycleSwitch" onclick="toggleSwitch('cycle')">
                    <span>ğŸ”„ æ¯æ—¥å¾ªç¯</span>
                </div>
                <div class="switch-btn" id="flashSwitch" onclick="toggleSwitch('flash')">
                    <span>âš¡ï¸ é€ŸåŠæ¨¡å¼</span>
                </div>
            </div>
            <select id="inpTime" class="time-select-small">
                <option value="5">5m (é€ŸåŠ)</option>
                <option value="15">15m</option>
                <option value="30" selected>30m</option>
                <option value="60">1h</option>
                <option value="120">2h+</option>
            </select>
        </div>
        <div id="timeFeedback" style="font-size:0.7rem; color:#75B79E; margin-top:5px; margin-left:5px; height:1rem;"></div>
    </div>

    <!-- å››å¤§å—åˆ—è¡¨ -->
    <div class="section-list">
        <div class="section-list-title">03 Â· ä»»åŠ¡åº“ & è®°å½•</div>

        <!-- ç¬¬ä¸€è¡Œï¼šæ—¥å¸¸&è¿åŠ¨ + åª’ä½“åº“æˆ¿ -->
        <div class="list-panels">
            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title">ğŸ§º æ—¥å¸¸ & è¿åŠ¨</span>
                        <span class="panel-count">(<span id="dailyCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä»Šæ—¥é«˜é¢‘çš„å°äº‹</div>
                </div>
                <ul id="dailyList" class="task-list panel-list"></ul>
            </div>

            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title">ğŸ åª’ä½“åº“æˆ¿</span>
                        <span class="panel-count">(<span id="mediaCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä¹¦ / ç”µå½± / å”±ç‰‡ ç­‰</div>
                </div>
                <ul id="mediaList" class="task-list panel-list"></ul>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šä»Šæ—¥è¶³è¿¹ + è£èª‰æ®¿å ‚ -->
        <div class="list-panels" style="margin-top:12px;">
            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title" style="color:var(--footprint-grey);">ğŸ‘£ ä»Šæ—¥è¶³è¿¹</span>
                        <span class="panel-count">(<span id="logCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä»…ä¿ç•™å½“å¤©è®°å½•</div>
                </div>
                <ul id="logList" class="task-list panel-list"></ul>
            </div>

            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title" style="color:var(--gold);">ğŸ† è£èª‰æ®¿å ‚</span>
                        <span class="panel-count">(<span id="arcCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">åªè®°å½•ä¹¦ / å½± / å¤§å·¥ç¨‹</div>
                </div>
                <div id="archiveList" class="task-list panel-list"></div>
            </div>
        </div>

        <!-- å†·åº“ï¼šæš‚æ—¶é€€åœºçš„ä»»åŠ¡ -->
        <div class="section-cold" style="margin-top:12px;">
            <details id="coldDetails">
                <summary>
    <span style="font-size:0.9rem; font-weight:bold;">ğŸ§Š å†·åº“</span>
    <span style="margin-left:auto; margin-right:8px; display:flex; align-items:center; font-size:0.75rem; color:#999;">
        <span>(</span>
        <span id="coldCount">0</span>
        <span>)</span>
    </span>
</summary>
                <div class="manual-content" id="coldContent">
                    <p style="font-size:0.78rem; color:#777; margin-bottom:6px;">
                        æš‚æ—¶é€€åœºçš„ä»»åŠ¡ï¼Œä¸ä¼šè¢«æŠ½åˆ°ã€‚éœ€è¦æ—¶å¯ä»¥èµ¦å…å›åº“æˆ–å½»åº•åˆ é™¤ã€‚
                    </p>
                    <ul id="coldList" class="task-list" style="max-height:160px; overflow-y:auto; margin-top:4px;"></ul>
                </div>
            </details>
        </div>
    <!-- å†·åº“æ“ä½œå°å¼¹çª—ï¼šé€‰æ‹© åˆ é™¤ / å†·åº“ / å–æ¶ˆ -->
    <div id="coldDialog" class="cold-dialog-backdrop">
        <div class="cold-dialog">
            <div class="cold-dialog-title">
                è¦æ€ä¹ˆå¤„ç†è¿™æ¡ä»»åŠ¡ï¼Ÿ
            </div>
            <div class="cold-dialog-buttons">
                <button type="button" class="cold-btn-delete" onclick="confirmColdAction('delete')">
                    ğŸ—‘ï¸ åˆ é™¤
                </button>
                <button type="button" class="cold-btn-cold" onclick="confirmColdAction('cold')">
                    ğŸ§Š å†·åº“
                </button>
                <button type="button" class="cold-btn-cancel" onclick="confirmColdAction('cancel')">
                    ğŸ”™ å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

        <!-- å†å²è®°å½•ï¼ˆæœ€è¿‘å®Œæˆï¼‰ -->
        <div class="section-history" style="margin-top:12px;">
            <details id="historyDetails">
               <summary><span style="font-size:0.95rem; font-weight:bold;">ğŸ“… å†å²è®°å½•ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰</span></summary>
                <div class="manual-content" id="historyContent">
                    <p style="font-size:0.8rem; color:#777;">
                        è¿™é‡Œä¼šæ±‡æ€»æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å®Œæˆè®°å½•ï¼Œä»…åœ¨ä½ æƒ³å›é¡¾æ—¶å†å±•å¼€æŸ¥çœ‹ã€‚
                    </p>
                </div>
            </details>
        </div>
    </div>

    <!-- ç”¨æˆ·æ‰‹å†Œ & æ•°æ®æ–¹èˆŸ -->
    <div class="section-footer-area">
        <div class="section-footer-header">
            <div class="section-title">04 Â· ç”¨æˆ·æ‰‹å†Œ & æ•°æ®æ–¹èˆŸ</div>
        </div>
        <div class="section-manual">
        <details>
            <summary>ğŸ“– ç”¨æˆ·æ‰‹å†Œ & é€»è¾‘è¯å…¸</summary>
            <div class="manual-content">
                <div class="manual-h3">ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</div>
                <p>Anchor æ˜¯ä¸€ä¸ªå¸®ä½ å¯¹æŠ—æ— åºã€æ‰¾å›ç”Ÿæ´»æŒæ§æ„Ÿçš„å·¥å…·ã€‚æŠŠæƒ³åšçš„äº‹ä¸¢è¿›å»ï¼Œè®©â€œå‘½è¿â€å¸®ä½ åšå†³å®šã€‚</p>
                <div class="manual-h3">âŒ¨ï¸ æ™ºèƒ½è¾“å…¥</div>
                <p>æ”¯æŒâ€œè¯´äººè¯â€å’Œæ‰¹é‡ç²˜è´´ã€‚æ¯è¡Œä¸€ä¸ªä»»åŠ¡ã€‚</p>
                <ul>
                    <li><b>è‡ªåŠ¨ä¹¦å½±ï¼š</b> è¾“å…¥ <span class="manual-tag">çœ‹/è¯»/ä¹¦/å½±/å‰§/è¿½</span> å¼€å¤´ï¼Œè‡ªåŠ¨å½’ç±»ä¸ºæ–‡åŒ–ï¼Œå¹¶åŠ ä¹¦åå·ã€‚</li>
                    <li><b>é—ªç”µé€ŸåŠï¼š</b> è¾“å…¥ <span class="manual-tag">æ´—/åˆ·/ç†/æ‹†/æ‰”/å–</span> ç­‰ï¼Œè‡ªåŠ¨æ ‡è®°ä¸º <span class="manual-tag">âš¡ï¸é€ŸåŠ</span> (5min)ã€‚</li>
                    <li><b>é’è›™ä»»åŠ¡ï¼š</b> è¾“å…¥ <span class="manual-tag">*/!/"é‡è¦"+ç©ºæ ¼</span> å¼€å¤´ï¼Œæ ‡è®°ä¸ºå›°éš¾é‡è¦çš„ <span class="manual-tag">ğŸ¸é’è›™</span>ã€‚</li>
                    <li><b>æ¯æ—¥å¾ªç¯ï¼š</b> è¾“å…¥ <span class="manual-tag">æ¯å¤©/æ¯æ—¥</span>ï¼Œè‡ªåŠ¨å¼€å¯å¾ªç¯ã€‚</li>
                </ul>
                <div class="manual-h3">ğŸ² æŠ½å–é€»è¾‘</div>
                <ul>
                    <li><b>æ··åˆæ¨¡å¼ï¼š</b> æ ¹æ®å½“ä¸‹æ—¶é—´ã€åœ°ç‚¹ï¼Œä»æ‰€æœ‰åº“ä¸­éšæœºæŠ½å–ã€‚</li>
                    <li><b>é’è›™ä¼˜å…ˆï¼š</b> åœ¨ä¹¦æ¡Œå‰ä¸”æ—¶é—´å……è¶³æ—¶ï¼Œå¤§æ¦‚ç‡ä¼˜å…ˆæ¨â€œé’è›™â€ã€‚</li>
                    <li><b>é˜²é‡å¤ï¼š</b> æœ€è¿‘åˆšæŠ½è¿‡çš„ä»»åŠ¡ï¼ŒçŸ­æ—¶é—´å†…ä¸ä¼šå†å‡ºç°ã€‚</li>
                </ul>
                <div class="manual-h3">ğŸ“Š è®¡æ•°å™¨ä¸å½’æ¡£</div>
                <ul>
                    <li><b>ğŸ›¡ï¸ æ„å¿—åŠ›ï¼š</b> æƒ³åšåä¹ æƒ¯ä½†å¿ä½æ—¶ï¼Œç‚¹ä¸€ä¸‹ã€‚</li>
                    <li><b>âœ¨ å°ç¡®å¹¸ï¼š</b> é‡åˆ°å¼€å¿ƒçš„å°äº‹æ—¶ï¼Œç‚¹ä¸€ä¸‹ã€‚</li>
                    <li><b>ğŸ‘£ ä»Šæ—¥è¶³è¿¹ï¼š</b> è®°å½•ä»Šå¤©çš„æ—¥å¸¸æµæ°´ï¼Œæ¬¡æ—¥è‡ªåŠ¨æ¸…ç©ºã€‚</li>
                    <li><b>ğŸ† è£èª‰æ®¿å ‚ï¼š</b> æ°¸ä¹…ä¿å­˜è¯»å®Œçš„ä¹¦å’Œçœ‹è¿‡çš„ç”µå½±ã€‚</li>
                </ul>
                <div class="manual-h3">ğŸ†˜ SOS æ¨¡å¼</div>
                <p>å½“ä½ æ„Ÿåˆ°èº«å¿ƒå®•æœºã€æ— æ³•æ€è€ƒæ—¶ä½¿ç”¨ã€‚å®ƒåªæä¾›æä½é—¨æ§›çš„å¾®è¡ŒåŠ¨ï¼ˆå¦‚æ·±å‘¼å¸ã€å–æ°´ï¼‰ï¼Œå¸®ä½ é‡å¯çŠ¶æ€ã€‚</p>
            </div>
        </details>
    </div>

    
    <div class="section-updates">
        <details>
            <summary>ğŸ“‘ æ›´æ–°æ—¥å¿—</summary>
            <div class="manual-content">
                <ul>
                    <li><b>v5.1ï¼š</b> æ–°å¢æ‰­è›‹æœºæŠ½å¡åŠ¨ç”»ï¼ˆå…¶ä»–å½¢å¼é™†ç»­æ·»åŠ ä¸­ï¼‰ã€‚</li>
                    <li><b>v5.2ï¼š</b> åŠŸèƒ½åˆ†åŒºé‡æ–°è§„åˆ’ æ›´åŠ æ¸…æ™°æ˜äº†ã€‚</li>
                    <li><b>v5.3ï¼š</b> å¢åŠ â€œæ­£åœ¨è¿›è¡Œä¸­â€¦â€ï¼›å¢åŠ 30å¤©å†å²è®°å½•ï¼›æ·»åŠ é‡è¦ä»»åŠ¡æ—¶å¯ä»¥é€šè¿‡â€œ*â€/â€œ!â€/â€œé‡è¦â€åŠ ç©ºæ ¼ å¼€å¯ã€‚</li>
                    <li><b>v5.4ï¼š</b> å…³é”®è¯ä¿®è®¢ï¼šè¾“å…¥â€œçœ‹/å½±â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºç”µå½±ï¼›â€œè¯»/ä¹¦â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºä¹¦ç±ï¼›â€œè¿½/å‰§â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºå‰§é›†ã€‚</li>
                    <li><b>v5.5ï¼š</b> å¢åŠ èµ·åºŠèµ·é£ä»ªå¼ & ç¡å‰ç€é™†ä»ªå¼ï¼ˆå¯è‡ªè¡Œç¼–è¾‘ï¼‰ï¼›å¢åŠ å†·åº“åŠŸèƒ½ï¼šä»»åŠ¡å°å­˜ï¼Œæš‚æ—¶ä¸è¢«æŠ½åˆ°ï¼ˆå¯æ¢å¤ï¼‰ã€‚</li>

                </ul>
            </div>
        </details>
    </div>
    <!-- èµ·é£ & ç€é™†ä»ªå¼ç¼–è¾‘ -->
    <div class="section-settings">
        <details>
            <summary>ğŸ“ èµ·é£ / ç€é™†ä»ªå¼ç¼–è¾‘</summary>
            <div class="manual-content">
                <div style="font-size:0.8rem; color:#666; margin-bottom:6px;">
                    æ¯è¡Œä»£è¡¨ä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ä¿®æ”¹ã€åˆ å‡æˆ–å¢åŠ ï¼›å¦‚æœå…¨éƒ¨ç•™ç©ºï¼Œä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤æ¨¡æ¿ã€‚
                </div>

                <div style="font-size:0.8rem; font-weight:bold; margin:6px 0 4px;">
                    ğŸŒ… èµ·åºŠèµ·é£
                </div>
                <textarea id="ritualMorningInput"
                          placeholder="ä¾‹å¦‚ï¼š&#10;èµ·èº«ç¦»å¼€åºŠ&#10;æ‹‰å¼€çª—å¸˜ / å¼€ç¯&#10;å–ä¸€å£æ°´&#10;èµ°åˆ°ä¹¦æ¡Œ / å›ºå®šè§’è½"></textarea>

                <div style="font-size:0.8rem; font-weight:bold; margin:10px 0 4px;">
                    ğŸŒ™ ç¡å‰ç€é™†
                </div>
                <textarea id="ritualNightInput"
                          placeholder="ä¾‹å¦‚ï¼š&#10;æ‰‹æœºå……ç”µå¹¶è¿œç¦»åºŠè¾¹&#10;å–ä¸€å£æ°´ / åƒè¯&#10;å…³çª—å¸˜ / ç¯&#10;å†™ä¸€å¥â€œæ˜å¤©æƒ³åšçš„äº‹â€"></textarea>

                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn-file" style="flex:1;" type="button" onclick="saveRitualFromInputs()">
                        ğŸ’¾ ä¿å­˜ä»ªå¼
                    </button>
                    <button class="btn-outline" style="flex:1;" type="button" onclick="resetRitualToDefault()">
                        âœ¨ æ¢å¤é»˜è®¤
                    </button>
                </div>
            </div>
        </details>
    </div>

<!-- è®¾ç½® & å¤‡ä»½ -->
    <div class="section-settings" id="settingSec">
        <details>
            <summary>ğŸ“¡ æ•°æ®æ–¹èˆŸ (Offline)</summary>
            <div class="manual-content">
        <div style="font-size:0.8rem; color:#1565C0; margin-bottom:5px; font-weight:bold;">ğŸ“‚ æ–‡ä»¶å¤‡ä»½ (ç”µè„‘ç«¯æ¨è)</div>
        <div class="backup-grid">
            <button class="btn-file" onclick="exportToFile()">ğŸ“¥ å¯¼å‡ºæ–‡ä»¶</button>
            <button class="btn-file" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ–‡ä»¶ (Merge)</button>
        </div>
        <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
        <div style="font-size:0.8rem; color:#666; margin-bottom:5px; font-weight:bold;">ğŸ“ æ–‡æœ¬æ“ä½œ (æ‰‹æœºç«¯)</div>
        <div class="backup-grid">
            <button class="btn-outline" onclick="copyToClip()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬ç </button>
            <button class="btn-outline" onclick="document.getElementById('dataArea').value=''">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <textarea id="dataArea" class="setting-textarea" placeholder="åœ¨æ­¤é•¿æŒ‰ç²˜è´´æ•°æ®ä»£ç ..."></textarea>
        <button class="btn-file" style="width:100%; background:#E8F5E9; border-color:#A5D6A7; color:#2E7D32;" onclick="executeImport()">âœ… ç¡®è®¤å¯¼å…¥ (Merge)</button>
        <button class="btn-danger" onclick="tryResetAll()">ğŸ—‘ï¸ æ ¼å¼åŒ–/é‡ç½®æ‰€æœ‰æ•°æ®</button>
        <input type="file" id="fileInput" style="display:none" onchange="importFromFile(this)">
                </div>
        </details>
    </div>
        <div class="footer-note">
            æœ¬å·¥å…·ä»…åœ¨æœ¬æœºæµè§ˆå™¨å­˜å‚¨æ•°æ®ï¼Œä¸ä¸Šä¼ äº‘ç«¯ã€‚è¯·è®°å¾—ã€Œå¯¼å‡ºå¤‡ä»½ã€ã€‚<br>
            Anchor Â· by scc ğŸŒŠ
        </div>
    </div>
<script>
    // ===== Anchor Variant Switch =====
    // 'personal' æ˜¾ç¤ºå”±ç‰‡ç›¸å…³åŠŸèƒ½ï¼›'common' éšè—å”±ç‰‡ç›¸å…³åŠŸèƒ½
    const APP_VARIANT = 'personal';

    const sosLibrary = [
        { title: "å¤§å£å–æ°´", icon: "ğŸ’§", desc: "æ„Ÿå—æ°´æµç»è¿‡é£Ÿé“ã€‚" },
        { title: "çœ‹çª—å¤–è¿œæ–¹", icon: "ğŸ‘€", desc: "å¯»æ‰¾è§†é‡é‡Œæœ€è¿œçš„ä¸€æ£µæ ‘ã€‚" },
        { title: "4-7-8 å‘¼å¸", icon: "ğŸŒ¬ï¸", desc: "å¸æ°”4ç§’ï¼Œæ†‹æ°”7ç§’ï¼Œå‘¼æ°”8ç§’ã€‚" },
        { title: "å‹è…¿æ‹‰ä¼¸", icon: "ğŸ¦µ", desc: "æ‹‰ä¼¸å¤§è…¿åä¾§ã€‚" },
        { title: "äº”æ„Ÿç€é™†", icon: "ğŸ–ï¸", desc: "5æ ·çœ‹åˆ°çš„ï¼Œ4æ ·å¬åˆ°çš„ã€‚" },
        { title: "æ´—æŠŠè„¸", icon: "ğŸš¿", desc: "å†·æ°´æ³¼è„¸ï¼Œç‰©ç†é™æ¸©ã€‚" },
        { title: "åƒä¸€é¢—æ°´æœ", icon: "ğŸŠ", desc: "æ…¢æ…¢åƒï¼Œæ„Ÿå—é¦™æ°”ã€‚" }
    ];

    const KEY_DB = 'anchor_live_db';
    const KEY_ARCHIVE = 'anchor_live_archive';
    const KEY_LOG = 'anchor_live_log';
    const KEY_STATS = 'anchor_live_stats';
    const KEY_VISITED = 'anchor_has_visited_v55_personal';
    const KEY_RITUAL_MORNING = 'anchor_ritual_morning_v55';
    const KEY_RITUAL_NIGHT  = 'anchor_ritual_night_v55';


    const defaultDB = [
        { id: 1, title: "å¬ä¸€å¼ å–œæ¬¢çš„é»‘èƒ¶", type: "vinyl", desc: "éŸ³ä¹æ—¶é—´", time: 0 },
        { id: 2, title: "å–æ°´æœèŒ¶", type: "indoor", desc: "è¡¥å……ç»´C", time: 15 }
    ];

    let db = JSON.parse(localStorage.getItem(KEY_DB)) || [];
    let archive = JSON.parse(localStorage.getItem(KEY_ARCHIVE)) || [];
    let dailyLog = JSON.parse(localStorage.getItem(KEY_LOG)) || [];
    let userStats = JSON.parse(localStorage.getItem(KEY_STATS)) || { willpower: 0, joy: 0 };
            // ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†é»˜è®¤æ­¥éª¤ï¼ˆé»˜è®¤æ¨¡æ¿ï¼‰
    const ritualMorningDefault = [
        'èµ·èº«ç¦»å¼€åºŠ',
        'æ‹‰å¼€çª—å¸˜ / å¼€ç¯',
        'å–ä¸€å£æ°´',
        'èµ°åˆ°ä¹¦æ¡Œ / å›ºå®šè§’è½'
    ];

    const ritualNightDefault = [
        'æ‰‹æœºå……ç”µå¹¶è¿œç¦»åºŠè¾¹',
        'å–ä¸€å£æ°´ / åƒè¯',
        'å…³çª—å¸˜ / ç¯',
        'å†™ä¸€å¥â€œæ˜å¤©æƒ³åšçš„äº‹â€'
    ];

    // å½“å‰å®é™…ä½¿ç”¨çš„æ­¥éª¤æ•°ç»„ï¼ˆå…è®¸è¢«ç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–ï¼‰
    let ritualMorningSteps = ritualMorningDefault.slice();
    let ritualNightSteps   = ritualNightDefault.slice();

    let currentRitualType = null; // 'morning' | 'night'
    
    let recentHistory = [];
    // å†·åº“æ“ä½œå¼¹çª—ï¼šå½“å‰è¦å¤„ç†å“ªä¸€æ¡ä»»åŠ¡
    let pendingColdId = null;

    function loadRitualSettings() {
        try {
            const storedMorning = localStorage.getItem(KEY_RITUAL_MORNING);
            const storedNight   = localStorage.getItem(KEY_RITUAL_NIGHT);

            if (storedMorning) {
                const parsed = JSON.parse(storedMorning);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    ritualMorningSteps = parsed;
                }
            }
            if (storedNight) {
                const parsed = JSON.parse(storedNight);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    ritualNightSteps = parsed;
                }
            }
        } catch (e) {
            console.warn('åŠ è½½ä»ªå¼è®¾ç½®å‡ºé”™', e);
        }
    }

    let mode = 'normal';
    let currentTask = null;
    let currentStatus = 'idle';
    let anchorStartTime = null;
    let switchState = { cycle: false, flash: false };
    let gachaAnimating = false;

    // æ ‡è®°ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨è¦†ç›–é€ŸåŠ
    let userOverrideFlash = false;

    document.addEventListener('DOMContentLoaded', () => {
        // å…ˆè¯»å–å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰ä»ªå¼
        loadRitualSettings();
        if(db.length === 0 && archive.length === 0) {
            if (typeof APP_VARIANT !== 'undefined' && APP_VARIANT === 'common') {
                db = defaultDB.filter(item => item.type !== 'vinyl');
            } else {
                db = defaultDB;
            }
        } 
        checkLogExpiry();
        renderList(); renderArchive(); renderLog(); renderHistory(); updateStatsUI(); 
        setMode('normal');
                if (!localStorage.getItem(KEY_VISITED)) {
            alert("ğŸ‘‹ æ¬¢è¿æ¥åˆ° Anchor v5.5ï¼\n\nğŸ†• æœ€è¿‘æ›´æ–°ï¼š\n- \å¢åŠ èµ·åºŠèµ·é£ä»ªå¼ & ç¡å‰ç€é™†ä»ªå¼ï¼ˆå¯è‡ªè¡Œç¼–è¾‘ï¼‰ï¼›\n- \å¢åŠ å†·åº“åŠŸèƒ½ï¼šä»»åŠ¡å°å­˜ï¼Œæš‚æ—¶ä¸è¢«æŠ½åˆ°ï¼ˆå¯æ¢å¤ï¼‰ã€‚");
            localStorage.setItem(KEY_VISITED, 'true');
        }
        applyVariant();

        // åˆå§‹åŒ–ä»ªå¼ç¼–è¾‘åŒºæ–‡æœ¬ï¼šæŠŠå½“å‰ä½¿ç”¨çš„æ­¥éª¤å†™è¿›æ–‡æœ¬æ¡†
        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (inputMorning) inputMorning.value = ritualMorningSteps.join('\n');
        if (inputNight)   inputNight.value   = ritualNightSteps.join('\n');
});

        // ğŸŒ…ğŸŒ™ ä»ªå¼æ­¥éª¤ï¼šå‹¾é€‰æ—¶ç»™æ–‡å­—åŠ ä¸Šåˆ’çº¿
        const ritualStepsEl = document.getElementById('ritualSteps');
        if (ritualStepsEl) {
            ritualStepsEl.addEventListener('change', function (e) {
                const checkbox = e.target;
                if (!checkbox.classList.contains('ritual-step-checkbox')) return;
                const span = checkbox.nextSibling;
                if (span && span.nodeType === 1) {
                    span.classList.toggle('completed', checkbox.checked);
                }
            });
        }

    function scrollToSettings() {
        const sec = document.getElementById('settingSec');
        if (sec) sec.scrollIntoView({ behavior: 'smooth' });
    }

    function save() {
        localStorage.setItem(KEY_DB, JSON.stringify(db));
        localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
        localStorage.setItem(KEY_LOG, JSON.stringify(dailyLog));
        localStorage.setItem(KEY_STATS, JSON.stringify(userStats));
    }

    function renderList() {
        const dailyList = document.getElementById('dailyList');
        const mediaList = document.getElementById('mediaList');
        const coldList  = document.getElementById('coldList');
        if (!dailyList || !mediaList) return;

        dailyList.innerHTML = "";
        mediaList.innerHTML = "";
        if (coldList) coldList.innerHTML = "";

        let dCount = 0, mCount = 0, cCount = 0;
        const todayStr = new Date().toDateString();
        const sortedDB = [...db].sort((a, b) => b.id - a.id);

        sortedDB.forEach(item => {
            const li = document.createElement('li');
            li.className = 'task-item';
            const isDoneToday = (item.recurrence === 'daily' && item.lastDone === todayStr);
            if (isDoneToday) li.classList.add('task-status-done');

            const seriesBadge = item.isSeries ? `<span class="list-badge">âˆç³»åˆ—</span>` : '';
            const cycleBadge = item.recurrence === 'daily'
                ? (isDoneToday ? `<span class="list-badge">ä»Šå¤©âœ…</span>` : `<span class="list-badge">ğŸ”„</span>`)
                : '';

            let extraBadges = "";
            if (item.isFrog) extraBadges += `<span class="list-badge lb-frog">ğŸ¸</span>`;
            if (item.isQuick) extraBadges += `<span class="list-badge lb-flash">âš¡ï¸</span>`;

            let tDisplay = "";
            if (item.time === 0) tDisplay = `<span style="font-size:0.7rem;color:#ccc;margin-left:5px;">ä»»æ„</span>`;
            else if (item.time) tDisplay = `<span style="font-size:0.7rem;color:#ccc;margin-left:5px;">${item.time}m</span>`;

            const isCold = item.inColdStorage === true;

            let actionHtml = "";
            if (isCold) {
                actionHtml = `
                <div style="display:flex;align-items:center;gap:6px;font-size:0.75rem;color:#ccc;">
                    <span class="task-restore" style="cursor:pointer;" onclick="restoreFromColdStorage(${item.id})">â™»ï¸</span>
                    <span class="task-del" style="cursor:pointer;" onclick="tryDeleteItem(${item.id})">ğŸ—‘ï¸</span>
                </div>
                `;
            } else {
    actionHtml = `
    <div style="display:flex;align-items:center;gap:6px;font-size:0.75rem;color:#ccc;">
        <span class="task-cold" style="cursor:pointer;" onclick="handleColdOrDelete(${item.id})">ğŸ§Š</span>
    </div>
    `;
}


            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:5px;">
                    <span style="width:20px;text-align:center;">${getSmartIcon(item)}</span>
                    <span style="font-size:0.9rem;color:#555;">${item.title}</span>
                    ${seriesBadge}${cycleBadge}${extraBadges}${tDisplay}
                </div>
                ${actionHtml}
            `;

            if (isCold) {
                if (coldList) {
                    coldList.appendChild(li);
                    cCount++;
                }
            } else if (item.type === 'culture' || item.type === 'vinyl') {
                mediaList.appendChild(li);
                mCount++;
            } else {
                dailyList.appendChild(li);
                dCount++;
            }
        });

        const dailyCountEl = document.getElementById('dailyCount');
        const mediaCountEl = document.getElementById('mediaCount');
        const coldCountEl  = document.getElementById('coldCount');

        if (dailyCountEl) dailyCountEl.innerText = dCount;
        if (mediaCountEl) mediaCountEl.innerText = mCount;
        if (coldCountEl) coldCountEl.innerText = cCount;

        const coldContent = document.getElementById('coldContent');
        if (coldContent) {
            const infoP = coldContent.querySelector('p');
            if (infoP) {
                infoP.style.display = cCount === 0 ? 'block' : 'none';
            }
        }
    }

    function renderArchive() {
        const list = document.getElementById('archiveList');
        if(!list) return;
        list.innerHTML = "";
        document.getElementById('arcCount').innerText = archive.length;

        archive.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'archive-item';

            const icon = item.icon || getSmartIcon(item);
            const badge = (item.isFrog || item.type === 'important') ? ' ğŸ…' : '';

            div.innerHTML = `
                <span style="flex:1;">${icon} ${item.title}${badge}</span>
                <span class="archive-del" onclick="deleteArchiveItem(${i})">ğŸ—‘ï¸</span>
            `;
            list.appendChild(div);
        });
    }


    

function renderLog() {
        const list = document.getElementById('logList');
        if(!list) return;
        list.innerHTML = "";
        const today = new Date().toDateString();
        const todaysLogs = dailyLog.filter(log => log.date === today);
        document.getElementById('logCount').innerText = todaysLogs.length;
        todaysLogs.forEach(log => {
            const li = document.createElement('li');
            li.className = 'task-item';
            const suffix = log.done ? ' âœ…' : '';
            li.innerHTML = `
                <div style="display:flex;align-items:center;">
                    <span class="footprint-time">${log.timeStr}</span>
                    <span class="footprint-item">${log.icon} ${log.title}${suffix}</span>
                </div>
            `;
            list.appendChild(li);
        });
    }

    function renderHistory() {
        const container = document.getElementById('historyContent');
        if (!container) return;
        if (!Array.isArray(dailyLog) || dailyLog.length === 0) {
            container.innerHTML = `<p style="font-size:0.8rem; color:#777;">æœ€è¿‘æš‚æ— å®Œæˆè®°å½•ã€‚</p>`;
            return;
        }
        const byDate = {};
        dailyLog.forEach(log => {
            if (!log.date) return;
            if (!byDate[log.date]) byDate[log.date] = [];
            byDate[log.date].push(log);
        });
        const dateKeys = Object.keys(byDate).sort((a,b) => new Date(b) - new Date(a));
        const maxDays = 30;
        let htmlStr = "";
        dateKeys.slice(0, maxDays).forEach(dateStr => {
            const dayLogs = byDate[dateStr];
            const dateLabel = new Date(dateStr).toLocaleDateString();
            htmlStr += `<div style="margin-bottom:8px;">`;
            htmlStr += `<div style="font-size:0.8rem; color:#666; margin-bottom:2px;">${dateLabel}</div>`;
            dayLogs.forEach(log => {
                const suffix = log.done ? ' âœ…' : '';
                htmlStr += `<div style="font-size:0.8rem; color:#444;">${log.icon || ''} ${log.title}${suffix}</div>`;
            });
            htmlStr += `</div>`;
        });
        if (!htmlStr) {
            container.innerHTML = `<p style="font-size:0.8rem; color:#777;">æœ€è¿‘æš‚æ— å®Œæˆè®°å½•ã€‚</p>`;
        } else {
            container.innerHTML = htmlStr;
        }
    }

function updateStatsUI() {
        const elWill = document.getElementById('stat-willpower');
        const elJoy = document.getElementById('stat-joy');
        if(elWill) elWill.innerText = userStats.willpower;
        if(elJoy) elJoy.innerText = userStats.joy;
    }
    
    
function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        } else {
            alert(msg);
        }
    }

    function incrementStat(type) {
        if (type === 'willpower') { userStats.willpower++; showToast("ğŸ’ª æ„å¿—åŠ› +1"); } 
        else if (type === 'joy') { userStats.joy++; showToast("âœ¨ å°ç¡®å¹¸ +1"); }
        updateStatsUI(); save();
    }

    
function checkLogExpiry() {
        // ä»¥å‰ä¼šåœ¨è¿™é‡Œæ¸…ç†æ‰éä»Šå¤©çš„è¶³è¿¹ï¼›ç°åœ¨ä¿ç•™å®Œæ•´ dailyLog ä½œä¸ºå†å²ã€‚
        // åªåšä¸€ä¸ªè½»é‡ä¿æŠ¤ï¼šç¡®ä¿ dailyLog æ˜¯æ•°ç»„ã€‚
        if (!Array.isArray(dailyLog)) {
            dailyLog = [];
            save();
        }
    }

function parseTimeFromInput(str) {
        let detectedTime = null; let cleanStr = str;
        const regexH = /(\d+(?:\.\d+)?)\s*(h|hr|hour|hours|å°æ—¶)/i;
        let matchH = str.match(regexH);
        if (matchH) { detectedTime = parseFloat(matchH[1]) * 60; cleanStr = cleanStr.replace(matchH[0], '').trim(); }
        if (!detectedTime) {
            const regexM = /(\d+)\s*(m|min|mins|åˆ†|åˆ†é’Ÿ)/i;
            let matchM = str.match(regexM);
            if (matchM) { detectedTime = parseInt(matchM[1]); cleanStr = cleanStr.replace(matchM[0], '').trim(); }
        }
        return { time: detectedTime, title: cleanStr };
    }

function getSmartIcon(item) {
    const titleRaw = item.title || "";
    const title = titleRaw.trim();
    const firstChar = title.charAt(0) || '';

    // === 1ï¼‰ä¹¦å½±ç±»ï¼šä¼˜å…ˆçœ‹ç³»åˆ— / subtypeï¼Œç„¶åå†çœ‹é¦–å­— / å…³é”®è¯ ===
    if (item.type === 'culture') {
        // 1.0 ç³»åˆ—ä¼˜å…ˆï¼šæ‚å¿— / å‘¨åˆŠ / ç³»åˆ— / å…¨é›† ç­‰ï¼Œåœ¨ addNew é‡Œå·²ç»æ‰“äº† isSeries
        if (item.isSeries) {
            return 'ğŸ“º';
        }

        // 1.1 æœ‰ subtype æ—¶æœ€å¯é 
        if (item.subtype === 'book')  return 'ğŸ“–';
        if (item.subtype === 'movie') return 'ğŸ¬';

        // 1.2 æ²¡æœ‰ subtypeï¼Œå†çœ‹é¦–å­—
        if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
            return 'ğŸ“–';
        }
        if (firstChar === 'çœ‹' || firstChar === 'å½±') {
            return 'ğŸ¬';
        }

        // 1.3 å†å…œåº•çœ‹å…³é”®è¯ï¼ˆå…¼å®¹ç›´æ¥å†™ã€Šä¹¦åã€‹è¿™ç±»ï¼‰
        if (
            title.includes('ä¹¦') ||
            title.includes('è¯»') ||
            title.includes('æ‚å¿—') ||
            title.includes('é˜…è¯»')
        ) {
            return 'ğŸ“–';
        }
        if (
            title.includes('ç”µå½±') ||
            title.includes('å½±') ||
            title.includes('ç‰‡')
        ) {
            return 'ğŸ¬';
        }

        // å®åœ¨åˆ†ä¸å‡ºï¼Œå°±ç»™ä¸€ä¸ªä¸­æ€§çš„æ–‡åŒ–å›¾æ ‡
        return 'ğŸ–¼ï¸';
    }

    // === 2ï¼‰å”±ç‰‡ç±» ===
    if (item.type === 'vinyl') {
        return 'ğŸ’¿';
    }

    // === 3ï¼‰å…¶ä»–ç±»å‹äº¤ç»™é€šç”¨æ˜ å°„ ===
    return getIcon(item.type);
}


    function getIcon(t) {
        const map = { 'indoor':'ğŸ ', 'desktop':'ğŸ’»', 'outdoor':'ğŸŒ³', 'sport':'ğŸƒ', 'culture':'ğŸ¬', 'vinyl':'ğŸ’¿', 'sos':'ğŸš‘' };
        return map[t] || 'âœ¨';
    }

    function getDescByType(t) {
        if(t==='vinyl') return "äº«å—è¿™æ®µéŸ³ä¹æ—¶å…‰ã€‚";
        if(t==='culture') return "æ²‰æµ¸åœ¨æ•…äº‹é‡Œã€‚";
        if(t==='sport') return "åŠ¨èµ·æ¥ï¼";
        return "å»è¡ŒåŠ¨å§ï¼";
    }

    // æ‰­è›‹çƒé¢œè‰²æ˜ å°„
    function getCapsuleSrc(task) {
        if (!task || task.type === 'sos') return null;
        if (task.isFrog) return "gacha-ball-white.png";
        if (task.isQuick) return "gacha-ball-yellow.png";
        if (task.type === 'vinyl') return "gacha-ball-orange.png";
        if (task.type === 'culture') {
            const t = task.title || "";
            if (t.includes("å½±") || t.includes("ç‰‡")) return "gacha-ball-blue.png";
            return "gacha-ball-pink.png";
        }
        if (task.type === 'sport') return "gacha-ball-green.png";
        return "gacha-ball-purple.png";
    }

    
function renderResultCard(result) {
        const card   = document.getElementById('resultCard');
        const ph     = document.getElementById('placeholder');
        const title  = document.getElementById('rTitle');
        const badge  = document.getElementById('rBadge');
        const descEl = document.getElementById('rDesc');
        const iconEl = document.getElementById('rIcon');
        const timeEl = document.getElementById('rTime');
        const statusEl = document.getElementById('rStatus');
        const changeBtn = document.getElementById('btnChange');
        const primaryBtn = document.getElementById('btnPrimary');
        const ingEl = document.getElementById('rIngPulse');

        if (!card) return;

        if (!result) {
            if (ph) ph.style.display = 'none';
            if (title) title.innerText = "æš‚æ— ä»»åŠ¡";
            if (badge) badge.innerHTML = "";
            if (descEl) descEl.innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ";
            if (iconEl) iconEl.innerText = "ğŸŒ™";
            if (timeEl) timeEl.innerText = "";
            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            if (changeBtn) changeBtn.style.display = 'none';
            if (primaryBtn) primaryBtn.style.display = 'none';
        } else {
            if (title) title.innerText = result.title || "";
            if (badge) {
                let badgesHtml = "";
                if (result.isFrog) badgesHtml += `<span class='card-badge bg-frog'>ğŸ¸ é’è›™</span>`;
                if (result.isQuick) badgesHtml += `<span class='card-badge bg-flash'>âš¡ï¸ é€ŸåŠ</span>`;
                if (result.recurrence === 'daily') badgesHtml += `<span class='card-badge bg-cycle'>ğŸ”„ æ¯æ—¥</span>`;
                badge.innerHTML = badgesHtml;
            }
            let displayDesc = result.desc;
            if (!displayDesc || displayDesc === "è‡ªå®šä¹‰") displayDesc = getDescByType(result.type);
            if (descEl) descEl.innerText = displayDesc || "";
            if (iconEl) iconEl.innerText = result.icon || getSmartIcon(result);

            let timeStr = "";
            if (result.type === 'sos')      timeStr = "âš¡ï¸ å³æ—¶";
            else if (result.time === 0)     timeStr = "â³ ä¸°ä¿­ç”±äºº";
            else                            timeStr = `â±ï¸ ${result.time || 30} min`;
            if (timeEl) timeEl.innerText = timeStr;

            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            if (changeBtn) changeBtn.style.display = 'inline-block';
            if (primaryBtn) {
                primaryBtn.style.display = 'inline-block';
                if (result.type === 'sos') {
                    primaryBtn.innerText = "å»å®Œæˆ";
                    currentStatus = 'sos';
                } else {
                    primaryBtn.innerText = "å°±å®ƒå•¦";
                    currentStatus = 'suggest';
                }
            }
        }

        card.style.animation = "none";
        void card.offsetWidth;
        card.style.animation = "stripOpen 0.28s ease-out forwards";
        card.style.display = 'block';
    }

    function setCardAsAnchor() {
        if (!currentTask || currentTask.type === 'sos') return;
        const statusEl = document.getElementById('rStatus');
        const primaryBtn = document.getElementById('btnPrimary');
        const ingEl = document.getElementById('rIngPulse');
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.innerText = 'ğŸ“Œ é”šç‚¹ Â· ING...';
        }
        if (ingEl) {
            ingEl.style.display = 'block';
        }
        if (primaryBtn) {
            primaryBtn.innerText = 'å·²å®Œæˆ';
        }
        currentStatus = 'anchor';
        anchorStartTime = Date.now();
    }

    function handlePrimaryAction() {
        if (!currentTask) return;
        if (currentTask.type === 'sos') {
            finishTask();
            return;
        }
        if (currentStatus === 'suggest') {
            setCardAsAnchor();
        } else if (currentStatus === 'anchor') {
            finishTask();
        } else {
            draw();
        }
    }

    function changeTask() {
        if (!currentTask) { 
            draw();
            return;
        }
        if (currentTask.type !== 'sos' && currentStatus === 'anchor' && anchorStartTime) {
            const now = Date.now();
            const elapsed = now - anchorStartTime;
            if (elapsed >= 30000) {
                const dt = new Date();
                const timeStr = dt.getHours().toString().padStart(2, '0') + ":" + dt.getMinutes().toString().padStart(2, '0');
                dailyLog.unshift({
                    title: currentTask.title,
                    icon: currentTask.icon || getSmartIcon(currentTask),
                    timeStr: timeStr,
                    date: dt.toDateString(),
                    done: false
                });
                save();
                renderLog();
                renderHistory();
            }
        }
        currentTask = null;
        currentStatus = 'idle';
        anchorStartTime = null;
        const statusEl = document.getElementById('rStatus');
        const ingEl = document.getElementById('rIngPulse');
        if (statusEl) statusEl.style.display = 'none';
        if (ingEl) ingEl.style.display = 'none';
        draw();
    }

function playGachaAnimation(result) {
        const layer  = document.getElementById('gachaLayer');
        const eggOut = document.getElementById('eggOut');
        const img    = document.getElementById('gachaImg');
        const card   = document.getElementById('resultCard');
        const ph     = document.getElementById('placeholder');
        const btn    = document.getElementById('mainBtn');

        if (!layer || !eggOut || !img) {
            renderResultCard(result);
            return;
        }

        gachaAnimating = true;

        if (btn) {
            btn.disabled = true;
            btn.innerText = "æŠ½å–ä¸­â€¦";
        }
        if (ph)   ph.style.display   = 'none';
        if (card) card.style.display = 'none';

        layer.style.display = 'flex';
        layer.style.opacity = '1';
        img.style.opacity   = '1';

        const src = getCapsuleSrc(result) || "gacha-ball-pink.png";
        eggOut.src = src;
        eggOut.style.opacity    = 0;
        eggOut.style.animation  = 'none';
        eggOut.style.transition = 'none';
        img.classList.remove('machine-shake');
        void eggOut.offsetWidth;

        setTimeout(() => { img.classList.add('machine-shake'); }, 80);
        setTimeout(() => { eggOut.style.animation = 'eggFly 1.1s ease-out forwards'; }, 260);
        setTimeout(() => { img.style.opacity = '0'; }, 700);

        setTimeout(() => {
            eggOut.style.animation  = 'none';
            eggOut.style.left       = '50%';
            eggOut.style.bottom     = '44%';
            eggOut.style.transform  = 'translateX(-50%) scale(1.25)';
            void eggOut.offsetWidth;

            eggOut.style.animation = 'eggBurst 0.4s ease-out forwards';
            renderResultCard(result);

            layer.style.transition = 'opacity 0.25s ease-out';
            layer.style.opacity    = '0';
        }, 1350);

        setTimeout(() => {
            layer.style.display = 'none';
            layer.style.opacity = '1';
            img.classList.remove('machine-shake');
            img.style.opacity = '1';
            eggOut.style.animation = 'none';

            if (btn) {
                btn.disabled = false;
                if (mode === 'vinyl')        btn.innerText = "ğŸ’¿ æŒ‘å”±ç‰‡";
                else if (mode === 'culture') btn.innerText = "ğŸ¬ ç²¾ç¥é£Ÿç²®";
                else if (mode === 'sos')     btn.innerText = "ğŸš‘ æ•‘æ•‘æˆ‘";
                else                         btn.innerText = "ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)";
            }
            gachaAnimating = false;
        }, 2000);
    }

    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNew(); } }

    function setMode(m) { 
        mode = m; 
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active')); 
        const map = { 'normal':0, 'culture':1, 'vinyl':2, 'sos':3 }; 
        if(map[m] !== undefined) document.querySelectorAll('.mode-tab')[map[m]].classList.add('active'); 

        const filter = document.getElementById('filterSec'); 
        const display = document.getElementById('displaySec'); 
        const normCtl = document.getElementById('controls-normal'); 
        const sosCtl = document.getElementById('controls-sos'); 
        const btn = document.getElementById('mainBtn'); 

        if(m === 'sos') { 
            filter.style.background = 'var(--bg-sos)'; 
            display.style.background = '#F3E5F5'; 
            normCtl.style.display = 'none'; 
            sosCtl.style.display = 'flex'; 
            btn.innerText = "ğŸš‘ æ•‘æ•‘æˆ‘"; 
            btn.style.background = "#957DAD"; 
        } else { 
            /* æ¸…é™¤å†…è”èƒŒæ™¯ï¼Œä½¿ç”¨ CSS ä¸­çš„æ¸å˜èƒŒæ™¯ */
            filter.style.background = ''; 
            display.style.background = ''; 
            normCtl.style.display = 'flex'; 
            sosCtl.style.display = 'none'; 
            btn.style.background = "#FF9AA2"; 
            if(m === 'vinyl') btn.innerText = "ğŸ’¿ æŒ‘å”±ç‰‡"; 
            else if(m === 'culture') btn.innerText = "ğŸ¬ ç²¾ç¥é£Ÿç²®"; 
            else btn.innerText = "ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)"; 
        } 
    }
    
    function draw() {
        const card = document.getElementById('resultCard'); 
        if (card) card.style.display = 'none';

        // ğŸ‘‰ å¦‚æœæœ‰èµ·åºŠ/ç¡å‰ä»ªå¼å¡åœ¨ï¼Œå°±å…ˆå…³æ‰
        const overlay = document.getElementById('ritualOverlay');
        if (overlay) overlay.style.display = 'none';

        if (mode !== 'sos' && gachaAnimating) return;

        setTimeout(() => {
            let result = null;
            if (mode === 'sos') { 
                const r = Math.floor(Math.random() * sosLibrary.length); 
                result = { ...sosLibrary[r], type: 'sos', time: 0 }; 
            } else {
                const ctx = document.getElementById('selContext').value; 
                const limitTime = parseInt(document.getElementById('selTime').value); 
                const todayStr = new Date().toDateString();
                let validPool = db.filter(item => {
                    if (item.inColdStorage) return false;
                    if (item.recurrence === 'daily' && item.lastDone === todayStr) return false;
                    const tTime = (item.time === undefined || item.time === null) ? 30 : item.time;
                    const isFlexible = (tTime === 0);
                    if (!isFlexible && !item.isQuick && tTime > limitTime) return false;
                    if (mode === 'vinyl') return item.type === 'vinyl'; 
                    if (mode === 'culture') return item.type === 'culture';
                    if (item.type === 'culture' || item.type === 'vinyl') { 
                        if (ctx === 'outdoor') return false; 
                    } else if (item.type === 'sport') { 
                        return true; 
                    } else { 
                        if (ctx === 'desktop') return item.type !== 'outdoor'; 
                        if (ctx === 'indoor')  return item.type === 'indoor'; 
                        if (ctx === 'outdoor') return item.type === 'outdoor'; 
                    }
                    return true;
                });
                if (validPool.length > 0) {
                    result = validPool[Math.floor(Math.random() * validPool.length)];
                }
            }
            currentTask = result;
            const ph = document.getElementById('placeholder');

            if (result) {
                if (ph) ph.style.display = 'none';
                if (mode === 'sos') {
                    renderResultCard(result);
                } else {
                    playGachaAnimation(result);
                }
            } else {
                if (ph) ph.style.display = 'none';
                renderResultCard(null);
            }
        }, 300);
    }

    // ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†ï¼šæ‰“å¼€æµ®å±‚
        function dimRitualButton(type) {
        if (!type) return;
        const selector = type === 'morning'
            ? '.ritual-icon-btn[data-ritual="morning"]'
            : '.ritual-icon-btn[data-ritual="night"]';
        const btn = document.querySelector(selector);
        if (btn) {
            btn.classList.add('dimmed');
        }
    }
function openRitual(type) {
    currentRitualType = type; // 'morning' or 'night'
    const overlay = document.getElementById('ritualOverlay');
    const titleEl = document.getElementById('ritualTitle');
    const iconEl  = document.getElementById('ritualIcon');
    const listEl  = document.getElementById('ritualSteps');
    if (!overlay || !titleEl || !listEl) return;

    const steps = type === 'morning' ? ritualMorningSteps : ritualNightSteps;

    // é¡¶éƒ¨å¤§å›¾æ ‡ + ç®€çŸ­æ ‡é¢˜
    if (iconEl) {
        iconEl.textContent = (type === 'morning') ? 'ğŸŒ…' : 'ğŸŒ™';
    }
    titleEl.textContent = (type === 'morning') ? 'èµ·åºŠèµ·é£' : 'ç¡å‰ç€é™†';


    // å…ˆæŠŠå…¶ä»–ç»“æœåŒºçŠ¶æ€éƒ½æ”¶èµ·æ¥
    const resultCard = document.getElementById('resultCard');
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');

    if (resultCard) resultCard.style.display = 'none';
    if (placeholder) placeholder.style.display = 'none';
    if (gachaLayer) gachaLayer.style.display = 'none';

    // æ¸…ç©ºå¹¶ç”Ÿæˆæ­¥éª¤ï¼ˆä¿æŒä½ ä¹‹å‰å‹¾é€‰é€»è¾‘ï¼‰
    listEl.innerHTML = '';
    steps.forEach((text, index) => {
        if (!text) return;
        const li = document.createElement('li');

        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '6px';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'ritual-step-checkbox';

        const span = document.createElement('span');
        span.textContent = text;

        label.appendChild(checkbox);
        label.appendChild(span);
        li.appendChild(label);
        listEl.appendChild(li);
    });

    // æ˜¾ç¤ºä»ªå¼å¡ç‰‡
    overlay.style.display = 'block';

    // ä»ªå¼ä¸æ˜¯â€œä»»åŠ¡æŠ½å¡â€ï¼Œæ‰€ä»¥æ¸…æ‰ currentTask
    if (typeof currentTask !== 'undefined') {
        currentTask = null;
    }
}

    // å…³é—­æµ®å±‚ï¼ˆä¸å†™å…¥è¶³è¿¹ï¼‰
    function closeRitual() {
    const overlay = document.getElementById('ritualOverlay');
    if (overlay) overlay.style.display = 'none';

    // ä»ªå¼ç»“æŸåï¼Œæ¢å¤é»˜è®¤å ä½ & æ‰­è›‹æœº
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');
    const resultCard = document.getElementById('resultCard');

    if (placeholder) placeholder.style.display = 'block';
    if (gachaLayer) gachaLayer.style.display = 'block';
    if (resultCard) resultCard.style.display = 'none';

    currentRitualType = null;
}


    // å®Œæˆä»ªå¼ï¼šåœ¨ä»Šæ—¥è¶³è¿¹å†™ä¸€æ¡è®°å½•
    function completeRitual() {
        if (!currentRitualType) {
            closeRitual();
            return;
        }

        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const icon = currentRitualType === 'morning' ? 'ğŸŒ…' : 'ğŸŒ™';
        const title = currentRitualType === 'morning' ? 'èµ·åºŠèµ·é£' : 'ç¡å‰ç€é™†';

        dailyLog.unshift({
            title: title,
            icon: icon,
            timeStr: timeStr,
            date: now.toDateString(),
            done: true
        });

        save();
        renderLog();
        if (typeof renderHistory === 'function') renderHistory();

               const overlay = document.getElementById('ritualOverlay');
    if (overlay) overlay.style.display = 'none';

    // å®Œæˆåæ¢å¤é»˜è®¤å ä½ & æ‰­è›‹æœº
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');
    const resultCard = document.getElementById('resultCard');

    if (placeholder) placeholder.style.display = 'block';
    if (gachaLayer) gachaLayer.style.display = 'block';
    if (resultCard) resultCard.style.display = 'none';

    // æœ¬æ¬¡ä¼šè¯å†…ï¼Œè®©å¯¹åº”çš„å°å›¾æ ‡æ·¡ä¸€äº›
    dimRitualButton(currentRitualType);

    showToast(icon === 'ğŸŒ…' ? 'ğŸŒ… èµ·é£å•¦ï¼' : 'ğŸŒ™ ç€é™†å®Œæˆ');
    currentRitualType = null;
}
   
function finishTask() {
        if (!currentTask) return;

        const card = document.getElementById('resultCard');
        const statusEl = document.getElementById('rStatus');
        const ingEl = document.getElementById('rIngPulse');

        // SOS æ¨¡å¼ï¼šåªé‡ç½®çŠ¶æ€ï¼Œä¸è®°å…¥è¶³è¿¹/è£èª‰æ®¿å ‚
        if (currentTask.type === 'sos') { 
            showToast("çŠ¶æ€é‡å¯ï¼ğŸŒ±"); 
            if (card) card.style.display = 'none'; 
            currentTask = null;
            if (typeof currentStatus !== 'undefined') currentStatus = 'idle';
            if (typeof anchorStartTime !== 'undefined') anchorStartTime = null;
            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            return; 
        }

        // å†™å…¥ã€Œä»Šæ—¥è¶³è¿¹ / å†å²è®°å½•ã€
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        dailyLog.unshift({ 
            title: currentTask.title, 
            icon: currentTask.icon || getSmartIcon(currentTask), 
            timeStr: timeStr, 
            date: now.toDateString(),
            done: true
        });

        // 1ï¼‰æ¯æ—¥å¾ªç¯ä»»åŠ¡ï¼šåªæ‰“å¡ï¼Œä¸å‡ºä»»åŠ¡æ± 
        if (currentTask.recurrence === 'daily') {
            const taskIndex = db.findIndex(t => t.id === currentTask.id);
            if (taskIndex > -1) db[taskIndex].lastDone = now.toDateString();
            renderLog(); 
            if (typeof renderHistory === 'function') renderHistory();
            save(); 
            renderList(); 
            showToast("âœ… ä»Šæ—¥æ‰“å¡æˆåŠŸï¼");
        } 
                // 2ï¼‰ä¹¦ / å½± / å‰§ ç­‰ culture ç±»ï¼š
        //    - ç”µå½±ï¼ˆéç³»åˆ—ï¼‰ï¼šä¸€æ¬¡æ€§çœ‹å®Œå‹ï¼Œè¯¢é—®æ˜¯å¦å½»åº•çœ‹å®Œ
        //    - ä¹¦ / æ‚å¿— / å‰§é›†ç­‰é•¿çº¿å†…å®¹ï¼šæ¯æ¬¡å®Œæˆä¸€å°èŠ‚ï¼Œéƒ½åœ¨è£èª‰æ®¿å ‚è®°ä¸€ç¬”ï¼Œä½†ä»»åŠ¡ç»§ç»­ç•™åœ¨åª’ä½“ç¯®
        else if (currentTask.type === 'culture') {
            const subtype = currentTask.subtype || null;
            const icon = currentTask.icon || getSmartIcon(currentTask);
            const isSeries = !!currentTask.isSeries;

            // âœ… æŠŠâ€œç”µå½±â€çš„åˆ¤æ–­æ”¾å®½ï¼š
            // 1ï¼‰subtype === 'movie'
            // 2ï¼‰æˆ–è€… å›¾æ ‡å°±æ˜¯ ğŸ¬
            const isMovie = (subtype === 'movie') || icon === 'ğŸ¬';

            // ğŸ¬ ç”µå½±ï¼ˆéç³»åˆ—ï¼‰ï¼šä¸€æ¬¡æ€§çœ‹å®Œ
            if (isMovie && !isSeries) {
                const ok = confirm(`ã€Š${currentTask.title}ã€‹è¿™éƒ¨ç”µå½±å½»åº•çœ‹å®Œäº†å—ï¼Ÿ\n[ç¡®å®š]=å½’æ¡£ [å–æ¶ˆ]=ä»…è®°å½•æœ¬æ¬¡è§‚çœ‹`);
                if (ok) {
                    // å®Œæ•´çœ‹å®Œï¼šä»ä»»åŠ¡æ± åˆ é™¤ï¼Œå¹¶è¿›å…¥è£èª‰æ®¿å ‚
                    db = db.filter(t => t.id !== currentTask.id);
                    archive.unshift({
                        ...currentTask,
                        finishDate: now.toLocaleDateString()
                    });
                    save();
                    renderList();
                    renderArchive();
                    showToast("ğŸ† å·²å½’æ¡£");
                } else {
                    // åªè®°å½•åˆ°ä»Šæ—¥è¶³è¿¹ï¼Œä½†è§†ä¸ºâ€œå°šæœªå®Œå…¨çœ‹å®Œâ€ï¼Œä¸æ‰“ âœ…
                    if (Array.isArray(dailyLog) && dailyLog.length > 0) {
                        dailyLog[0].done = false;
                    }
                    save();
                    renderLog();
                    showToast("ğŸ¬ å·²è®°å½•åˆ°ä»Šæ—¥è¶³è¿¹");
                }
            } else {
                // ğŸ“š ä¹¦ / æ‚å¿— / å‰§é›† / å…¶ä»–é•¿çº¿æ–‡åŒ–å†…å®¹ï¼š
                // ä¸ä»åª’ä½“ç¯®ç§»é™¤ï¼Œåªåœ¨è£èª‰æ®¿å ‚è®°è¿›åº¦
                archive.unshift({
                    ...currentTask,
                    finishDate: now.toLocaleDateString()
                });
                save();
                renderArchive();
                showToast("ğŸ“š å·²è®°å½•åˆ°è£èª‰æ®¿å ‚");
            }
        } 

        // 3ï¼‰æ™®é€šä»»åŠ¡ï¼šå®Œæˆåä»ä»»åŠ¡æ± åˆ é™¤ï¼›
        //    å¦‚æœæ˜¯é‡è¦ä»»åŠ¡ï¼ˆé’è›™ï¼‰ï¼ŒåŒæ—¶æ”¾å…¥è£èª‰æ®¿å ‚ï¼ˆé‡è¦ä»»åŠ¡åˆ†åŒºï¼‰
        else {
            db = db.filter(i => i.id !== currentTask.id);

            if (currentTask.isFrog) {
                archive.unshift({
                    title: currentTask.title,
                    type: 'important',
                    isFrog: true,
                    icon: currentTask.icon || getSmartIcon(currentTask),
                    finishDate: now.toLocaleDateString()
                });
            }

            save(); 
            renderList(); 
            renderArchive();
            showToast(currentTask.isFrog ? "ğŸ… é‡è¦ä»»åŠ¡å·²åŠ å…¥è£èª‰æ®¿å ‚ï¼" : "âœ¨ å®Œæˆï¼");
        }

        // ç»Ÿä¸€åˆ·æ–°è¶³è¿¹ & å†å²
        renderLog();
        if (typeof renderHistory === 'function') renderHistory();

        // æ”¶èµ·å¡ç‰‡ & æ¸…ç©ºé”šç‚¹çŠ¶æ€
        if (card) card.style.display = 'none';
        if (statusEl) statusEl.style.display = 'none';
        if (ingEl) ingEl.style.display = 'none';
        currentTask = null;
        if (typeof currentStatus !== 'undefined') currentStatus = 'idle';
        if (typeof anchorStartTime !== 'undefined') anchorStartTime = null;
    }


    function recordLog() { renderLog(); }


    function autoTag() {
    const inp = document.getElementById('inpTitle');
    if (!inp) return;

    const raw = inp.value;
    const lines = raw.split('\n');
    const targetLine = lines[0] || "";
    const v = targetLine;
    const trimmed = v.trim();
    const tags = document.querySelectorAll('.tag');

    // === 1. æ—¶é—´è¯†åˆ«æç¤ºï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ ===
    const parsed = parseTimeFromInput(targetLine);
    const feedback = document.getElementById('timeFeedback');
    if (parsed.time) {
        feedback.innerText = `ğŸ’¡ è¯†åˆ«: ${parsed.time} min`;
    } else {
        feedback.innerText = "";
    }

    // === 2. è‡ªåŠ¨è¯†åˆ«â€œæ¯æ—¥å¾ªç¯â€ ===
    if (targetLine.includes("æ¯å¤©") || targetLine.includes("æ¯æ—¥")) {
        if (!isCycleActive) toggleCycle(true);
    }

    // === 3. é¦–å­—è§„åˆ™ + å…³é”®è¯å…œåº• ===
    let t = null;                // è¦æ¿€æ´»çš„æ ‡ç­¾ç±»å‹
    let detectQuick = false;     // æ˜¯å¦æ˜¯â€œå®¶åŠ¡é€ŸåŠå€™é€‰â€
    const firstChar = trimmed.charAt(0) || '';

    // ç‰¹æ®Šï¼šæ•´ç†ç…§ç‰‡ï¼ˆä¸ç®—é€ŸåŠï¼‰
    const isPhotoSort = trimmed.includes('æ•´ç†') && trimmed.includes('ç…§ç‰‡');

    // 3.1 é¦–å­—è§„åˆ™
    if (firstChar === 'çœ‹' || firstChar === 'å½±') {
        // çœ‹ / å½± å¼€å¤´ â†’ çœ‹ä½œå“ï¼ˆç”µå½±ï¼‰ï¼Œå½’ä¹¦å½±ç±»
        t = 'culture';
    } else if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
        // è¯» / ä¹¦ å¼€å¤´ â†’ é˜…è¯»ç±»
        t = 'culture';
    } else if (firstChar === 'è¿½' || firstChar === 'å‰§') {
        // è¿½ / å‰§ å¼€å¤´ â†’ å¤§æ¦‚ç‡æ˜¯åœ¨è¿½å‰§
        t = 'culture';
    } else if (firstChar === 'å»') {
        // å» å¼€å¤´ â†’ å¤–å‡ºä»»åŠ¡
        t = 'outdoor';
    } else {
        // 3.2 å…³é”®è¯å…œåº•ï¼ˆåªåœ¨æ²¡å‘½ä¸­é¦–å­—è§„åˆ™æ—¶ç”¨ï¼‰
        // å®¶åŠ¡ / å®¤å†…ï¼ˆæ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰å•ç‹¬çš„â€œç†â€ï¼‰
        if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) {
            t = 'indoor';
            detectQuick = true;
        }
        // å”± / å¬ â†’ å”±ç‰‡æˆ–éŸ³é¢‘
        else if (v.includes('å”±') || v.includes('å¬')) {
            t = 'vinyl';
        }
        // é˜…è¯»å…³é”®è¯
        else if (v.includes('ä¹¦') || v.includes('è¯»') || v.includes('æ‚å¿—')) {
            t = 'culture';
        }
        // å½±è§†å…³é”®è¯
        else if (v.includes('ç”µå½±') || v.includes('å½±') || v.includes('å‰§') || v.includes('ç‰‡')) {
            t = 'culture';
        }
        // è¿åŠ¨ç›¸å…³
        else if (v.includes('åŠ¨') || v.includes('è·‘') || v.includes('çƒ') || v.includes('èˆ') || v.includes('æ“')) {
            t = 'sport';
        }
        // ä¹°ä¸œè¥¿ / å‡ºå»åŠäº‹
        else if (v.includes('ä¹°') || v.includes('å¤–') || v.includes('è¶…å¸‚') || v.includes('å•†åœº') || v.includes('å–å¿«é€’') || v.includes('å¯„å¿«é€’')) {
            t = 'outdoor';
        }
        // å†™ä½œ / ç ”ç©¶ / ç¼–è¾‘ â†’ æ¡Œå‰è„‘åŠ›
        else if (v.includes('è„‘') || v.includes('å†™') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) {
            t = 'desktop';
        }
    }

    // === 4. åº”ç”¨è‡ªåŠ¨æ ‡ç­¾é«˜äº® ===
    if (t) {
    tags.forEach(tag => tag.classList.remove('active'));

    let selector = `.tag[data-v="${t}"]`;

    // å¦‚æœæ˜¯ä¹¦å½±ç±»ï¼Œæ ¹æ®é¦–å­—é€‰ ğŸ“– / ğŸ¬ / ğŸ“º
    if (t === 'culture') {
        const firstChar = trimmed.charAt(0) || '';
        let sub = 'book'; // é»˜è®¤ä¹¦

        if (firstChar === 'çœ‹' || firstChar === 'å½±') {
            sub = 'movie';
        } else if (firstChar === 'è¿½' || firstChar === 'å‰§' || /ç¬¬.+é›†/.test(trimmed)) {
            sub = 'series';
        } else if (trimmed.includes('æ‚å¿—') || trimmed.includes('å‘¨åˆŠ')) {
            sub = 'book';
        }

        selector = `.tag[data-v="culture"][data-sub="${sub}"]`;
    }

    const activeTag = document.querySelector(selector) || document.querySelector(`.tag[data-v="${t}"]`);
    if (activeTag) activeTag.classList.add('active');

    toggleTimeInput(t);
}

    // === 5. è‡ªåŠ¨é€ŸåŠé€»è¾‘ ===
    // åªå¯¹â€œå®¶åŠ¡ç±»å…³é”®è¯â€è§¦å‘ï¼Œå¹¶ä¸”æ’é™¤â€œæ•´ç†ç…§ç‰‡â€
    if (!isPhotoSort && detectQuick) {
        toggleSwitch('flash', true);
        const sel = document.getElementById('inpTime');
        if (sel) sel.value = "5";
    } else if (isPhotoSort) {
        // æ•´ç†ç…§ç‰‡ï¼šç¡®ä¿ä¸æ˜¯é€ŸåŠï¼Œé»˜è®¤ 30min
        toggleSwitch('flash', false);
        const sel = document.getElementById('inpTime');
        if (sel) sel.value = "30";
    }
}

    function pickTag(el) { 
        document.querySelectorAll('.tag').forEach(t => t.classList.remove('active')); 
        el.classList.add('active'); 
        toggleTimeInput(el.dataset.v); 
    }

    function toggleTimeInput(type) { 
        const sel = document.getElementById('inpTime'); 
        if (type === 'vinyl' || type === 'culture') sel.classList.add('disabled'); 
        else sel.classList.remove('disabled'); 
    }

    // â­ ä¿®æ”¹ï¼šå¢åŠ  userOverrideFlash é€»è¾‘ + å…³é—­é€ŸåŠæ—¶è‡ªåŠ¨æŠŠæ—¶é—´è°ƒå› 30m
    function toggleSwitch(type, forceState) { 
        const isUserAction = (forceState === undefined);
        const newState = (forceState !== undefined) ? forceState : !switchState[type]; 
        switchState[type] = newState; 
        const sw = document.getElementById(type + 'Switch'); 
        const activeClass = (type === 'cycle') ? 'active-cycle' : 'active-flash'; 
        if (newState) sw.classList.add(activeClass); else sw.classList.remove(activeClass); 

        if (type === 'flash') {
    const sel = document.getElementById('inpTime');
    if (isUserAction) {
        // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å¼€çš„/ç‚¹æ‰çš„é€ŸåŠï¼Œæ ‡è®°ä¸ºâ€œç”¨æˆ·è¦†ç›–â€
        userOverrideFlash = true;

        if (sel) {
            if (newState) {
                // âœ… ç”¨æˆ·æ‰‹åŠ¨å¼€å¯é€ŸåŠï¼šæ—¶é—´æ”¹æˆ 5m
                sel.value = "5";
            } else {
                // âœ… ç”¨æˆ·æ‰‹åŠ¨å…³é—­é€ŸåŠï¼šæ—¶é—´æ¢å¤é»˜è®¤ 30m
                sel.value = "30";
            }
        }
    } else {
        // ç¨‹åºè‡ªåŠ¨æ§åˆ¶é€ŸåŠï¼ˆä¾‹å¦‚å…³é”®è¯è¯†åˆ«æˆ–å­˜å…¥åé‡ç½®ï¼‰
        if (newState) {
            // è‡ªåŠ¨å¼€å¯é€ŸåŠæ—¶ä¸è®¤ä¸ºç”¨æˆ·è¦†ç›–
            userOverrideFlash = false;
        } else {
            // è‡ªåŠ¨å…³é—­æ—¶ä¹Ÿæ¸…æ‰è¦†ç›–æ ‡è®°
            userOverrideFlash = false;
        }
    }
}
}

    let isCycleActive = false;
    function toggleCycle(forceOn) { 
        const desired = (forceOn === true) ? true : !isCycleActive;
        isCycleActive = desired;
        toggleSwitch('cycle', desired);
    }

    // ä¿®å¤ç‰ˆ addNewï¼ˆä¸å‰ä¸€ç‰ˆä¿æŒä¸€è‡´ï¼Œåªä¿®ä¸¤ä¸ª bugï¼‰
    function addNew() {
        const rawInput = document.getElementById('inpTitle').value; 
        if(!rawInput || rawInput.trim() === "") return;
        let lines = rawInput.split('\n').filter(line => line.trim() !== ""); 
        const type = document.querySelector('.tag.active').dataset.v; 
        let addedCount = 0; 
        let batchSubtype = ''; 

        if (lines.length > 0) { 
            const firstRaw = lines[0];
            const first = firstRaw.toLowerCase(); 
            const isCleaning = /(ç†|æ•´ç†|æ”¶æ‹¾|æ“¦|æ‰«|æ‹–|æ´—|æ¢|å |é“º|æŒ‚|æ‰”|æ‹†|è£…|å–)/.test(firstRaw); 
            if (!isCleaning) { 
                const firstChar = firstRaw.charAt(0) || '';
                // é¦–å­—ä¼˜å…ˆï¼šè¯» / ä¹¦ å¼€å¤´ä¸€å¾‹å½“ä¹¦ç±
                if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
                    batchSubtype = 'book';
                }
                // çœ‹ / å½± å¼€å¤´ä¼˜å…ˆå½“ç”µå½±
                else if (firstChar === 'çœ‹' || firstChar === 'å½±') {
                    batchSubtype = 'movie';
                }
                // å¦åˆ™å†ç”¨åŒ…å«å…³ç³»åšå…œåº•
                else if (['è¯»', 'ä¹¦', 'é˜…', 'book', 'read', 'æ‚å¿—'].some(k => first.includes(k))) {
                    batchSubtype = 'book';
                } else if (['çœ‹', 'å½±', 'è§†', 'ç‰‡', 'movie'].some(k => first.includes(k))) {
                    batchSubtype = 'movie';
                }
                // â­ ä¿®æ”¹ç‚¹ 1ï¼šåªæœ‰åœ¨â€œç¡®å®æ˜¯æ‰¹é‡æ¨¡å¼â€ï¼ˆå¤šè¡Œï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‰æŠŠç¬¬ä¸€è¡Œå½“ä½œæŒ‡ä»¤è¡Œæ¸…æ´—æ‰
                if (batchSubtype && first.length <= 4 && lines.length > 1) lines.shift(); 
            } 
        }

        lines.forEach(line => {
            const parsed = parseTimeFromInput(line); 
            let title = parsed.title; 
            let timeVal = parsed.time; 
            let subtype = batchSubtype;

            let isFrog = false; 
            // é‡è¦äº‹é¡¹æ ‡è®°ï¼šæ”¯æŒ è¡Œé¦– * / ï¼Š / ! / ï¼ / â€œé‡è¦ â€
            let rawTitle = title.trimStart();
            const importantMarkers = ['*', 'ï¼Š', '!', 'ï¼'];
            if (importantMarkers.some(m => rawTitle.startsWith(m))) {
                isFrog = true;
                rawTitle = rawTitle.substring(1).trim();
            } else if (rawTitle.startsWith('é‡è¦')) {
                isFrog = true;
                rawTitle = rawTitle.replace(/^é‡è¦\s*/, '').trim();
            }
            title = rawTitle;

            // â­ ä¿®æ”¹ç‚¹ 2ï¼ˆæ ¸å¿ƒï¼‰ï¼šå¦‚æœç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è¦†ç›–é€ŸåŠï¼Œåˆ™å…è®¸å…³é”®è¯/æ—¶é—´è‡ªåŠ¨åˆ¤å®šï¼›
            // ä¸€æ—¦ userOverrideFlash ä¸º trueï¼Œå°±å®Œå…¨å°Šé‡å½“å‰å¼€å…³çŠ¶æ€ï¼Œä¸å†è¢«â€œæ•´ç†â€ç­‰å…³é”®è¯å¼ºåˆ¶æ‹‰å›é€ŸåŠã€‚
            let isQuick = switchState.flash;

/**
 * é‡è¦æ”¹åŠ¨ï¼š
 * 1ï¼‰åªå¯¹ã€Œå®¤å†…å®¶åŠ¡ã€å°è¯•è‡ªåŠ¨é€ŸåŠ â†’ type å¿…é¡»æ˜¯ 'indoor'
 * 2ï¼‰å»æ‰å•ç‹¬çš„ã€Œç†ã€ï¼Œé¿å…â€œå¿ƒç†åŒ»ç”Ÿâ€è¢«è¯¯åˆ¤æˆæ‰“æ‰«
 */
if (!userOverrideFlash) {
    if (!isQuick) {
        const isPhotoSort = title.includes('æ•´ç†') && title.includes('ç…§ç‰‡');

        // åªæœ‰ã€Œå®¤å†…ã€ä»»åŠ¡æ‰ä¼šè§¦å‘å®¶åŠ¡é€ŸåŠé€»è¾‘
        if (
            !isPhotoSort &&
            type === 'indoor' &&
            /(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(title)
        ) {
            isQuick = true;
        }

        // å¦‚æœç”¨æˆ·è‡ªå·±å†™äº† 5m/5åˆ†é’Ÿï¼Œä¹Ÿè®¤ä¸ºæ˜¯é€ŸåŠ
        if (timeVal && timeVal <= 5) isQuick = true;
    }
}

            if (!timeVal) { 
                timeVal = parseInt(document.getElementById('inpTime').value); 
                if (type === 'vinyl' && !isQuick) timeVal = 0; 
                else if (type === 'culture' && !isQuick) { 
                    if (subtype === 'movie') timeVal = 120; 
                    else timeVal = 0; 
                } 
            }

            if (isQuick && (!timeVal || timeVal > 15)) timeVal = 5;

            if (!isQuick && !subtype && type === 'culture') {
    const t = (title || "").trim();
    const firstChar = t.charAt(0) || '';

    // 1. é¦–å­—ä¼˜å…ˆï¼šä½ æ˜¯â€œè¯»/ä¹¦â€è¿˜æ˜¯â€œçœ‹/å½±â€å¼€å¤´
    if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
        subtype = 'book';
    } else if (firstChar === 'çœ‹' || firstChar === 'å½±') {
        subtype = 'movie';
    } else {
        // 2. é¦–å­—ä¸æ˜¯è¯»/çœ‹ï¼Œå†ç”¨å†…å®¹å…œåº•ï¼š
        //    å…ˆçœ‹â€œä¹¦â€çš„ç—•è¿¹
        if (
            t.includes('ä¹¦') ||
            t.includes('è¯»') ||
            t.includes('é˜…') ||
            t.includes('æ‚å¿—') ||
            t.includes('å‘¨åˆŠ')
        ) {
            subtype = 'book';
        }
        // 3. å®åœ¨ä¸åƒä¹¦ï¼Œå†çœ‹æ˜¯å¦åƒç”µå½±
        else if (
            t.includes('ç”µå½±') ||
            t.includes('å½±') ||
            t.includes('ç‰‡')
        ) {
            subtype = 'movie';
        }
        // 4. éƒ½ä¸åƒå°±ä¿æŒ subtype = nullï¼Œç”¨ä¸­æ€§å›¾æ ‡ï¼Œè®©ä½ æ‰‹åŠ¨åˆ¤æ–­
    }
}

            // å…ˆæ‹¿ä¸€ä»½â€œç”¨äºåˆ¤å®šå‰§é›†â€çš„åŸå§‹æ ‡é¢˜ï¼šå»æ‰å»/çœ‹/è¯»/å¬/åšï¼Œä½†è¿˜æ²¡åŠ ã€Šã€‹
            const rawForSeries = title.replace(/^(å»|çœ‹|è¯»|å¬|åš)\s*/, '').trim();

            let isSeries = false;
            if (type === 'culture') {
                const firstCharSeries = rawForSeries.charAt(0) || '';

                // 1. é¦–å­—åˆ¤å®šï¼šè¿½å‰§ / å‰§ å¼€å¤´
                if (firstCharSeries === 'è¿½' || firstCharSeries === 'å‰§') {
                    isSeries = true;
                }

                // 2. å†…å®¹å…œåº•ï¼šå…¨é›† / ç³»åˆ— / ç¬¬Xé›†...
                if (
                    rawForSeries.includes('å…¨é›†') ||
                    rawForSeries.includes('ç³»åˆ—') ||
                    /ç¬¬.+é›†/.test(rawForSeries)
                ) {
                    isSeries = true;
                }
            }

                        // å†æŠŠ title è§„èŒƒæˆæœ€ç»ˆå±•ç¤ºç”¨æ ·å¼ï¼ˆè¿™é‡Œé¡ºæ‰‹æŠŠâ€œè¿½ / å‰§â€å‰ç¼€æ¸…æ´—æ‰ï¼‰
            let displayTitle = rawForSeries;

            // å¦‚æœæ˜¯ä¹¦å½±ç±» & è¢«è¯†åˆ«ä¸ºå‰§é›†ï¼Œå°±æŠŠå¼€å¤´çš„â€œè¿½ / å‰§â€å»æ‰
            if (type === 'culture' && isSeries && (displayTitle.startsWith('è¿½') || displayTitle.startsWith('å‰§'))) {
                displayTitle = displayTitle.slice(1).trim();
            }

            title = displayTitle;

            if (!isQuick && (type === 'culture' || type === 'vinyl')) { 
                if (title && !title.startsWith('ã€Š') && !title.endsWith('ã€‹')) {
                    title = `ã€Š${title}ã€‹`; 
                }
            }

            
            let recurrence = switchState.cycle ? 'daily' : 'none'; 
            if (recurrence === 'none' && (title.includes('æ¯å¤©') || title.includes('æ¯æ—¥'))) { recurrence = 'daily'; }
            if (recurrence === 'daily') title = title.replace(/æ¯å¤©|æ¯æ—¥/g, '').trim();

            db.push({ 
                id: Date.now() + Math.floor(Math.random() * 10000), 
                title: title, type: type, subtype: subtype, 
                desc: isSeries ? "ç³»åˆ—" : (recurrence === 'daily' ? "æ¯æ—¥ä»»åŠ¡" : ""), 
                isSeries: isSeries, time: timeVal, recurrence: recurrence, 
                isFrog: isFrog, isQuick: isQuick, lastDone: '' 
            }); 
            addedCount++;
        });

        save(); renderList(); 
        const input = document.getElementById('inpTitle'); 
        input.value = ''; 
        input.placeholder = "âœ… å­˜å…¥æˆåŠŸï¼"; 
        document.getElementById('timeFeedback').innerText = ""; 
        if(switchState.cycle) toggleSwitch('cycle', false); 
        if(switchState.flash) toggleSwitch('flash', false); 
        showToast(`ğŸ‰ å­˜å…¥ ${addedCount} ä¸ªä»»åŠ¡ï¼`); 
        setTimeout(() => input.placeholder = "è¾“å…¥äº‹é¡¹...", 1500);
    }
    
    function tryDeleteItem(id) { 
        if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) { 
            db = db.filter(item => item.id !== id); 
            save(); renderList(); showToast("ğŸ—‘ï¸ å·²åˆ é™¤"); 
        } 
    }
       // ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨é‡Œçš„å†°å—ï¼šæ‰“å¼€å¼¹çª—ï¼Œåç»­å…·ä½“æ“ä½œåœ¨ confirmColdAction é‡Œæ‰§è¡Œ
    function handleColdOrDelete(id) {
        const item = db.find(t => t.id === id);
        if (!item) return;
        pendingColdId = id;

        const dlg = document.getElementById('coldDialog');
        if (dlg) {
            dlg.style.display = 'flex';
        }
    }
    // å¼¹çª—ä¸­ç‚¹å‡»ä¸‰ä¸ªæŒ‰é’®ä¹‹ä¸€ï¼šdelete / cold / cancel
    function confirmColdAction(action) {
        const dlg = document.getElementById('coldDialog');
        if (dlg) {
            dlg.style.display = 'none';
        }

        const id = pendingColdId;
        pendingColdId = null;
        if (!id) return;

        if (action === 'cold') {
            // ç›´æ¥ç§»å…¥å†·åº“
            moveToColdStorage(id);
            } else if (action === 'delete') {
        // åˆ é™¤å†åšä¸€æ¬¡ç¡®è®¤ï¼Œé¿å…è¯¯åˆ 
        const ok = confirm("ç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡ä»»åŠ¡å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚");
        if (ok) {
            // è¿™é‡Œç›´æ¥åˆ é™¤ï¼Œä¸å†èµ° tryDeleteItemï¼ˆé¿å…å†å¼¹ä¸€æ¬¡ç¡®è®¤ï¼‰
            db = db.filter(item => item.id !== id);
            save();
            renderList();
            showToast("ğŸ—‘ï¸ å·²åˆ é™¤");
            }
        } else {
            // cancelï¼šä»€ä¹ˆéƒ½ä¸åš
            return;
        }
    }


   function moveToColdStorage(id) {
    const item = db.find(t => t.id === id);
    if (!item) return;
    item.inColdStorage = true;
    save();
    renderList();
    showToast("ğŸ§Š å·²ç§»å…¥å†·åº“");
}


    function restoreFromColdStorage(id) {
        const item = db.find(t => t.id === id);
        if (!item) return;
        item.inColdStorage = false;
        save();
        renderList();
        showToast("â™»ï¸ å·²ä»å†·åº“èµ¦å…");
    }

    function deleteArchiveItem(index) {
        if (index < 0 || index >= archive.length) return;
        if (!confirm("ç¡®å®šä»è£èª‰æ®¿å ‚åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
        archive.splice(index, 1);
        save();
        renderArchive();
        showToast("ğŸ—‘ï¸ å·²åˆ é™¤");
    }

    function tryResetAll() { 
        if(confirm("âš ï¸ ç¡®å®šæ¸…ç©ºï¼Ÿ")) { 
            db = []; archive = []; dailyLog = []; userStats = { willpower: 0, joy: 0 }; 
            save(); renderList(); renderArchive(); renderLog(); renderHistory(); updateStatsUI(); showToast("å·²æ ¼å¼åŒ–"); 
        } 
    }

    // å¯¼å…¥/å¯¼å‡ºé€»è¾‘ä¿æŒåŸæ ·
    function executeImport() {
        const str = document.getElementById('dataArea').value;
        if (!str || str.trim().length === 0) { alert("âš ï¸ è¯·å…ˆç²˜è´´ä»£ç ï¼"); return; }
        try {
            const json = JSON.parse(str);
            let incomingDB = json.db || (Array.isArray(json) ? json : []);
            let incomingArchive = json.archive || [];
            let incomingStats = json.userStats || {};
            if (!Array.isArray(incomingDB)) throw new Error("æ ¼å¼é”™è¯¯");
            if(confirm(`ğŸ“¡ æ‰¾åˆ° ${incomingDB.length} ä¸ªä»»åŠ¡ã€‚\n\nç¡®å®šè¦åˆå¹¶å—ï¼Ÿ`)) {
                 let addCount = 0;
                 incomingDB.forEach(newItem => {
                    const exists = db.some(e => e.title === newItem.title && e.type === newItem.type);
                    if (!exists) { 
                        newItem.id = Date.now() + Math.floor(Math.random()*10000); 
                        if (newItem.time === undefined) newItem.time = 30; 
                        db.push(newItem); 
                        addCount++; 
                    }
                 });
                 incomingArchive.forEach(newArc => { 
                    const arcExists = archive.some(a => a.title === newArc.title); 
                    if(!arcExists) archive.unshift(newArc); 
                 });
                 if (incomingStats.willpower) userStats.willpower = Math.max(userStats.willpower, incomingStats.willpower);
                 if (incomingStats.joy) userStats.joy = Math.max(userStats.joy, incomingStats.joy);
                 save(); renderList(); renderArchive(); updateStatsUI();
                 alert(`âœ… æˆåŠŸåˆå¹¶ ${addCount} ä¸ªæ–°ä»»åŠ¡ï¼`);
                 document.getElementById('dataArea').value = "";
            }
        } catch(e) { alert(`âŒ å¯¼å…¥å¤±è´¥ï¼š${e.message}`); }
    }

    function triggerImport() { document.getElementById('fileInput').click(); }

    function importFromFile(input) { 
        const file = input.files[0]; if(!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            document.getElementById('dataArea').value = e.target.result; 
            executeImport(); 
        }; 
        reader.readAsText(file); 
    }
    // ä»ç¼–è¾‘æ¡†ä¿å­˜èµ·é£ / ç€é™†ä»ªå¼åˆ°æœ¬åœ°
    function saveRitualFromInputs() {
        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (!inputMorning || !inputNight) return;

        const mLines = inputMorning.value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean);   // å»æ‰ç©ºè¡Œ
        const nLines = inputNight.value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean);

        // å¦‚æœç”¨æˆ·å…¨åˆ ç©ºï¼Œå°±é€€å›é»˜è®¤æ¨¡æ¿ï¼Œé¿å…å‡ºç°â€œç©ºä»ªå¼â€
        ritualMorningSteps = mLines.length ? mLines : ritualMorningDefault.slice();
        ritualNightSteps   = nLines.length ? nLines : ritualNightDefault.slice();

        try {
            localStorage.setItem(KEY_RITUAL_MORNING, JSON.stringify(ritualMorningSteps));
            localStorage.setItem(KEY_RITUAL_NIGHT,  JSON.stringify(ritualNightSteps));
        } catch (e) {
            console.warn('ä¿å­˜ä»ªå¼è®¾ç½®å‡ºé”™', e);
        }

        showToast('ğŸ“ å·²æ›´æ–°èµ·é£ / ç€é™†ä»ªå¼');
    }

    // æ¢å¤ä¸ºé»˜è®¤æ¨¡æ¿
    function resetRitualToDefault() {
        ritualMorningSteps = ritualMorningDefault.slice();
        ritualNightSteps   = ritualNightDefault.slice();

        try {
            localStorage.removeItem(KEY_RITUAL_MORNING);
            localStorage.removeItem(KEY_RITUAL_NIGHT);
        } catch (e) {}

        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (inputMorning) inputMorning.value = ritualMorningSteps.join('\n');
        if (inputNight)   inputNight.value   = ritualNightSteps.join('\n');

        showToast('âœ¨ å·²æ¢å¤é»˜è®¤ä»ªå¼');
    }

    function exportToFile() { 
        const allData = { db, archive, dailyLog, userStats }; 
        const blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"}); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = "anchor_backup_" + new Date().toISOString().slice(0,10) + ".json"; 
        a.click(); 
    }

    function copyToClip() { 
        const str = JSON.stringify({ db, archive, dailyLog, userStats }); 
        if (navigator.clipboard && navigator.clipboard.writeText) { 
            navigator.clipboard.writeText(str)
                .then(()=> alert("âœ… å·²å¤åˆ¶"))
                .catch(()=>{ 
                    document.getElementById('dataArea').value=str; 
                    alert("âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); 
                }); 
        } else { 
            document.getElementById('dataArea').value=str; 
            alert("âš ï¸ è¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); 
        } 
    }

    // æ ¹æ® APP_VARIANT è°ƒæ•´ UIï¼ˆpersonal / commonï¼‰
function applyVariant() {
    if (typeof APP_VARIANT === 'undefined') return;

    // 1ï¼‰æ ¹æ® variant ç»™ body åŠ  classï¼Œæ–¹ä¾¿ CSS åŒºåˆ†é…è‰²
    document.body.classList.remove('variant-personal', 'variant-common');
    document.body.classList.add(APP_VARIANT === 'common' ? 'variant-common' : 'variant-personal');

    // 2ï¼‰åŸæ¥çš„å”±ç‰‡å…¥å£æ˜¾éšé€»è¾‘
    var vinylTab = document.getElementById('mode-tab-vinyl');
    if (vinylTab) {
        vinylTab.style.display = (APP_VARIANT === 'common') ? 'none' : '';
    }
    var vinylTag = document.getElementById('tag-vinyl');
    if (vinylTag) {
        vinylTag.style.display = (APP_VARIANT === 'common') ? 'none' : '';
    }
}

/* --- é¡µé¢è½½å…¥åè‡ªåŠ¨é€‰æ‹©ç­›é€‰é»˜è®¤å€¼ --- */
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById("selContext");
    const time = document.getElementById("selTime");
    if (ctx) ctx.value = "desktop";  // ä¹¦æ¡Œå‰
    if (time) time.value = "120";    // 2å°æ—¶+
});


</script>
</body>
</html>

