<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anchor</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIyIiBmaWxsPSIjRkZDOEQxIi8+PHBhdGggZmlsbD0id2hpdGUiIGQ9Ik01MCAyMGMtMyAwLTYgMy02IDYgMCAzIDMgNiA2IDYgMyAwIDYtMyA2LTYgMC0zLTMtNi02LTZ6bS0yIDEzdjQ3Yy0xNS0yLTI2LTE0LTI4LTI5aC01YzIgMTcgMTYgMzEgMzMgMzFzMzEtMTQgMzMtMzFoLTVjLTIgMTUtMTMgMjctMjggMjlWMzNoLTh2NGg4djFoLTh2LTVoOHoiLz48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTQ0IDgxbDYgNiA2LTZoLTEyeiIvPjwvc3ZnPg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIyIiBmaWxsPSIjRkZDOEQxIi8+PHBhdGggZmlsbD0id2hpdGUiIGQ9Ik01MCAyMGMtMyAwLTYgMy02IDYgMCAzIDMgNiA2IDYgMyAwIDYtMyA2LTYgMC0zLTMtNi02LTZ6bS0yIDEzdjQ3Yy0xNS0yLTI2LTE0LTI4LTI5aC01YzIgMTcgMTYgMzEgMzMgMzFzMzEtMTQgMzMtMzFoLTVjLTIgMTUtMTMgMjctMjggMjlWMzNoLTh2NGg4djFoLTh2LTVoOHoiLz48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTQ0IDgxbDYgNiA2LTZoLTEyeiIvPjwvc3ZnPg==">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- ğŸ¨ Anchor v4.6 æ ·å¼ --- */
        :root {
            --bg-blue: #f0f4ff;
            --bg-pink: #ffeef3;
            --bg-card: #ffffff;
            --border-soft: #e6ecff;
            --accent: #ff9aa2;
            --accent-soft: #ffe1e6;
            --text-main: #333;
            --text-sub: #777;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, #fff5f8 0, #f5f7ff 60%, #f5f5f5 100%);
            color: var(--text-main);
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px 16px 28px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .version-badge {
            font-size: 0.75rem;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(0,0,0,0.04);
            margin-left: 6px;
            color: #666;
        }

        .btn-icon {
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 999px;
            transition: background 0.1s;
        }
        .btn-icon:active {
            background: rgba(0,0,0,0.04);
        }

        .section-filter {
            background-color: var(--bg-blue);
            padding: 16px 14px 18px;
            border-radius: 18px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(105,135,255,0.16);
        }

        .filter-title {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 4px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .select-soft {
            flex: 1;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.95);
            font-size: 0.9rem;
            outline: none;
        }

        .mode-switch {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .mode-btn {
            border-radius: 999px;
            border: none;
            padding: 5px 10px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.8);
            cursor: pointer;
            color: #555;
        }

        .mode-btn.active {
            background: #fff;
            color: #4a5cff;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .section-main {
            margin-top: 10px;
            margin-bottom: 12px;
        }

        .section-main-title {
            font-size: 0.9rem;
            color: #444;
            margin-bottom: 6px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 9px;
            border-radius: 999px;
            font-size: 0.8rem;
            border: 1px solid #eee;
            background: #fafafa;
            cursor: pointer;
            color: #555;
        }
        .tag.active {
            background: #4a5cff;
            color: #fff;
            border-color: #4a5cff;
        }

        .switch-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .switch {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px 2px 3px;
            border-radius: 999px;
            background: #f2f2f2;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .switch-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ccc;
            margin-right: 4px;
            transition: all 0.15s;
        }
        .switch.active .switch-dot {
            background: #4a5cff;
            transform: translateX(1px);
        }
        .switch-label {
            color: #555;
        }

        .time-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }

        .time-row label {
            font-size: 0.8rem;
            color: #555;
        }

        .time-input {
            width: 70px;
            padding: 6px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 0.85rem;
        }

        .time-feedback {
            font-size: 0.75rem;
            color: #777;
            margin-top: 2px;
        }

        .btn-main {
            width: 100%;
            border-radius: 999px;
            border: none;
            padding: 10px 12px;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(135deg, #ff9aa2, #ffc8d1);
            box-shadow: 0 8px 18px rgba(255, 154, 162, 0.4);
            margin-top: 12px;
        }
        .btn-main:active {
            transform: translateY(1px);
            box-shadow: 0 4px 10px rgba(255, 154, 162, 0.35);
        }

        .section-display {
            position: relative;
            margin-top: 16px;
            border-radius: 20px;
            background: radial-gradient(circle at top, #ffe9f0 0, #fff 35%, #f3f6ff 100%);
            padding: 18px 14px 20px;
            min-height: 150px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: rgba(255,255,255,0.98);
            border-radius: 18px;
            padding: 14px 14px 12px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
            min-width: 0;
            width: 100%;
            max-width: 360px;
        }

        .card-icon {
            font-size: 1.8rem;
            display: inline-block;
            margin-bottom: 6px;
        }

        .card-title {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 6px;
        }
        .card-title span:first-child {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            margin-left: 4px;
        }
        .bg-frog { background: #e8f5e9; color: #2e7d32; }
        .bg-flash { background: #fff8e1; color: #f9a825; }
        .bg-cycle { background: #e3f2fd; color: #1565c0; }

        .card-desc {
            margin-top: 4px;
            font-size: 0.85rem;
            color: #555;
        }

        .card-time {
            margin-top: 6px;
            font-size: 0.8rem;
            color: #777;
        }

        .btn-card-action {
            border-radius: 999px;
            border: none;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            background: #f3f4ff;
            color: #4a5cff;
            margin-right: 6px;
        }
        .btn-card-action:active {
            background: #e0e2ff;
        }

        .section-input {
            margin-top: 16px;
            padding: 14px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        .input-box {
            border-radius: 14px;
            border: 1px solid #eee;
            background: #fafafa;
            padding: 8px;
        }

        #inpTitle {
            width: 100%;
            border: none;
            outline: none;
            resize: vertical;
            min-height: 60px;
            font-size: 0.9rem;
            background: transparent;
        }

        .section-lists {
            margin-top: 18px;
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 12px;
        }

        .panel {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 10px 10px 8px;
            display: flex;
            flex-direction: column;
            max-height: 260px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .panel-title {
            font-weight: 600;
        }

        .panel-subtitle {
            font-size: 0.7rem;
            color: #999;
        }

        .panel-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            padding: 4px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        .item-main {
            display: flex;
            flex-direction: column;
        }
        .item-title {
            font-size: 0.85rem;
        }
        .item-meta {
            font-size: 0.7rem;
            color: #999;
        }

        .item-controls {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .small-btn {
            border-radius: 999px;
            border: none;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .small-btn:active {
            transform: translateY(1px);
        }
        .small-btn.primary {
            background: #4a5cff;
            color: #fff;
        }
        .small-btn.outline {
            background: #fff;
            color: #555;
            border: 1px solid #ddd;
        }

        .section-archive {
            margin-top: 18px;
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
            gap: 12px;
        }

        .archive-panel {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 10px 10px 8px;
        }

        .archive-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .archive-item {
            font-size: 0.8rem;
            padding: 4px 0;
            border-bottom: 1px dashed #f0f0f0;
        }

        .section-stats {
            margin-top: 18px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 10px 10px 10px;
        }

        .stats-row {
            display: flex;
            gap: 8px;
        }

        .stat-btn {
            flex: 1; margin: 0 5px; padding: 8px; border-radius: 12px; cursor: pointer;
            background: #fafafa; border: 1px solid #eee; text-align: center;
            transition: all 0.1s; user-select: none;
        }
        .stat-btn:active { transform: scale(0.96); background: #f0f0f0; }
        .stat-label { font-size: 0.8rem; color: #666; margin-right: 5px; }
        .stat-count { font-weight: bold; font-size: 1rem; color: #333; font-family: monospace; }
        .stat-btn.willpower { color: #5C6BC0; }
        .stat-btn.joy { color: #FFA726; }

        .section-settings {
            margin-top: 18px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 12px 12px 16px;
        }

        .settings-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .settings-group {
            margin-bottom: 10px;
        }

        .settings-group label {
            font-size: 0.8rem;
            color: #555;
        }

        .settings-text {
            width: 100%;
            min-height: 60px;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .settings-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            border-radius: 999px;
            border: 1px solid #ddd;
            padding: 6px 10px;
            font-size: 0.8rem;
            background: #fafafa;
            cursor: pointer;
        }
        .btn-secondary:active {
            background: #f0f0f0;
        }

        .footer {
            margin-top: 18px;
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(40px);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.8rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.25s;
            z-index: 999;
        }

        .toast-show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .custom-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 900;
        }

        .custom-modal {
            background: #fff;
            border-radius: 18px;
            padding: 16px;
            max-width: 320px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .modal-text {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .modal-btns {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            border-radius: 999px;
            border: none;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #4a5cff;
            color: #fff;
        }

        .modal-btn.outline {
            background: #f5f5f5;
            color: #555;
        }

        /* --- ğŸ° æ‰­è›‹æœºè§†è§‰å±‚ --- */
        #gachaLayer {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: radial-gradient(
                circle at top,
                rgba(255,255,255,0.95),
                rgba(255,255,255,0.78)
            );
            z-index: 20;
            opacity: 1;
        }
        .gacha-stage {
            position: relative;
            width: 290px;
            max-width: 88%;
        }
        #gachaImg {
            width: 100%;
            display: block;
            border-radius: 24px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.16);
            transform-origin: 50% 80%;
            transition: opacity 0.6s ease-out;
        }
        @keyframes machineShake {
            0%   { transform: translateY(0) rotate(0deg); }
            20%  { transform: translateY(-4px) rotate(-1deg); }
            40%  { transform: translateY(2px) rotate(1deg); }
            60%  { transform: translateY(-2px) rotate(-0.5deg); }
            80%  { transform: translateY(1px) rotate(0.5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .machine-shake {
            animation: machineShake 0.7s ease-out;
        }
        #eggOut {
            position: absolute;
            left: 77%;
            bottom: 88px;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            opacity: 0;
        }
        @keyframes eggFly {
            0% {
                left: 77%;
                bottom: 72px;
                transform: translateX(-50%) scale(0.7);
                opacity: 0;
            }
            15% {
                left: 77%;
                bottom: 88px;
                transform: translateX(-50%) scale(0.9);
                opacity: 1;
            }
            55% {
                left: 62%;
                bottom: 60%;
                transform: translateX(-50%) scale(1.15);
                opacity: 1;
            }
            85% {
                left: 50%;
                bottom: 44%;
                transform: translateX(-50%) scale(1.3);
                opacity: 1;
            }
            100% {
                left: 50%;
                bottom: 44%;
                transform: translateX(-50%) scale(1.25);
                opacity: 1;
            }
        }
        @keyframes eggBurst {
            0% {
                transform: translateX(-50%) scale(1.25);
                opacity: 1;
            }
            30% {
                transform: translateX(-50%) scale(1.6);
                opacity: 0.9;
            }
            100% {
                transform: translateX(-50%) scale(2.0);
                opacity: 0;
            }
        }
        .gm-caption {
            margin-top: 10px;
            font-size: 0.75rem;
            color: #888;
        }
    </style>
</head>

<body>

<div id="toast" class="toast-notification">âœ… æ“ä½œæˆåŠŸ</div>

<div id="modalOverlay" class="custom-overlay">
    <div class="custom-modal">
        <div id="modalMsg" class="modal-text"></div>
        <div class="modal-btns" id="modalBtnContainer"></div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div><span class="app-title">Anchor âš“ï¸</span><span class="version-badge">v4.6+Fixed</span></div>
        <span class="btn-icon" onclick="scrollToSettings()">âš™ï¸</span>
    </div>

    <div class="section-filter">
        <div class="filter-title">å½“å‰çŠ¶æ€</div>
        <div class="filter-row">
            <select id="selContext" class="select-soft">
                <option value="indoor">ğŸ  åœ¨å®¶/å®¤å†…</option>
                <option value="desktop">ğŸ’» ååœ¨æ¡Œå‰</option>
                <option value="outdoor">ğŸŒ³ æˆ·å¤–/å¯èµ°åŠ¨</option>
            </select>
            <select id="selTime" class="select-soft">
                <option value="15">â± 15 min ä»¥å†…</option>
                <option value="30" selected>â± 30 min å·¦å³</option>
                <option value="60">â± 1 å°æ—¶+</option>
                <option value="120">â± 2 å°æ—¶+</option>
            </select>
        </div>
        <div class="mode-switch">
            <button class="mode-btn active" id="mode-mix" onclick="setMode('mix')">ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)</button>
            <button class="mode-btn" id="mode-culture" onclick="setMode('culture')">ğŸ¬ ç²¾ç¥é£Ÿç²®</button>
            <button class="mode-btn" id="mode-vinyl" onclick="setMode('vinyl')">ğŸ’¿ å¬ä¸€å¼ ç¢Ÿ</button>
            <button class="mode-btn" id="mode-sport" onclick="setMode('sport')">ğŸƒ èµ·æ¥åŠ¨åŠ¨</button>
            <button class="mode-btn" id="mode-sos" onclick="setMode('sos')">ğŸ†˜ æˆ‘æ’‘ä¸ä½äº†</button>
        </div>
    </div>

    <div class="section-main">
        <div class="section-main-title">ä»»åŠ¡æ ‡ç­¾ & æ¨¡å¼</div>
        <div class="control-group" id="controls-normal">
            <div class="tag-row">
                <div class="tag active" data-v="indoor" onclick="pickTag(this)">ğŸ  å®¤å†…</div>
                <div class="tag" data-v="desktop" onclick="pickTag(this)">ğŸ’» ä¹¦æ¡Œ</div>
                <div class="tag" data-v="outdoor" onclick="pickTag(this)">ğŸŒ³ æˆ·å¤–</div>
                <div class="tag" data-v="sport" onclick="pickTag(this)">ğŸƒ è¿åŠ¨</div>
                <div class="tag" data-v="culture" onclick="pickTag(this)">ğŸ“š ä¹¦/å½±</div>
                <div class="tag" data-v="vinyl" onclick="pickTag(this)">ğŸµ å¬ç¢Ÿ</div>
            </div>
            <div class="switch-row">
                <div class="switch" id="switch-frog" onclick="toggleSwitch('frog')">
                    <div class="switch-dot"></div><div class="switch-label">ğŸ¸ é’è›™ä»»åŠ¡ (é«˜é˜»åŠ›)</div>
                </div>
                <div class="switch" id="switch-flash" onclick="toggleSwitch('flash')">
                    <div class="switch-dot"></div><div class="switch-label">âš¡ï¸ é—ªç”µé€ŸåŠ (5min å†…)</div>
                </div>
                <div class="switch" id="switch-cycle" onclick="toggleSwitch('cycle')">
                    <div class="switch-dot"></div><div class="switch-label">ğŸ”„ æ¯æ—¥å¾ªç¯</div>
                </div>
            </div>
            <div class="time-row">
                <label for="inpTime">é¢„è®¡æ—¶é•¿:</label>
                <input id="inpTime" class="time-input" type="number" min="0" max="240" value="30">
                <span style="font-size:0.8rem; color:#888;">min (0 = çµæ´»)</span>
            </div>
            <div id="timeFeedback" class="time-feedback"></div>
        </div>
        <div id="controls-sos" class="control-group" style="display:none; color: #555; font-size:0.9rem;"><span>ğŸƒ å…è®¸è‡ªå·±æš‚æ—¶åœä¸‹æ¥ï¼Œåšä¸€äº›ã€Œä¸ç®—ä»»åŠ¡ã€çš„äº‹ï¼Œåªæ˜¯é‡å¯èº«å¿ƒã€‚</span></div>
        <button class="btn-main" onclick="draw()" id="mainBtn">æŠ½å–ä»»åŠ¡</button>
    </div>

    <div class="section-display" id="displaySec">
        <div id="placeholder" style="color:#aaa; font-weight:bold; opacity:0.5;">...</div>
        <div id="resultCard" class="card">
            <span class="card-icon" id="rIcon">ğŸ</span>
            <div class="card-title"><span id="rTitle"></span><span id="rBadge"></span></div>
            <div class="card-desc" id="rDesc"></div>
            <div class="card-time" id="rTime"></div> 
            <div style="margin-top:15px;">
                <button class="btn-card-action" onclick="draw()">æ¢ä¸€ä¸ª</button>
                <button class="btn-card-action" onclick="finishTask()" id="btnFinish">å»å®Œæˆ</button>
            </div>
        </div>

        <!-- æ‰­è›‹æœºåŠ¨ç”»å±‚ï¼ˆé SOS æ¨¡å¼ä½¿ç”¨ï¼‰ -->
        <div id="gachaLayer">
            <div class="gacha-stage">
                <img id="gachaImg" src="gacha-machine.png" alt="Gacha Machine">
                <img id="eggOut" src="" alt="Capsule">
            </div>
            <div class="gm-caption">å‘½è¿æ‰­ä¸€æ‰­â€¦</div>
        </div>
    </div>

    <div class="section-input">
        <div class="input-box">
            <textarea id="inpTitle" placeholder="æŠŠä½ æƒ³åšçš„ä¸€åˆ‡éƒ½ä¸¢è¿›æ¥ï¼Œæ¯”å¦‚ï¼š&#10;çœ‹ã€Šéœ¸ç‹åˆ«å§¬ã€‹&#10;æ•´ç†ä¹¦æ¡Œ&#10;* è®ºæ–‡å¼€ä¸ªå¤´" onkeydown="handleEnter(event)" oninput="autoDetectTypeAndTime()"></textarea>
        </div>
        <div style="margin-top:8px; text-align:right;">
            <button class="btn-secondary" onclick="addNew()">åŠ å…¥ä»»åŠ¡æ± </button>
        </div>
    </div>

    <div class="section-lists">
        <div class="panel">
            <div class="panel-header">
                <div>
                    <span class="panel-title">ğŸ§º æ—¥å¸¸ & è¿åŠ¨</span>
                    <span class="panel-subtitle">ä»Šæ—¥é«˜é¢‘çš„å°äº‹</span>
                </div>
                <button class="btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearDailyLog()">æ¸…ç©ºè¶³è¿¹</button>
            </div>
            <div id="dailyList" class="panel-list"></div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div>
                    <span class="panel-title">ğŸ åª’ä½“åº“æˆ¿</span>
                    <span class="panel-subtitle">ä¹¦ / ç”µå½± / å”±ç‰‡ ç­‰</span>
                </div>
            </div>
            <div id="mediaList" class="panel-list"></div>
        </div>
    </div>

    <div class="section-archive">
        <div class="archive-panel">
            <div class="panel-header">
                <span class="panel-title">ğŸ‘£ ä»Šæ—¥è¶³è¿¹</span>
                <span class="panel-subtitle">ä»…ä¿ç•™å½“å¤©è®°å½•</span>
            </div>
            <div id="logList" class="archive-list"></div>
        </div>
        <div class="archive-panel">
            <div class="panel-header">
                <span class="panel-title">ğŸ† è£èª‰æ®¿å ‚</span>
                <span class="panel-subtitle">åªè®°å½•ä¹¦ / å½± / å¤§å·¥ç¨‹</span>
            </div>
            <div id="archiveList" class="archive-list"></div>
        </div>
    </div>

    <div class="section-stats">
        <div class="panel-header">
            <span class="panel-title">ğŸ’ å¿µå¤´è®¡æ•°å™¨</span>
            <span class="panel-subtitle">è®°å½•é‚£äº›ä½ çœ‹ä¸è§çš„ã€Œèƒœåˆ©ã€</span>
        </div>
        <div class="stats-row">
            <div class="stat-btn willpower" onclick="incStat('willpower')">
                <div><span class="stat-label">ğŸ›¡ï¸ æ„å¿—åŠ›</span><span class="stat-count" id="statWill">0</span></div>
                <div style="font-size:0.7rem; margin-top:2px;">æˆ˜èƒœåä¹ æƒ¯ / æƒ³åšä½†å¿ä½</div>
            </div>
            <div class="stat-btn joy" onclick="incStat('joy')">
                <div><span class="stat-label">âœ¨ å°ç¡®å¹¸</span><span class="stat-count" id="statJoy">0</span></div>
                <div style="font-size:0.7rem; margin-top:2px;">æ•æ‰åˆ°ä¸€ç‚¹ç‚¹å¼€å¿ƒç¬é—´</div>
            </div>
        </div>
    </div>

    <div class="section-settings" id="settings">
        <div class="settings-title">ğŸ“¦ æ•°æ®å¤‡ä»½ & å¯¼å…¥</div>
        <div class="settings-group">
            <label>å½“å‰æ•°æ®å¯¼å‡ºï¼ˆjson æ–‡æœ¬ï¼‰ï¼š</label>
            <textarea id="exportBox" class="settings-text" readonly></textarea>
        </div>
        <div class="settings-group">
            <label>å¯¼å…¥æ•°æ®ï¼ˆè¯·ç²˜è´´ json å†…å®¹ï¼‰ï¼š</label>
            <textarea id="importBox" class="settings-text" placeholder="åœ¨è¿™é‡Œç²˜è´´ä¹‹å‰å¯¼å‡ºçš„ jsonï¼Œç‚¹å‡»ä¸‹æ–¹ã€Œåˆå¹¶å¯¼å…¥ã€"></textarea>
        </div>
        <div class="settings-actions">
            <button class="btn-secondary" onclick="doExport()">åˆ·æ–°å¯¼å‡ºå†…å®¹</button>
            <button class="btn-secondary" onclick="doImport()">åˆå¹¶å¯¼å…¥</button>
            <button class="btn-secondary" onclick="resetAll()">âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <div class="footer">
        æœ¬å·¥å…·ä»…åœ¨æœ¬æœºæµè§ˆå™¨å­˜å‚¨æ•°æ®ï¼Œä¸ä¸Šä¼ äº‘ç«¯ã€‚è¯·è®°å¾—ã€Œå¯¼å‡ºå¤‡ä»½ã€ã€‚<br>
        Anchor Â· by you ğŸŒŠ
    </div>
</div>

<script>
    const sosLibrary = [
        { title: "å¤§å£å–æ°´", icon: "ğŸ’§", desc: "æ„Ÿå—æ°´æµç»è¿‡é£Ÿé“ã€‚" },
        { title: "çœ‹çª—å¤–è¿œæ–¹", icon: "ğŸ‘€", desc: "å¯»æ‰¾è§†é‡é‡Œæœ€è¿œçš„ä¸€æ£µæ ‘ã€‚" },
        { title: "4-7-8 å‘¼å¸", icon: "ğŸŒ¬ï¸", desc: "å¸æ°”4ç§’ï¼Œæ†‹æ°”7ç§’ï¼Œå‘¼æ°”8ç§’ã€‚" },
        { title: "å‹è…¿æ‹‰ä¼¸", icon: "ğŸ¦µ", desc: "æ‹‰ä¼¸å¤§è…¿åä¾§ã€‚" },
        { title: "äº”æ„Ÿç€é™†", icon: "ğŸ–ï¸", desc: "5æ ·çœ‹åˆ°çš„ï¼Œ4æ ·å¬åˆ°çš„ã€‚" },
        { title: "æ´—æŠŠè„¸", icon: "ğŸš¿", desc: "å†·æ°´æ³¼è„¸ï¼Œç‰©ç†é™æ¸©ã€‚" },
        { title: "åƒä¸€é¢—æ°´æœ", icon: "ğŸŠ", desc: "æ…¢æ…¢åƒï¼Œæ„Ÿå—é¦™æ°”ã€‚" }
    ];

    // --- ğŸ” ç»Ÿä¸€ç¨³å®šå­˜å‚¨é”®å (Live Storage Keys) ---
    const KEY_DB = 'anchor_live_db';
    const KEY_ARCHIVE = 'anchor_live_archive';
    const KEY_LOG = 'anchor_live_log';
    const KEY_STATS = 'anchor_live_stats';

    let db = [];
    let archive = [];
    let dailyLog = [];
    let userStats = { willpower: 0, joy: 0 };

    let mode = 'mix';
    let switchState = { frog:false, flash:false, cycle:false };
    let currentTask = null;
    let isCycleActive = false;

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('toast-show');
        setTimeout(() => t.classList.remove('toast-show'), 1800);
    }

    function openModal(msg, buttons) {
        const overlay = document.getElementById('modalOverlay');
        const msgEl = document.getElementById('modalMsg');
        const btnContainer = document.getElementById('modalBtnContainer');
        msgEl.innerText = msg;
        btnContainer.innerHTML = "";
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.className = "modal-btn " + (b.primary ? "primary" : "outline");
            btn.innerText = b.label;
            btn.onclick = () => { overlay.style.display = 'none'; if (b.onClick) b.onClick(); };
            btnContainer.appendChild(btn);
        });
        overlay.style.display = 'flex';
    }

    function scrollToSettings() {
        const s = document.getElementById('settings');
        if (s) s.scrollIntoView({ behavior: 'smooth' });
    }

    function loadData() {
        try {
            const rawDb = localStorage.getItem(KEY_DB);
            const rawArc = localStorage.getItem(KEY_ARCHIVE);
            const rawLog = localStorage.getItem(KEY_LOG);
            const rawStats = localStorage.getItem(KEY_STATS);
            db = rawDb ? JSON.parse(rawDb) : [];
            archive = rawArc ? JSON.parse(rawArc) : [];
            dailyLog = rawLog ? JSON.parse(rawLog) : [];
            userStats = rawStats ? JSON.parse(rawStats) : { willpower: 0, joy: 0 };
        } catch(e) {
            db = [];
            archive = [];
            dailyLog = [];
            userStats = { willpower: 0, joy: 0 };
        }
        renderList();
        renderArchive();
        renderLog();
        renderStats();
        doExport();
    }

    function saveData() {
        localStorage.setItem(KEY_DB, JSON.stringify(db));
        localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
        localStorage.setItem(KEY_LOG, JSON.stringify(dailyLog));
        localStorage.setItem(KEY_STATS, JSON.stringify(userStats));
    }

    function renderList() {
        const dailyList = document.getElementById('dailyList');
        const mediaList = document.getElementById('mediaList');
        if(!dailyList || !mediaList) return; 
        dailyList.innerHTML = ""; mediaList.innerHTML = "";
        let dCount = 0, mCount = 0;
        const todayStr = new Date().toDateString();
        const sortedDB = [...db].sort((a,b) => b.id - a.id);

        sortedDB.forEach(item => {
            const li = document.createElement('div');
            li.className = "item-row";
            const main = document.createElement('div');
            main.className = "item-main";
            const t = document.createElement('div');
            t.className = "item-title";
            t.innerText = item.title;
            const meta = document.createElement('div');
            meta.className = "item-meta";
            let metaStr = "";
            if (item.isFrog) metaStr += "ğŸ¸ é’è›™ ";
            if (item.isQuick) metaStr += "âš¡ï¸ é€ŸåŠ ";
            if (item.recurrence === 'daily') metaStr += "ğŸ”„ æ¯æ—¥ ";
            metaStr += `â± ${item.time || 30}min Â· ${item.type || 'æ—¥å¸¸'}`;
            if (item.recurrence === 'daily' && item.lastDone === todayStr) metaStr += " Â· âœ… ä»Šæ—¥å·²å®Œæˆ";
            meta.innerText = metaStr;
            main.appendChild(t);
            main.appendChild(meta);

            const ctr = document.createElement('div');
            ctr.className = "item-controls";
            const btnDone = document.createElement('button');
            btnDone.className = "small-btn primary";
            btnDone.innerText = "Done";
            btnDone.onclick = () => finishDirectly(item.id);
            const btnDel = document.createElement('button');
            btnDel.className = "small-btn outline";
            btnDel.innerText = "åˆ ";
            btnDel.onclick = () => removeItem(item.id);
            ctr.appendChild(btnDone);
            ctr.appendChild(btnDel);

            li.appendChild(main);
            li.appendChild(ctr);

            if (item.type === 'culture' || item.type === 'vinyl') {
                mediaList.appendChild(li);
                mCount++;
            } else {
                dailyList.appendChild(li);
                dCount++;
            }
        });

        if (dCount === 0) dailyList.innerHTML = "<div style='font-size:0.8rem; color:#999;'>æš‚æ— æ—¥å¸¸ä»»åŠ¡</div>";
        if (mCount === 0) mediaList.innerHTML = "<div style='font-size:0.8rem; color:#999;'>æš‚æ— ä¹¦/å½±/ç¢Ÿ ç±»ä»»åŠ¡</div>";
    }

    function renderArchive() {
        const list = document.getElementById('archiveList');
        if (!list) return;
        list.innerHTML = "";
        if (archive.length === 0) {
            list.innerHTML = "<div style='font-size:0.8rem; color:#999;'>è¿˜æ²¡æœ‰è£è€€è®°å½•</div>";
            return;
        }
        const sorted = [...archive].sort((a,b) => b.doneAt - a.doneAt);
        sorted.forEach(item => {
            const div = document.createElement('div');
            div.className = "archive-item";
            const d = new Date(item.doneAt);
            const ds = d.toLocaleDateString();
            div.innerText = `[${ds}] ${item.title}`;
            list.appendChild(div);
        });
    }

    function renderLog() {
        const list = document.getElementById('logList');
        if (!list) return;
        const todayStr = new Date().toDateString();
        const todayItems = dailyLog.filter(l => {
            const d = new Date(l.time);
            return d.toDateString() === todayStr;
        });
        list.innerHTML = "";
        if (todayItems.length === 0) {
            list.innerHTML = "<div style='font-size:0.8rem; color:#999;'>ä»Šå¤©è¿˜æ²¡æœ‰ä»»ä½•è¶³è¿¹</div>";
            return;
        }
        const sorted = [...todayItems].sort((a,b) => b.time - a.time);
        sorted.forEach(item => {
            const div = document.createElement('div');
            div.className = "archive-item";
            const d = new Date(item.time);
            const ts = d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
            div.innerText = `[${ts}] ${item.title}`;
            list.appendChild(div);
        });
    }

    function renderStats() {
        const w = document.getElementById('statWill');
        const j = document.getElementById('statJoy');
        if (w) w.innerText = userStats.willpower || 0;
        if (j) j.innerText = userStats.joy || 0;
    }

    function incStat(type) {
        if (!userStats[type] && userStats[type] !== 0) userStats[type] = 0;
        userStats[type]++;
        saveData();
        renderStats();
        if (type === 'willpower') showToast("ğŸ›¡ï¸ è®°ä¸‹è¿™æ¬¡ã€Œå¿ä½ã€");
        if (type === 'joy') showToast("âœ¨ å°å°çš„å¹¸ç¦ä¹Ÿå¾ˆé‡è¦");
    }

    function clearDailyLog() {
        openModal("ç¡®å®šè¦æ¸…ç©ºã€Œä»Šæ—¥è¶³è¿¹ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", [
            { label: "å–æ¶ˆ" },
            { label: "æ¸…ç©º", primary: true, onClick: () => {
                const todayStr = new Date().toDateString();
                dailyLog = dailyLog.filter(l => {
                    const d = new Date(l.time);
                    return d.toDateString() !== todayStr;
                });
                saveData();
                renderLog();
                showToast("å·²æ¸…ç©ºä»Šæ—¥è¶³è¿¹");
            }}
        ]);
    }

    function removeItem(id) {
        db = db.filter(x => x.id !== id);
        saveData();
        renderList();
        showToast("å·²åˆ é™¤ä»»åŠ¡");
    }

    function finishDirectly(id) {
        const item = db.find(x => x.id === id);
        if (!item) return;
        currentTask = item;
        finishTask();
    }

    function doExport() {
        const box = document.getElementById('exportBox');
        if (!box) return;
        const payload = {
            db,
            archive,
            dailyLog,
            userStats
        };
        box.value = JSON.stringify(payload, null, 2);
    }

    function doImport() {
        const box = document.getElementById('importBox');
        if (!box) return;
        let incoming;
        try {
            incoming = JSON.parse(box.value);
        } catch(e) {
            showToast("å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼ä¸æ­£ç¡®");
            return;
        }
        if (!incoming) return;
        const newDB = Array.isArray(incoming.db) ? incoming.db : [];
        const newArc = Array.isArray(incoming.archive) ? incoming.archive : [];
        const newLog = Array.isArray(incoming.dailyLog) ? incoming.dailyLog : [];
        const newStats = incoming.userStats || {};
        const maxId = db.reduce((m, x) => Math.max(m, x.id || 0), 0);
        let nextId = maxId + 1;
        newDB.forEach(item => {
            if (!item.id) { item.id = nextId++; }
            const exists = db.some(x => x.id === item.id || x.title === item.title);
            if (!exists) db.push(item);
        });
        archive = archive.concat(newArc);
        dailyLog = dailyLog.concat(newLog);
        userStats.willpower = (userStats.willpower || 0) + (newStats.willpower || 0);
        userStats.joy = (userStats.joy || 0) + (newStats.joy || 0);
        saveData();
        renderList();
        renderArchive();
        renderLog();
        renderStats();
        doExport();
        showToast("å·²åˆå¹¶å¯¼å…¥æ•°æ®");
    }

    function resetAll() {
        openModal("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼ŸåŒ…æ‹¬ä»»åŠ¡æ± ã€è¶³è¿¹ã€è£èª‰æ®¿å ‚ä¸è®¡æ•°å™¨ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚", [
            { label:"å–æ¶ˆ" },
            { label:"æ¸…ç©º", primary:true, onClick: () => {
                db = [];
                archive = [];
                dailyLog = [];
                userStats = { willpower: 0, joy: 0 };
                saveData();
                renderList();
                renderArchive();
                renderLog();
                renderStats();
                doExport();
                showToast("å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®");
            }}
        ]);
    }

    function getSmartIcon(item) {
        if (!item) return "ğŸ";
        if (item.type === 'vinyl') return "ğŸ’¿";
        if (item.type === 'sport') return "ğŸƒ";
        if (item.type === 'sos') return item.icon || "ğŸš‘";
        if (item.type === 'culture') {
            const t = (item.title || "").toLowerCase();
            if (t.includes('ä¹¦') || t.includes('è¯»') || t.includes('é˜…') || t.includes('æ‚å¿—') || t.includes('å‘¨åˆŠ')) return 'ğŸ“š';
            if (t.includes('å½±') || t.includes('è§†') || t.includes('å‰§') || t.includes('ç‰‡') || t.includes('çœ‹')) return 'ğŸ¬';
            return 'ğŸ–¼ï¸'; 
        }
        return getIcon(item.type);
    }
    
    function getIcon(t) {
        const map = { 'indoor':'ğŸ ', 'desktop':'ğŸ’»', 'outdoor':'ğŸŒ³', 'sport':'ğŸƒ', 'culture':'ğŸ¬', 'vinyl':'ğŸµ', 'sos':'ğŸš‘' };
        return map[t] || 'âœ¨';
    }

    function getDescByType(t) {
        if(t==='vinyl') return "äº«å—è¿™æ®µéŸ³ä¹æ—¶å…‰ã€‚";
        if(t==='culture') return "æ²‰æµ¸åœ¨æ•…äº‹é‡Œã€‚";
        if(t==='sport') return "åŠ¨èµ·æ¥ï¼";
        return "å»è¡ŒåŠ¨å§ï¼";
    }

    // --- ğŸ° æ‰­è›‹æœºï¼šæ ¹æ®ä»»åŠ¡é€‰æ‹©èƒ¶å›Šé¢œè‰² ---
    function getCapsuleSrc(task) {
        if (!task || task.type === 'sos') return null;

        // é’è›™ä»»åŠ¡ä¼˜å…ˆ
        if (task.isFrog) return "gacha-ball-white.png";
        // é—ªç”µé€ŸåŠ
        if (task.isQuick) return "gacha-ball-yellow.png";

        // å”±ç‰‡
        if (task.type === 'vinyl') return "gacha-ball-orange.png";

        // æ–‡åŒ–ç±»ï¼šåŒºåˆ†ç”µå½± / è¯»ä¹¦
        if (task.type === 'culture') {
            const t = (task.title || "");
            if (t.includes("ç”µå½±") || t.includes("çºªå½•ç‰‡") || t.includes("å‰§") || t.includes("å½±") || t.includes("ç‰‡")) {
                return "gacha-ball-blue.png"; // ç”µå½±
            } else {
                return "gacha-ball-pink.png"; // è¯»ä¹¦
            }
        }

        // è¿åŠ¨
        if (task.type === 'sport') return "gacha-ball-green.png";

        // å…¶ä»–æ—¥å¸¸
        return "gacha-ball-purple.png";
    }

    let gachaAnimating = false;

    // æ‰­è›‹æœºåŠ¨ç”»ä¸»æµç¨‹
    function playGachaAnimation(result) {
        const layer  = document.getElementById('gachaLayer');
        const eggOut = document.getElementById('eggOut');
        const img    = document.getElementById('gachaImg');
        const card   = document.getElementById('resultCard');
        const placeholder = document.getElementById('placeholder');
        const btnMain = document.getElementById('mainBtn');

        // å¦‚æœæ‰­è›‹å±‚ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚å›¾ç‰‡è¿˜æ²¡å‡†å¤‡å¥½ï¼‰ï¼Œç›´æ¥å›é€€åˆ°æ™®é€šå¡ç‰‡å±•ç¤º
        if (!layer || !eggOut || !img) {
            renderResultCard(result);
            if (btnMain) { btnMain.disabled = false; btnMain.innerText = "æŠ½å–ä»»åŠ¡"; }
            gachaAnimating = false;
            return;
        }

        gachaAnimating = true;
        if (btnMain) { btnMain.disabled = true; btnMain.innerText = "æŠ½å–ä¸­â€¦"; }
        if (placeholder) placeholder.style.display = "none";
        if (card) card.style.display = "none";

        layer.style.display = "flex";
        layer.style.opacity = "1";
        img.style.opacity   = "1";

        const src = getCapsuleSrc(result) || "gacha-ball-pink.png";
        eggOut.src = src;
        eggOut.style.opacity = 0;
        eggOut.style.transition = "none";

        eggOut.style.animation = "none";
        img.classList.remove("machine-shake");
        void eggOut.offsetWidth; // é‡ç½®åŠ¨ç”»

        // 1ï¼‰æœºå°è½»å¾®æ™ƒåŠ¨
        setTimeout(() => {
            img.classList.add("machine-shake");
        }, 80);

        // 2ï¼‰å½©è›‹ä»å‡ºå£ â†’ ä¸­é—´é£è¡Œ + å˜å¤§
        setTimeout(() => {
            eggOut.style.animation = "eggFly 1.1s ease-out forwards";
        }, 260);

        // 3ï¼‰é£è¡Œä¸­æ®µå¼€å§‹ï¼Œæœºå°æ…¢æ…¢æ·¡å‡º
        setTimeout(() => {
            img.style.opacity = "0";
        }, 700);

        // 4ï¼‰çƒå·²ç»åˆ°äº†ä¸­é—´ä½ç½®ï¼šé”å®š â†’ ç‚¸å¼€ â†’ åŒæ—¶çº¸æ¡å±•å¼€ & æ‰­è›‹å±‚æ·¡å‡º
        setTimeout(() => {
            // é”å®šçƒåœ¨ä¸­é—´
            eggOut.style.animation = "none";
            eggOut.style.left   = "50%";
            eggOut.style.bottom = "44%";
            eggOut.style.transform = "translateX(-50%) scale(1.25)";
            void eggOut.offsetWidth;

            // çƒç‚¸å¼€
            eggOut.style.animation = "eggBurst 0.4s ease-out forwards";

            // å±•ç¤ºç»“æœå¡ç‰‡
            renderResultCard(result);

            // æ‰­è›‹å±‚æ·¡å‡ºï¼ˆé¿å…ç›–åœ¨ä¸Šé¢å‘ç°ï¼‰
            layer.style.transition = "opacity 0.25s ease-out";
            layer.style.opacity = "0";
        }, 1350);

        // 5ï¼‰åŠ¨ç”»æ”¶å°¾ï¼Œæ¢å¤æŒ‰é’® & çŠ¶æ€
        setTimeout(() => {
            layer.style.display = "none";
            layer.style.opacity = "1";
            img.classList.remove("machine-shake");
            img.style.opacity = "1";
            eggOut.style.animation = "none";

            if (btnMain) {
                btnMain.disabled = false;
                btnMain.innerText = "æŠ½å–ä»»åŠ¡";
            }
            gachaAnimating = false;
        }, 2000);
    }

    // æŠ½å–ç»“æœå¡ç‰‡æ¸²æŸ“ï¼ˆä¾›æ™®é€šæ¨¡å¼ & æ‰­è›‹åŠ¨ç”»è°ƒç”¨ï¼‰
    function renderResultCard(result) {
        if (!result) return;

        const card = document.getElementById('resultCard');
        const badgeEl = document.getElementById('rBadge');
        const titleEl = document.getElementById('rTitle');
        const descEl  = document.getElementById('rDesc');
        const iconEl  = document.getElementById('rIcon');
        const timeEl  = document.getElementById('rTime');
        const btnFinish = document.getElementById('btnFinish');
        const placeholder = document.getElementById('placeholder');

        if (placeholder) placeholder.style.display = "none";

        titleEl.innerText = result.title || "";

        let badgesHtml = "";
        if (result.isFrog) badgesHtml += `<span class='card-badge bg-frog'>ğŸ¸ é’è›™</span>`;
        if (result.isQuick) badgesHtml += `<span class='card-badge bg-flash'>âš¡ï¸ é€ŸåŠ</span>`;
        if (result.recurrence === 'daily') badgesHtml += `<span class='card-badge bg-cycle'>ğŸ”„ æ¯æ—¥</span>`;
        if (badgeEl) badgeEl.innerHTML = badgesHtml;

        let displayDesc = result.desc;
        if (!displayDesc || displayDesc === "è‡ªå®šä¹‰") displayDesc = getDescByType(result.type);
        if (descEl) descEl.innerText = displayDesc || "";

        if (iconEl) iconEl.innerText = result.icon || getSmartIcon(result);

        let timeStr = "";
        if (result.type === 'sos') timeStr = "âš¡ï¸ å³æ—¶";
        else if (result.time === 0) timeStr = "â³ ä¸°ä¿­ç”±äºº";
        else timeStr = `â±ï¸ ${result.time || 30} min`;
        if (timeEl) timeEl.innerText = timeStr;

        if (btnFinish) {
            btnFinish.disabled = (result.type === 'sos');
            btnFinish.innerText = (result.type === 'sos') ? "æˆ‘åšå®Œäº†" : "å»å®Œæˆ";
        }

        if (card) card.style.display = 'block';
    }

    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNew(); } }

    function setMode(m) {
        mode = m;
        const display = document.getElementById('displaySec');
        const normCtl = document.getElementById('controls-normal');
        const sosCtl = document.getElementById('controls-sos');
        const btnMix = document.getElementById('mode-mix');
        const btnCult = document.getElementById('mode-culture');
        const btnVinyl = document.getElementById('mode-vinyl');
        const btnSport = document.getElementById('mode-sport');
        const btnSos = document.getElementById('mode-sos');
        [btnMix,btnCult,btnVinyl,btnSport,btnSos].forEach(b => { if (!b) return; b.classList.remove('active'); });
        if (m === 'mix') btnMix.classList.add('active');
        if (m === 'culture') btnCult.classList.add('active');
        if (m === 'vinyl') btnVinyl.classList.add('active');
        if (m === 'sport') btnSport.classList.add('active');
        if (m === 'sos') btnSos.classList.add('active');

        if (m === 'sos') {
            normCtl.style.display = 'none';
            sosCtl.style.display = 'flex';
        } else {
            normCtl.style.display = 'flex';
            sosCtl.style.display = 'none';
        }
        const btn = document.getElementById('mainBtn');
        if (mode === 'sos') btn.innerText = "ğŸš‘ æ•‘æ•‘æˆ‘";
        else if (mode === 'vinyl') btn.innerText = "ğŸ’¿ æ¥ä¸€å¼ ";
        else if (mode === 'culture') btn.innerText = "ğŸ¬ ç²¾ç¥é£Ÿç²®";
        else btn.innerText = "ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)";
    }
    
    function draw() {
        if (typeof gachaAnimating !== 'undefined' && gachaAnimating && mode !== 'sos') return;
        const card = document.getElementById('resultCard'); card.style.display = 'none';
        setTimeout(() => {
            let result = null;
            if (mode === 'sos') { const r = Math.floor(Math.random() * sosLibrary.length); result = { ...sosLibrary[r], type: 'sos', time: 0 }; }
            else {
                const ctx = document.getElementById('selContext').value; const limitTime = parseInt(document.getElementById('selTime').value); const todayStr = new Date().toDateString();
                let validPool = db.filter(item => {
                    if (item.recurrence === 'daily' && item.lastDone === todayStr) return false;
                    const tTime = (item.time === undefined || item.time === null) ? 30 : item.time;
                    const isFlexible = (tTime === 0);
                    if (!isFlexible && !item.isQuick && tTime > limitTime) return false;
                    if (mode === 'vinyl') return item.type === 'vinyl'; if (mode === 'culture') return item.type === 'culture';
                    if (item.type === 'culture' || item.type === 'vinyl') { if (ctx === 'outdoor') return false; } 
                    else if (item.type === 'sport') { return true; } 
                    else { if (ctx === 'desktop') return item.type === 'desktop' || item.type === 'indoor'; if (ctx === 'outdoor') return item.type === 'outdoor'; }
                    return true;
                });
                if (validPool.length > 0) {
                    // ç®€å•éšæœº
                    result = validPool[Math.floor(Math.random() * validPool.length)];
                }
            }
            currentTask = result;
            if (result) {
                if (result.type === 'sos') {
                    // SOS æ¨¡å¼ï¼šç›´æ¥å±•ç¤ºå¡ç‰‡ï¼Œä¸ç»è¿‡æ‰­è›‹æœº
                    renderResultCard(result);
                } else {
                    // å…¶ä»–æ¨¡å¼ï¼šèµ°æ‰­è›‹æœºåŠ¨ç”»
                    playGachaAnimation(result);
                }
            } else {
                // æ²¡æœ‰å¯æŠ½çš„ä»»åŠ¡æ—¶çš„å ä½å¡ç‰‡
                currentTask = null;
                const placeholder = document.getElementById('placeholder');
                if (placeholder) placeholder.style.display = "none";
                document.getElementById('rTitle').innerText = "æš‚æ— ä»»åŠ¡";
                document.getElementById('rBadge').innerHTML = "";
                document.getElementById('rDesc').innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ";
                document.getElementById('rIcon').innerText = "ğŸŒ™";
                document.getElementById('rTime').innerText = "";
                card.style.display = 'block';
            }
        }, 300);
    }

    function finishTask() {
        if (!currentTask) return;
        if (currentTask.type === 'sos') { showToast("çŠ¶æ€é‡å¯ï¼ğŸŒ±"); document.getElementById('resultCard').style.display = 'none'; return; }
        // Log logic
        const now = new Date();
        const timeStr = now.getTime();
        dailyLog.push({ title: currentTask.title, time: timeStr });
        if (currentTask.recurrence === 'daily') {
            currentTask.lastDone = now.toDateString();
            db = db.map(item => item.id === currentTask.id ? currentTask : item);
        } else {
            db = db.filter(item => item.id !== currentTask.id);
        }
        if (currentTask.type === 'culture' || currentTask.type === 'vinyl' || currentTask.isFrog) {
            archive.push({ title: currentTask.title, doneAt: now.getTime() });
        }
        saveData();
        renderList();
        renderArchive();
        renderLog();
        showToast("å·²è®°å½•å®Œæˆ âœ…");
        document.getElementById('resultCard').style.display = 'none';
        currentTask = null;
    }

    function parseTimeFromInput(text) {
        const match = text.match(/(\\d+)(åˆ†é’Ÿ|min|min|åˆ†é’Ÿå†…)?/);
        if (!match) return { time:null, clean:text };
        const t = parseInt(match[1]);
        const clean = text.replace(match[0], '').trim();
        return { time:t, clean };
    }

    function autoDetectTypeAndTime() {
        const raw = document.getElementById('inpTitle').value;
        const lines = raw.split('\n'); let targetLine = lines[0] || ""; 
        const parsed = parseTimeFromInput(targetLine);
        const feedback = document.getElementById('timeFeedback');
        if (parsed.time) feedback.innerText = `ğŸ’¡ è¯†åˆ«: ${parsed.time} min`; else feedback.innerText = "";
        if (targetLine.includes("æ¯å¤©") || targetLine.includes("æ¯æ—¥")) { if(!isCycleActive) toggleCycle(); }
        const v = targetLine; const tags = document.querySelectorAll('.tag');
        let t = null; let detectQuick = false;
        if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) { t = 'indoor'; detectQuick = true; } 
        else if(v.includes('å”±') || v.includes('å¬')) t = 'vinyl';
        else if(v.includes('è·‘') || v.includes('èµ°') || v.includes('ç‘œä¼½') || v.includes('æ‹‰ä¼¸') || v.includes('æ•£æ­¥')) t = 'sport';
        else if(v.includes('ä¹¦') || v.includes('è¯»') || v.includes('å½±') || v.includes('è§†') || v.includes('å‰§') || v.includes('ç‰‡')) t = 'culture';
        else if(v.includes('æ¡Œ') || v.includes('ç”µè„‘') || v.includes('å†™ä½œ') || v.includes('å†™') || v.includes('å‰ªè¾‘') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) t = 'desktop';
        if (t) { tags.forEach(tag => tag.classList.remove('active')); const activeTag = document.querySelector(`.tag[data-v="${t}"]`); if(activeTag) activeTag.classList.add('active'); toggleTimeInput(t); }
        if (detectQuick && !switchState.flash) { toggleSwitch('flash', true); document.getElementById('inpTime').value = "5"; }
    }

    function pickTag(el) { document.querySelectorAll('.tag').forEach(t=>t.classList.remove('active')); el.classList.add('active'); toggleTimeInput(el.dataset.v); }

    function toggleTimeInput(type) { const sel = document.getElementById('inpTime'); if (type === 'vinyl' || type === 'culture') sel.value = 60; else sel.value = 30; }

    function toggleSwitch(name, forceState) {
        const sw = document.getElementById('switch-' + name);
        if (!sw) return;
        const dot = sw.querySelector('.switch-dot');
        const label = sw.querySelector('.switch-label');
        const active = (forceState !== undefined) ? forceState : !switchState[name];
        switchState[name] = active;
        if (active) {
            sw.classList.add('active');
            label.style.color = '#333';
        } else {
            sw.classList.remove('active');
            label.style.color = '#555';
        }
        if (name === 'cycle') isCycleActive = active;
    }

    function addNew() {
        const raw = document.getElementById('inpTitle').value.trim();
        if (!raw) return;
        const lines = raw.split('\n').filter(l => l.trim().length > 0);
        let baseType = document.querySelector('.tag.active')?.dataset.v || 'indoor';
        const timeInput = parseInt(document.getElementById('inpTime').value) || 30;
        const baseTime = timeInput;
        const isFrog = switchState.frog;
        const isQuick = switchState.flash;
        const recurrence = switchState.cycle ? 'daily' : null;
        let idBase = db.reduce((m,x)=>Math.max(m,x.id||0),0)+1;
        let firstLine = lines[0];
        if (firstLine.match(/^(çœ‹|è¯»|é˜…è¯»|å‰§|å½±|ç‰‡)/)) baseType = 'culture';
        let itemsToAdd = [];
        lines.forEach((ln, idx) => {
            let line = ln.trim();
            if (!line) return;
            const parsed = parseTimeFromInput(line);
            let t = parsed.time || baseTime;
            const cleanTitle = parsed.clean || line;
            let finalType = baseType;
            const v = cleanTitle;
            if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) finalType = 'indoor';
            else if(v.includes('å”±') || v.includes('å¬')) finalType = 'vinyl';
            else if(v.includes('è·‘') || v.includes('èµ°') || v.includes('ç‘œä¼½') || v.includes('æ‹‰ä¼¸') || v.includes('æ•£æ­¥')) finalType = 'sport';
            else if(v.includes('ä¹¦') || v.includes('è¯»') || v.includes('å½±') || v.includes('è§†') || v.includes('å‰§') || v.includes('ç‰‡')) finalType = 'culture';
            else if(v.includes('æ¡Œ') || v.includes('ç”µè„‘') || v.includes('å†™ä½œ') || v.includes('å†™') || v.includes('å‰ªè¾‘') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) finalType = 'desktop';
            if (finalType === 'culture') {
                let title = cleanTitle;
                if (!title.startsWith('ã€Š')) title = 'ã€Š' + title;
                if (!title.endsWith('ã€‹')) title = title + 'ã€‹';
                itemsToAdd.push({
                    id: idBase++,
                    title,
                    type: finalType,
                    time: t,
                    isFrog,
                    isQuick,
                    recurrence
                });
            } else {
                itemsToAdd.push({
                    id: idBase++,
                    title: cleanTitle,
                    type: finalType,
                    time: t,
                    isFrog,
                    isQuick,
                    recurrence
                });
            }
        });
        db = db.concat(itemsToAdd);
        saveData();
        renderList();
        document.getElementById('inpTitle').value = "";
        document.getElementById('timeFeedback').innerText = "";
        showToast(`å·²åŠ å…¥ ${itemsToAdd.length} æ¡ä»»åŠ¡`);
    }

    window.onload = loadData;
</script>
</body>
</html>
